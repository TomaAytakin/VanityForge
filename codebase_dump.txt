GENERATING CODE DUMP...


======================================================================
FILE: .env.config
======================================================================
GOOGLE_APPLICATION_CREDENTIALS=
TREASURY_PUBKEY=CUfjsGUee8u83dfFxHt1jXJUCRLiF1KoWVYcKyVforGe
REDPANDA_JOB_NAME=vanity-gpu-redpanda
CPU_JOB_NAME=vanity-gpu-worker
SMTP_EMAIL=support@vanityforge.org
SMTP_PASSWORD=dummy
SOLANA_RPC_URL=https://api.mainnet-beta.solana.com
FIREBASE_CONFIG={}


======================================================================
FILE: .gitignore
======================================================================
__pycache__/
*.pyc
server.log
gpu-worker/target/
verification_env/
node_modules/
.env
service-account.json
firebase_credentials


======================================================================
FILE: Dockerfile
======================================================================
FROM rust:latest as builder
WORKDIR /app
COPY cpu-grinder/ .
RUN apt-get update && apt-get install -y pkg-config libssl-dev
RUN cargo build --release

FROM python:3.9-slim
WORKDIR /app
RUN pip install --no-cache-dir firebase_admin google-cloud-firestore cryptography base58
COPY --from=builder /app/target/release/cpu-grinder ./cpu-grinder-bin
COPY worker_cpu.py .

# Create non-root user
RUN useradd -m appuser && chown -R appuser:appuser /app
USER appuser

CMD ["python", "worker_cpu.py"]


======================================================================
FILE: Dockerfile.gpu
======================================================================
FROM nvidia/cuda:11.8.0-devel-ubuntu22.04
RUN apt-get update && apt-get install -y python3 python3-pip git build-essential
WORKDIR /app
COPY requirements.txt .
RUN pip3 install --no-cache-dir -r requirements.txt google-cloud-firestore firebase-admin
COPY solanity-gpu/ .
# Compile the GPU miner
RUN make

# Generate precomputed tables during build
RUN ./solanity --generate-tables

# Create non-root user
RUN useradd -m appuser && chown -R appuser:appuser /app
USER appuser

# Run the worker
CMD ["python3", "worker.py"]


======================================================================
FILE: requirements.txt
======================================================================
Flask
flask-cors
google-cloud-firestore
google-cloud-run
solders
base58
cryptography
bcrypt
python-dotenv
requests
Flask-Limiter
firebase-admin


======================================================================
FILE: ROADMAP.md
======================================================================
# VanityForge Project Roadmap

## Current Status: PRODUCTION BETA (v1.1.0)

This roadmap tracks the development progress of the VanityForge platform, from the initial MVP launch to our future goals for high-performance GPU acceleration.

---

### ‚úÖ COMPLETED (Q4 2025)

**Launch & Core Infrastructure**
*   **MVP Launch (Core Grinding Logic):** Successfully deployed the core Python-based vanity address generator.
*   **Deploy Backend to Google Cloud VM:** Established the orchestration server on Google Compute Engine.
*   **Integrate Google Cloud Run for Worker Autoscaling:** Successfully implemented serverless dispatch for heavy jobs.
*   **Develop CUDA GPU Miner (`solanity-gpu`):** Launched high-performance NVIDIA L4/T4 support for paid tiers.
*   **Email Notification System:** Integrated rich HTML email notifications featuring "Sola" branding.

**Monetization & Security**
*   **Launch Referral System:** Implemented a robust 30% revenue share model for referrers.
*   **Implement Payment Verification:** Secure Solana Pay/RPC integration for automated premium job processing.
*   **Security Hardening:** Rate limiting, anti-leak measures, and rigorous process management.

---

### üöß IN PROGRESS / Q1 2026

**Performance & Engine**
*   **Phase 3: 100% L4 GPU Transition:** [Current/Live] Migrating all workload to the CPU Worker Cluster.
*   **CPU/GPU Hybrid Tiering:** [Completed/Deprecated] Hybrid model replaced by single-lane GPU architecture.
*   **Public API for Developers:** Creating a standardized API for third-party integrations.

**User Experience (UX)**
*   **Mobile UI Optimization:** Enhancing the mobile experience for on-the-go forging.
*   **Immersive UI:** Integrating a 3D avatar of "Jules" to guide users through the process.

---

### üîÆ FUTURE CONCEPTS (Phase 3)

*   **$VFORGE Token Utility:** Staking mechanisms for free premium generations.
*   **API Access:** Developer API keys for integrating VanityForge into other dApps.
*   **DAO Governance:** Community voting on fee structures and feature prioritization.


======================================================================
FILE: gitbook_content.md
======================================================================
# User Manual: Getting Started

## Connecting Your Wallet & Authentication
VanityForge uses a hybrid authentication model combining Web3 anonymity with Web2 convenience.

1.  **Connect Phantom Wallet:**
    *   Navigate to the homepage and locate the **"Connect Phantom"** button (Button ID: `#connect-phantom-btn`) in the center of the screen.
    *   Clicking this triggers a connection request to your browser's Phantom extension.
    *   Approve the request to allow VanityForge to read your public key. This is required for identifying your account and processing Solana payments.
    *   *Note:* If you do not have Phantom installed, the button will open `https://phantom.app/` in a new tab.

2.  **Login with Google (Optional but Recommended):**
    *   To enable email notifications and account recovery features, click **"Login with Google"**.
    *   This opens a secure Firebase pop-up window (`firebase.auth().signInWithPopup`).
    *   Once authenticated, your Google User ID is linked to your session.

## Creating Your Non-Recoverable Encryption PIN
Upon your first successful login, the system checks the `users` database. If no PIN hash is found, you are immediately presented with the **Vault PIN Creation Modal**.

*   **The Warning:** You will see a strict warning box:
    > "You are about to create a permanent encryption PIN. VanityForge does not store this PIN. If you lose it, you will permanently lose the capability to reveal your private keys or forge new wallets within your VanityForge account. We cannot recover it for you."
*   **The Acknowledgment:** You **must** manually check the confirmation box:
    > "I acknowledge that VanityForge cannot recover my PIN if lost, and that losing my PIN means I will be unable to reveal my private keys or access my VanityForge account functions."
*   **Setting the PIN:** Enter a 4-6 digit numeric PIN using the on-screen secure numpad. This PIN is hashed via `bcrypt` before reaching our database; the raw PIN is never stored.

---

# User Manual: Submitting a Forge Job

## Understanding Difficulty & Time
The time required to find a vanity address increases exponentially with every character you add. We use the formula $58^L$ (where $L$ is length) to estimate difficulty based on the Base58 character set.

*   **1-4 Characters:** Usually "Instant" (< 1 second). Free for trial users.
*   **5 Characters:** ~1-2 minutes.
*   **6 Characters:** ~1-2 hours.
*   **7 Characters:** ~2-3 days (Requires Cloud Grinding).
*   **8 Characters:** Weeks/Months (Extreme difficulty).

*Note:* If your estimated time exceeds 1 hour, the UI will display a browser confirmation dialog asking if you accept the wait time before proceeding.

## Job Status Lifecycle
Once submitted, your job moves through the following statuses in the `vanity_jobs` collection:

1.  **QUEUED:** The job has been accepted by the API and is waiting in the `vanity_jobs` database. The `scheduler_loop` checks this queue every 5 seconds.
2.  **RUNNING:**
    *   **RedPanda Engine:** Dispatched to the **CPU Worker Cluster** (Cloud Run). The system updates the status to RUNNING only after successfully dispatching the container.
3.  **COMPLETED:** The vanity address was found! The private key has been encrypted with your PIN-derived key and saved. An email notification (if enabled) is sent.
4.  **FAILED:** The job encountered an error (e.g., Cloud Dispatch failure, process crash). The specific error message is saved in the `error` field.

---

# Glossary & FAQ

## Terminology
*   **Solana Base58:** The specific character set used for Solana addresses. It includes alphanumeric characters but **excludes** `0` (Zero), `O` (Capital o), `I` (Capital i), and `l` (Lower L) to avoid visual confusion.
*   **Vanity Address:** A cryptocurrency wallet address that starts (Prefix) or ends (Suffix) with a specific sequence of characters chosen by the user (e.g., `VaNiTy...`).
*   **Encryption PIN:** A user-defined numeric code used to generate the AES-128 (Fernet) key that encrypts your private wallet keys.
*   **Service Account:** A special Google Cloud account used by the backend to authenticate against Firestore and Cloud Run without human intervention.
*   **Gas/SOL Fees:** The transaction cost required by the Solana network to process payments to the VanityForge Treasury.

## Frequently Asked Questions

**Q: If I lose my PIN, is my wallet lost?**
**A:** **Yes and No.**
*   **The Keys:** You will **permanently lose access** to reveal the private key stored on VanityForge. Since we do not store your raw PIN, we cannot decrypt the key for you.
*   **The Wallet:** If you have already revealed the key and saved it elsewhere (e.g., in Phantom), your wallet is safe. The PIN only protects the *backup* stored on our server.

**Q: Why do I receive emails from "Support" when the admin logs in?**
**A:** This is a security feature. The system uses a centralized SMTP configuration. Even though the backend authenticates with the `SMTP_EMAIL` (e.g., `admin@`), the `send_email_wrapper` function explicitly sets the email header to:
`From: VanityForge Support <support@vanityforge.org>`
This ensures professional branding and prevents personal admin email addresses from being exposed to users.

---

# System Architecture Deep Dive (Extravagant Details)

## Server Environment & Stability
The core orchestrator (`vm_server.py`) runs on a high-performance Google Compute Engine VM. Stability is enforced via `systemd` and `Gunicorn`.

*   **Process Management:** The application runs as a `systemd` service, ensuring it automatically restarts on boot or failure.
*   **Resource Limits (`LimitNOFILE`):**
    To handle high-concurrency Firestore connections and subprocess management, the systemd unit file is configured with `LimitNOFILE=65535`. This prevents "Too many open files" errors which can occur when the `scheduler_loop` spawns multiple `multiprocessing.Process` workers or maintains open socket connections to Google Cloud APIs.
*   **Zombie Reaper:** The application explicitly handles zombie processes using `signal.signal(signal.SIGCHLD, signal.SIG_IGN)` in the main entry point, preventing defunct processes from consuming the process table.

## Database Structure (Firestore)
The database is strictly partitioned into two primary collections to separate user credentials from job data.

### 1. `users` Collection
Stores authentication and security state.
*   `user_id` (String): The unique Google UID or Phantom Public Key.
*   `pin_hash` (String): The `bcrypt` hash of the user's PIN.
*   `updated_at` (Timestamp): Last modification time.
*   *Note regarding God Mode:* Unlike standard users, "God Mode" status is **not** stored as a boolean in the database. Instead, it is dynamically determined at runtime by checking if the user's email exists in the hardcoded `ADMIN_EMAILS` set in `vm_server.py`.

### 2. `vanity_jobs` Collection
Stores the state of every forging attempt.
*   `job_id` (UUID String): Unique identifier for the job.
*   `user_id` (String): Link to the owner.
*   `status` (String): `QUEUED`, `RUNNING`, `COMPLETED`, `FAILED`.
*   `prefix` / `suffix` (String): The target patterns.
*   `temp_pin` (String): **Transient Field.** Briefly stores the raw PIN during the `QUEUED` phase to allow the worker to initialize encryption. This field is explicitly deleted (`firestore.DELETE_FIELD`) immediately upon job dispatch.
*   `secret_key` (String): The encrypted private key (only present after `COMPLETED`).
*   `public_key` (String): The resulting wallet address.
*   `active_job_id`: **Virtual Association.** The system does not store an `active_job_id` field in the user document. Instead, active status is determined by querying this collection for any documents where `user_id == current_user` AND `status` is `QUEUED` or `RUNNING`.


======================================================================
FILE: readme.md
======================================================================
# VanityForge: The Apex of Crypto Identity

![VanityForge Main Banner](https://github.com/TomaAytakin/VanityForge/blob/main/assets/readmeherobanner.png)

![Solana Mainnet](https://img.shields.io/badge/Network-Solana_Mainnet-green?style=flat-square&logo=solana)
![Bonfida SNS](https://img.shields.io/badge/Integration-Bonfida_SNS-blue?style=flat-square)
![Security](https://img.shields.io/badge/Security-Glass_Box_Engine-shield?style=flat-square)

Welcome to **VanityForge**. You have arrived at the *absolute pinnacle* of Solana address generation. We provide what others cannot: **Unmatched Speed**, <u>Military-Grade Security</u>, and **24/7 Reliability**.

Stop settling for random addresses. Demand a customized identity that commands *respect* on the blockchain.

## üìú Changelog

### December 2025: The Titanium Upgrade
As of December 2025, VanityForge has deprecated all CPU mining operations. We have upgraded the entire platform to be **100% GPU-Accelerated**.
- **Unified Speed:** Every user now utilizes our **Enterprise CPU Worker Cluster** (NVIDIA L4).
- **One Lane:** No more "Standard" vs "Turbo". Everyone gets Turbo.
- **Performance:** Speeds have increased from ~5 MH/s (CPU) to **300 MH/s** (GPU).

---

## üõ°Ô∏è Open Source: Our Confidence is Our Firewall

VanityForge operates on a principle of <u>full transparency</u>. Our core logic is visible for inspection because we believe trust is the highest form of security.

### Auditability
Every user‚Äîfrom the layperson to the advanced developer‚Äîcan inspect our code to verify that the encryption logic is correct and that we are not stealing private keys. You don't have to trust us; you can verify us.

### Competitive Advantage
We are not afraid of competition. Our competitive edge lies not in secret code, but in our proprietary, cost-optimized Compute Engine Infrastructure, our fast payment pipeline, and our advanced resource management system. We win on execution and speed, not secrecy.

---

## üîí The "Fort Knox" Security Model

![Bank Vault Security](https://github.com/TomaAytakin/VanityForge/blob/main/assets/fortknoxreadme.png)

### üèÜ Certified Security: Rated 'A'

![Qualys SSL Labs A Rating](assets/sslqual.png)

We don't just encrypt your data; we secure the transport layer itself. VanityForge has achieved an 'A' Rating from Qualys SSL Labs‚Äîthe industry gold standard. This score confirms our use of modern Elliptic Curve Cryptography (ECC), strict TLS 1.3 enforcement via Caddy, and perfect forward secrecy. Your connection is as secure as a banking portal.

### For the Non-Technical User
Think of VanityForge like a Swiss Bank Account:
1.  **The Vault:** We provide the unbreakable storage facility.
2.  **The Key:** You set a unique **Encryption PIN** that *only you know*.
3.  **The Guarantee:** Even if we wanted to, we physically cannot open your vault. Without your specific PIN, your private key looks like random noise to us. **If you lose your PIN, the key is gone forever.** That is how secure it is.

Imagine you are staying at a futuristic hotel. You want to store a precious diamond (your Private Key) in the room safe.

The Creation: Our automated robot places the diamond inside the safe for you. The door is wide open.

The Lock: You type in a 4-digit PIN that only you know.

The Magic: The moment you hit "Enter," the safe locks, and the robot suffers "amnesia"‚Äîit instantly forgets the PIN you just typed.

The Storage: We (the hotel staff) guard the room. We can see the safe on the wall. We can verify it is locked. But we cannot open it because we don't know the code, and we have no master key.

The Access: When you return and type the PIN, the safe opens.

The Risk: If you forget your PIN, no one‚Äînot even the hotel manager‚Äîcan open that safe. The diamond is locked inside forever.

### For the Technical User
Our security stack is built on **Client-Derived Server-Side Encryption** (`vm_server.py`) and rigorous hardening:
* **Zero-Knowledge Architecture:** We use Fernet (AES-128) encryption with keys derived from User PINs (PBKDF2). We physically cannot decrypt your data without your input.
* **Anti-Abuse:** Rate Limiting is implemented via `Flask-Limiter` (60 req/min) to prevent brute-force attacks.
* **Sanitization:** Strict environment variable handling and database connection cleanup ensure no data leaks.
* **Ephemeral RAM Processing:** Your raw private key exists in Volatile Memory (RAM) for exactly **0.05 seconds** before being wiped.
* **Bcrypt PIN Hashing:** Your PIN is hashed using `bcrypt` before being stored.
* **Ciphertext Storage:** The database receives **<u>ONLY</u>** the encrypted ciphertext.

#### üõ°Ô∏è Transaction Safety Engine (New)
Beyond encryption, we secure the *transaction* itself using a "Glass Box" philosophy:
* **Manual Composition:** We do not rely on opaque SDK methods. Every transaction is manually composed and sanitized to prevent hidden malicious code.
* **Instruction Sanitization:** All SNS instructions are flattened and inspected for strict program ID compliance before signing.
* **Direct-to-RPC Injection:** We utilize **Helius Premium RPCs** injected securely from the backend to ensure zero-latency execution without exposing API keys.

---

## ‚òÅÔ∏è "Fire and Forget" Cloud Persistence

![Cloud Persistence](https://github.com/TomaAytakin/VanityForge/blob/main/assets/fireforgetreadme.png)

Why burn out your own CPU or battery? VanityForge leverages the raw power of **Dedicated Cloud Infrastructure**.

### The Always-On Engine
Unlike browser-based generators that stop when your screen turns off, our engine runs on a **Google Compute Engine VM** hosted in a Tier-1 Data Center (`europe-west1`).
* **Process Daemonization:** Our workers run as background daemons (`nohup`).
* **Lifecycle Management:** You can start a job, close your browser, turn off your computer, and fly to another country. When you log back in, your job will still be grinding.
* **Resilience:** We handle network interruptions and session disconnects gracefully. Your job state is persistent.
* **Notifications:** **"Sola"** (our Red Panda system) sends rich HTML emails to notify you when your job starts and when it completes, so you never miss a beat.

---

## üèóÔ∏è System Architecture: Hybrid Cloud

![MULTICORE](https://github.com/TomaAytakin/VanityForge/blob/main/assets/multiprocreadme.png)

We utilize a **Hybrid Cloud Architecture** that separates orchestration from computation, ensuring maximum scalability and reliability.

*   **Frontend:** Pure Static HTML/JS served by a lightweight Flask VM. It interacts with the backend via REST API and listens to Firestore for real-time job updates.
*   **Backend:** A Python Flask Orchestrator (`vm_server.py`) acting as the command center. It handles payments, job dispatch, and lifecycle management.
*   **Workers (Serverless):** The backend dispatches heavy computational tasks to **Google Cloud Run**, scaling to zero when not in use.

### Compute Engine
*   **CPU Worker Cluster:** Powered by **NVIDIA L4 GPUs** hosted in `us-central1`. These runners execute our custom **CUDA-optimized `solanity-gpu`** kernel, delivering blazing fast speeds (~300 MH/s) for all users.
*   **Legacy CPU:** Deprecated and removed in v2.0.

## ‚ú® Key Features

*   **Vanity Address Generation:** Create custom addresses with personalized prefixes and suffixes (e.g., `MyName...`).
*   **Phantom Compatibility:** We generate keys in the standard **64-byte Base58 Keypair format**, ensuring instant import into Phantom, Solflare, and Backpack wallets.
*   **Referral System:** Share your unique code and **earn 30%** of all fees generated by your referrals. Payouts are automated.
*   **SNS Integration:** Automatically checks **Solana Name Service** availability for your generated handle.

**VanityForge** isn't just a tool; it's a **powerhouse**.

## üí∏ Seamless Web3 Integration & Economics

We have bridged the gap between Web2 ease-of-use and Web3 native value.

* **Hybrid Authentication:** Login securely with **Google OAuth** (for ease) or connect directly via **Phantom Wallet** (for anonymity).
* **Solana Native Payments:** Our pricing engine is built on Solana. The frontend integrates `web3.js` to trigger seamless, trustless transfers directly from your Phantom wallet to our Treasury.
* **Dynamic Tiered Pricing:**
    * **Trial Tier:** 2 Free generations for every user (Max 4 chars).
    * **Beta Discount:** Currently offering a **50% Discount** on all premium tiers.
    * **Fairness Algorithm:** Pricing scales exponentially with difficulty ($10^{(L-4)}$), ensuring the cost accurately reflects the computational resources required.
---

## üó∫Ô∏è Project Roadmap

### Phase 1: Foundation (COMPLETED ‚úÖ)
*   **Establish 4-Core Cloud VM Infrastructure.**
*   **Implement Multi-Core CPU Grinding Algorithm.**
*   **Launch Web3 Login (Phantom Wallet & Google OAuth).**
*   **Deploy Banking-Grade Security (Client-Side Encryption & Zero-Knowledge Storage).**

### Phase 2: Monetization & Polish (IN PROGRESS üöß)
*   **Implement Solana Payment Gateway (Pay-Per-Forge).**
*   **Launch $VFORGE Token via pump.fun (The official utility token).**
*   **Deploy Email Notification System for long-running jobs.**
*   **Expand capacity to 8-Core 'Fast Track' nodes.**

### Phase 3: The Singularity (FUTURE üîÆ)
*   **RedPanda Engine: Migrate to NVIDIA CUDA cores for 100x speed.**
*   **Instant Forge: Sub-minute delivery for 7-character vanity addresses.**
*   **Dao Governance: $VFORGE holders vote on fee structures and new features.**

## üõ†Ô∏è The Stack
* **Infrastructure:** Google Compute Engine, Cloud Run, Helius RPC.
* **Backend:** Python 3.11, Flask, Gunicorn, `Flask-Limiter`, `requests`.
* **Frontend:** HTML5, Tailwind CSS, Bonfida SNS SDK, Solana Web3.js v1.x.
* **Security:** `cryptography` (Fernet), `bcrypt`, `flask-cors`.

_____________________________________________________________________________________
*Secure your legacy on Solana today with VanityForge.*


======================================================================
FILE: whitepaper_summary.md
======================================================================
**VanityForge solves the computational inefficiency of generating custom Solana vanity addresses, a process that typically demands prohibitive time and hardware resources for high-difficulty prefixes.** The platform overcomes this by deploying a "Hybrid Grinder" architecture that intelligently dispatches jobs to a scalable, cloud-based fleet of high-speed workers.

### Architecture

* **The RedPanda Engine:** A high-performance, CUDA-accelerated vanity address generator.
* **Capabilities:** Capable of grinding 58^6 combinations in minutes using NVIDIA L4 GPUs.
* **Features:** Supports simultaneous Prefix + Suffix matching and dynamic runtime arguments via a JSON-API compatible output.

**Unique to the market, VanityForge features transparent job queue management and a dynamic tiered access system, including an "Email-Based God Mode" for administrative oversight and testing.** The platform‚Äôs security model is built on a "Fort Knox" principle using client-derived encryption; users provide a personal PIN that generates the encryption key on-the-fly. The server exclusively stores a `bcrypt` hash of the PIN and the encrypted ciphertext, ensuring that unencrypted private keys exist only in volatile memory (RAM) for milliseconds and are never persisted, guaranteeing that even the platform operators cannot access user wallets.


======================================================================
FILE: index.html
======================================================================
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/png" href="favicon.png">
    <title>VanityForge</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://unpkg.com/@solana/web3.js@latest/lib/index.iife.min.js"></script>
    <script type="module" src="utils/sns.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body { background-color: #1a1a1a; color: #e0e0e0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; padding-top: 120px; }
        .glass-panel { background: rgba(40, 40, 40, 0.7); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.1); }

        /* Stats Bar Animation */
        @keyframes spin { to { transform: rotate(360deg); } }
        .gear-spin { animation: spin 12s linear infinite; }
        .gear-fast { animation-duration: 0.8s !important; }

        /* Custom scrollbar for better aesthetics */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1a1a1a; }
        ::-webkit-scrollbar-thumb { background: #4a4a4a; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #6a6a6a; }
        .numpad-btn {
            @apply bg-gray-800 hover:bg-gray-700 text-white font-bold py-4 rounded-lg shadow transition transform active:scale-95 text-xl;
        }
        .pin-dot {
            width: 12px; height: 12px; border-radius: 50%; background-color: #4b5563; transition: all 0.2s;
        }
        .pin-dot.active {
            background-color: #9333ea; box-shadow: 0 0 8px #9333ea;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center px-4">

    <nav class="fixed top-0 left-0 w-full z-50 glass-panel border-b border-gray-700/50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <span class="text-purple-500 font-bold text-xl tracking-wider uppercase"><i class="fa-solid fa-fire-flame-curved"></i> VanityForge</span>
                    </div>
                    <div class="hidden md:block">
                        <div class="ml-10 flex items-baseline space-x-4">
                            <a href="#" onclick="showSection('forge'); return false;" class="text-white bg-gray-900 px-3 py-2 rounded-md text-sm font-medium transition-colors" id="nav-forge">Forge</a>
                            <a href="#" onclick="openReferralDashboard(); return false;" class="text-gray-300 hover:text-white hover:bg-gray-700 px-3 py-2 rounded-md text-sm font-medium transition-colors" id="nav-referrals">Referrals</a>
                            <a href="/vvvip" class="text-gray-300 hover:text-white hover:bg-gray-700 px-3 py-2 rounded-md text-sm font-medium transition-colors">VVVIP Addresses</a>
                            <a href="/roadmap" class="text-gray-300 hover:text-white hover:bg-gray-700 px-3 py-2 rounded-md text-sm font-medium transition-colors">Roadmap</a>
                            <a href="/faq" class="text-gray-300 hover:text-white hover:bg-gray-700 px-3 py-2 rounded-md text-sm font-medium transition-colors">FAQ</a>
                            <a href="https://x.com/vanityforgeX" target="_blank" class="text-gray-300 hover:text-white hover:bg-gray-700 px-3 py-2 rounded-md text-sm font-medium transition-colors"><i class="fa-brands fa-x-twitter"></i></a>
                            <a href="https://github.com/TomaAytakin/VanityForge" target="_blank" class="text-gray-300 hover:text-white hover:bg-gray-700 px-3 py-2 rounded-md text-sm font-medium transition-colors"><i class="fa-brands fa-github"></i> GitHub</a>
                        </div>
                    </div>
                </div>
                <div class="-mr-2 flex md:hidden">
                    <button type="button" onclick="document.getElementById('mobile-menu').classList.toggle('hidden')" class="bg-gray-800 inline-flex items-center justify-center p-2 rounded-md text-gray-400 hover:text-white hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-gray-800 focus:ring-white">
                        <span class="sr-only">Open main menu</span>
                        <i class="fa-solid fa-bars"></i>
                    </button>
                </div>
            </div>
        </div>

        <div class="hidden md:hidden" id="mobile-menu">
            <div class="px-2 pt-2 pb-3 space-y-1 sm:px-3">
                <a href="#" onclick="showSection('forge'); return false;" class="text-white bg-gray-900 block px-3 py-2 rounded-md text-base font-medium">Forge</a>
                <a href="#" onclick="openReferralDashboard(); return false;" class="text-gray-300 hover:text-white block px-3 py-2 rounded-md text-base font-medium">Referrals</a>
                <a href="/vvvip" class="text-gray-300 hover:text-white block px-3 py-2 rounded-md text-base font-medium">VVVIP Addresses</a>
                <a href="/roadmap" class="text-gray-300 hover:text-white block px-3 py-2 rounded-md text-base font-medium">Roadmap</a>
                <a href="/faq" class="text-gray-300 hover:text-white block px-3 py-2 rounded-md text-base font-medium">FAQ</a>
                <a href="https://x.com/vanityforgeX" target="_blank" class="text-gray-300 hover:text-white block px-3 py-2 rounded-md text-base font-medium"><i class="fa-brands fa-x-twitter"></i> X (Twitter)</a>
                <a href="https://github.com/TomaAytakin/VanityForge" target="_blank" class="text-gray-300 hover:text-white block px-3 py-2 rounded-md text-base font-medium">GitHub</a>
            </div>
        </div>
    </nav>

    <!-- Stats Bar -->
    <div class="fixed top-16 left-0 w-full bg-gray-900/80 backdrop-blur border-b border-gray-700 py-2 flex justify-center items-center gap-3 text-purple-300 font-mono text-sm tracking-widest uppercase shadow-md z-40">
        <i id="activity-gear" class="fa-solid fa-gear gear-spin text-purple-500"></i>
        <span>Vanity Identities Forged: <span id="identity-counter" class="text-white font-bold text-base">...</span></span>
    </div>

    <div class="w-full max-w-2xl mb-8 flex flex-col items-center justify-center mt-10 gap-4">
        <div class="bg-gradient-to-r from-green-500 to-emerald-500 text-white font-bold py-2 px-6 rounded-full shadow-lg border border-green-400 flex items-center gap-2 animate-pulse">
            <i class="fa-brands fa-nvidia"></i> ‚ö° Now Powered Exclusively by NVIDIA L4
        </div>
        <img src="animated_forge.gif" alt="VanityForge Banner" class="rounded-xl shadow-2xl border border-gray-700 max-w-full h-auto">
    </div>

    <div id="auth-section" class="w-full max-w-2xl glass-panel p-8 rounded-xl shadow-lg text-center transition-all duration-300">
        <h2 class="text-2xl font-bold mb-6 text-purple-400">Connect to VanityForge</h2>
        <div class="flex flex-col gap-4 max-w-xs mx-auto">
            <button onclick="loginWithGoogle()" class="bg-white hover:bg-gray-100 text-gray-800 font-bold py-3 px-6 rounded-lg transition duration-200 flex items-center justify-center gap-2 shadow-md hover:shadow-lg transform hover:-translate-y-0.5">
                <i class="fa-brands fa-google"></i> Login with Google
            </button>
            <button id="connect-phantom-btn" onclick="connectWallet()" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-6 rounded-lg transition duration-200 flex items-center justify-center gap-2 shadow-md hover:shadow-lg transform hover:-translate-y-0.5">
                <i class="fa-solid fa-wallet"></i> Connect Phantom
            </button>
        </div>
    </div>

    <div id="app-interface" class="w-full max-w-2xl hidden space-y-6 animate-fade-in-up">

        <!-- ADMIN DASHBOARD SECTION -->
        <div id="admin-dashboard" class="glass-panel p-8 rounded-xl shadow-lg hidden">
            <h2 class="text-xl font-bold mb-6 text-yellow-400 flex items-center gap-2 border-b border-gray-700 pb-2">
                <i class="fa-solid fa-bolt"></i> God Mode Dashboard
            </h2>

            <div class="flex space-x-4 mb-6">
                <button onclick="showAdminTab('financials')" class="text-white bg-gray-700 px-3 py-2 rounded-md text-sm font-bold">Financials</button>
                <button onclick="showAdminTab('security')" class="text-gray-300 hover:text-white px-3 py-2 rounded-md text-sm font-bold">Security</button>
                <button onclick="showAdminTab('referrals-admin')" class="text-gray-300 hover:text-white px-3 py-2 rounded-md text-sm font-bold">Referrals</button>
            </div>

            <div id="admin-financials">
                <div class="grid grid-cols-3 gap-4 mb-4">
                    <div class="bg-gray-800 p-4 rounded text-center">
                        <span class="block text-gray-500 text-xs uppercase">Income (1W)</span>
                        <span class="text-2xl font-bold text-green-400" id="admin-inc-1w">...</span>
                    </div>
                    <div class="bg-gray-800 p-4 rounded text-center">
                        <span class="block text-gray-500 text-xs uppercase">Income (1M)</span>
                        <span class="text-2xl font-bold text-green-400" id="admin-inc-1m">...</span>
                    </div>
                    <div class="bg-gray-800 p-4 rounded text-center">
                        <span class="block text-gray-500 text-xs uppercase">Total Users</span>
                        <span class="text-2xl font-bold text-blue-400" id="admin-users">...</span>
                    </div>
                </div>
            </div>

            <div id="admin-security" class="hidden">
                 <h3 class="text-sm font-bold text-gray-400 mb-2">Recent Security Events</h3>
                 <div id="admin-sec-logs" class="bg-black/30 p-2 rounded h-40 overflow-y-auto font-mono text-xs text-red-300">
                     Loading...
                 </div>
            </div>

            <div id="admin-referrals-admin" class="hidden">
                 <h3 class="text-sm font-bold text-gray-400 mb-2">Top Referrers</h3>
                 <div id="admin-ref-list" class="space-y-2">
                     Loading...
                 </div>
            </div>
        </div>

        <!-- REFERRAL DASHBOARD SECTION -->
        <div id="referral-dashboard" class="glass-panel p-8 rounded-xl shadow-lg hidden">
            <h2 class="text-xl font-bold mb-6 text-purple-400 flex items-center gap-2 border-b border-gray-700 pb-2">
                <i class="fa-solid fa-users"></i> Referral Program
            </h2>

            <div id="referral-loading" class="text-center py-8 text-gray-400">
                <i class="fa-solid fa-spinner fa-spin text-2xl"></i><br>Loading Stats...
            </div>

            <!-- STATE 1: CREATE CODE -->
            <div id="referral-create" class="hidden text-center py-4">
                <i class="fa-solid fa-gift text-4xl text-purple-500 mb-4"></i>
                <h3 class="text-lg font-bold text-white mb-2">Earn 15% Commission Forever</h3>
                <p class="text-gray-400 text-sm mb-6 max-w-sm mx-auto">
                    Create your unique referral code. When users pay with your code, they get a <span class="text-green-400">10% Discount</span> and are
                    <span class="text-purple-400 font-bold">Lifetime Bound</span> to you. You earn 15% on every job they ever submit.
                </p>
                <button onclick="openNumpad('create_referral', 'Enter PIN to Generate Code', createReferralCode)" class="bg-gradient-to-r from-purple-600 to-indigo-600 hover:from-purple-700 hover:to-indigo-700 text-white font-bold py-3 px-8 rounded-lg shadow-lg transition transform hover:scale-105">
                    Generate My Code
                </button>
            </div>

            <!-- STATE 2: STATS & WITHDRAW -->
            <div id="referral-stats" class="hidden">
                <div class="bg-gray-800/50 rounded-lg p-6 mb-6 border border-gray-700">
                    <div class="flex flex-col md:flex-row justify-between items-center gap-4 mb-4">
                        <div class="text-center md:text-left">
                             <span class="text-xs text-gray-500 uppercase font-bold tracking-wider">Your Referral Code</span>
                             <div class="text-4xl font-mono font-bold text-white tracking-widest mt-1 text-purple-400" id="my-ref-code">----</div>
                        </div>
                        <div class="flex gap-3">
                             <button onclick="copyReferralCode()" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded shadow flex items-center gap-2 transition transform active:scale-95">
                                 <i class="fa-regular fa-copy"></i> Copy Code
                             </button>
                             <button onclick="copyReferralLink()" class="bg-gray-700 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded shadow flex items-center gap-2 transition transform active:scale-95">
                                 <i class="fa-solid fa-link"></i> Copy Link
                             </button>
                        </div>
                    </div>
                    <div class="pt-4 border-t border-gray-700 flex justify-between items-center text-sm">
                        <span class="text-gray-400">Total Usage:</span>
                        <strong class="text-white text-lg" id="ref-usage">0</strong>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4 mb-6">
                    <div class="bg-gray-800/50 p-4 rounded-lg border border-gray-700 text-center">
                        <span class="text-xs text-gray-500 uppercase block mb-1">Total Earnings</span>
                        <span class="text-xl font-bold text-green-400" id="ref-total">0.00 SOL</span>
                    </div>
                    <div class="bg-gray-800/50 p-4 rounded-lg border border-gray-700 text-center">
                         <span class="text-xs text-gray-500 uppercase block mb-1">Available Balance</span>
                         <span class="text-xl font-bold text-purple-400" id="ref-balance">0.00 SOL</span>
                    </div>
                </div>

                <h3 class="text-sm font-bold text-gray-300 mb-3 border-t border-gray-700 pt-4">Request Withdrawal</h3>
                <div class="space-y-3">
                    <input type="number" id="withdraw-amount" class="w-full bg-gray-800 border border-gray-700 rounded p-2 text-white text-sm" placeholder="Amount (Min 0.1 SOL)">
                    <input type="text" id="withdraw-wallet" class="w-full bg-gray-800 border border-gray-700 rounded p-2 text-white text-sm font-mono" placeholder="Target Wallet Address">
                    <button onclick="initiateWithdrawal()" class="w-full bg-gray-700 hover:bg-gray-600 text-white font-bold py-2 rounded transition border border-gray-600">
                        Request Payout
                    </button>
                    <p class="text-[10px] text-gray-500 text-center">Withdrawals are processed manually within 24 hours.</p>
                </div>
            </div>
        </div>

        <div id="forge-section">
        <div class="glass-panel p-8 rounded-xl shadow-lg relative overflow-hidden">
            <div class="absolute top-0 right-0 p-4 opacity-10">
                <i class="fa-solid fa-code text-6xl text-purple-500"></i>
            </div>
            <h2 class="text-xl font-bold mb-4 text-purple-400 flex items-center gap-2">
                <i class="fa-solid fa-plus-circle"></i> Request New Vanity Address
            </h2>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                <div>
                    <label class="block text-sm text-gray-400 mb-1">Prefix (Starts with)</label>
                    <input type="text" id="prefix" class="w-full bg-gray-800 border border-gray-700 rounded p-2 focus:border-purple-500 focus:outline-none text-white font-mono placeholder-gray-600" placeholder="e.g. CAFE">
                </div>
                <div>
                    <label class="block text-sm text-gray-400 mb-1">Suffix (Ends with)</label>
                    <input type="text" id="suffix" class="w-full bg-gray-800 border border-gray-700 rounded p-2 focus:border-purple-500 focus:outline-none text-white font-mono placeholder-gray-600" placeholder="e.g. 888">
                </div>
            </div>

            <!-- Referral Code Input -->
            <div class="mb-4">
                 <label class="block text-sm text-gray-400 mb-1">Referral Code (Optional)</label>
                 <div class="flex gap-2">
                     <input type="text" id="referral-code-input" maxlength="4" class="w-full bg-gray-800 border border-gray-700 rounded p-2 focus:border-purple-500 focus:outline-none text-white font-mono placeholder-gray-600 uppercase" placeholder="CODE">
                     <button onclick="checkReferralCode()" class="bg-gray-700 hover:bg-gray-600 text-white px-4 rounded border border-gray-600 transition" type="button">
                         Check
                     </button>
                 </div>
                 <p id="referral-status-msg" class="text-xs mt-1 hidden"></p>
            </div>

            <p class="text-xs text-gray-500 mb-4">Note: Characters 0, O, I, and l are not allowed by Solana for security reasons.</p>

            <div class="flex flex-col gap-3 mb-4">
                <div class="flex items-center gap-2">
                    <div class="relative inline-block w-10 mr-2 align-middle select-none transition duration-200 ease-in">
                        <input type="checkbox" name="toggle" id="case-sensitive" class="toggle-checkbox absolute block w-5 h-5 rounded-full bg-white border-4 appearance-none cursor-pointer"/>
                        <label for="case-sensitive" class="toggle-label block overflow-hidden h-5 rounded-full bg-gray-700 cursor-pointer"></label>
                    </div>
                    <label for="case-sensitive" class="text-sm text-gray-300 cursor-pointer select-none">Case Sensitive</label>

                    <div class="ml-auto flex items-center gap-2">
                        <input type="checkbox" id="email-notify" class="w-4 h-4 text-purple-600 bg-gray-700 border-gray-600 rounded focus:ring-purple-500 focus:ring-2">
                        <label for="email-notify" class="text-sm text-gray-300 cursor-pointer select-none">Email me when done</label>
                    </div>
                </div>

                <div class="mb-4">
                  <label class="block text-gray-400 text-sm font-bold mb-2">Compute Method</label>
                  <div class="flex space-x-4">
                    <label class="inline-flex items-center">
                      <input type="radio" name="compute_method" value="cpu" checked class="form-radio text-purple-500">
                      <span class="ml-2 text-white">CPU (Stable)</span>
                    </label>
                    <label class="inline-flex items-center">
                      <input type="radio" name="compute_method" value="gpu" class="form-radio text-purple-500">
                      <span class="ml-2 text-white">GPU (Updating...)</span>
                    </label>
                  </div>
                  <div id="gpu-warning" class="hidden mt-2 p-2 bg-yellow-600 text-white rounded text-sm">
                    ‚ö†Ô∏è GPU Worker Cluster is currently updating. Please use CPU.
                  </div>
                </div>

                <!-- GPU Option Removed: Now Default -->
                <div class="hidden flex items-center gap-2 p-2 bg-purple-900/20 rounded border border-purple-500/30">
                     <input type="checkbox" id="use-gpu" class="w-4 h-4 text-purple-600 bg-gray-700 border-gray-600 rounded focus:ring-purple-500 focus:ring-2" checked disabled>
                </div>
            </div>

                <style>
                    .toggle-checkbox:checked { right: 0; border-color: #9333ea; }
                    .toggle-checkbox:checked + .toggle-label { background-color: #9333ea; }
                    .toggle-checkbox { right: 0; border-color: #4b5563; transition: all 0.3s; top: 0; left: 0;}
                    .toggle-checkbox:checked { left: 50%; }
                    .toggle-label { width: 100%; }
                    .toggle-checkbox { position: absolute; top:0; left: 0; right: auto; bottom: auto; }
                    .toggle-checkbox:checked { left: 1.25rem; border-color: #a855f7; }
                </style>
            </div>

            <div class="bg-gray-800/50 rounded-lg p-4 mb-6 text-sm border border-gray-700">
                <div class="flex justify-between items-center mb-2">
                    <span class="text-gray-400">Difficulty:</span>
                    <span id="calc-difficulty" class="text-white font-bold">0 chars</span>
                </div>
                <div class="flex justify-between items-center mb-2">
                    <span class="text-gray-400">Est. Time:</span>
                    <span id="calc-time" class="text-white font-mono">Instant</span>
                </div>
                <div class="flex justify-between items-center pt-2 border-t border-gray-700">
                    <span class="text-gray-400">Cost:</span>
                    <span id="calc-cost" class="text-green-400 font-bold font-mono">0 Credits</span>
                </div>
            </div>

            <button onclick="startSubmissionFlow()" class="w-full bg-gradient-to-r from-purple-600 to-indigo-600 hover:from-purple-700 hover:to-indigo-700 text-white font-bold py-3 rounded-lg shadow-lg transition transform hover:scale-[1.01] active:scale-[0.99] flex justify-center items-center gap-2">
                <i class="fa-solid fa-rocket"></i> Forge
            </button>
            <p id="submit-error" class="text-red-400 text-sm mt-3 text-center hidden bg-red-900/20 py-2 rounded border border-red-900/50"></p>
        </div> <!-- End of forge-section -->

        <!-- Job Queue Section -->
        <div id="job-queue-section" class="glass-panel p-8 rounded-xl shadow-lg hidden">
            <h3 class="text-lg font-bold mb-4 text-gray-300 border-b border-gray-700 pb-2 flex items-center justify-between">
                <span><i class="fa-solid fa-list-ul mr-2 text-purple-500"></i>Your Jobs</span>
                <div class="flex items-center gap-3">
                    <span class="text-xs font-normal text-gray-500" id="user-id-display"></span>
                    <button onclick="logout()" class="text-xs text-red-400 hover:text-red-300 transition-colors" title="Logout">
                        <i class="fa-solid fa-sign-out-alt"></i>
                    </button>
                </div>
            </h3>
            <div class="overflow-x-auto">
                <!-- Job Queue Table: Fixed Layout -->
                <table class="w-full text-left border-collapse" style="table-layout: fixed;">
                    <thead>
                        <tr class="text-gray-400 border-b border-gray-700 text-xs uppercase tracking-wider">
                             <!-- Fixed Column Widths -->
                             <th class="py-3 font-medium text-gray-500" style="width: 25%;">Target</th>
                             <th class="py-3 font-medium text-gray-500" style="width: 20%;">Status</th>
                             <th class="py-3 font-medium text-gray-500" style="width: 55%;">Details / Key</th>
                        </tr>
                    </thead>
                    <tbody id="jobs-container" class="text-sm divide-y divide-gray-800">
                        <!-- Rows injected here -->
                    </tbody>
                </table>
                <div id="jobs-empty-state" class="text-center text-gray-500 italic py-8 hidden">No active jobs found.</div>
            </div>
        </div>
    </div>

    <div id="numpad-modal" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-80 backdrop-blur-sm hidden transition-opacity duration-300">
        <div class="bg-gray-900 border border-gray-700 rounded-2xl shadow-2xl p-6 w-full max-w-sm transform scale-95 transition-transform duration-300" id="numpad-content">
            <h3 id="numpad-title" class="text-center text-xl font-bold text-white mb-6">Enter Vault PIN</h3>

            <div id="numpad-warning" class="hidden bg-yellow-900/30 border border-yellow-600/50 text-yellow-200 p-3 rounded mb-4 text-xs text-left">
                <p class="font-bold mb-1"><i class="fa-solid fa-triangle-exclamation mr-1"></i> Warning:</p>
                You are about to create a permanent encryption PIN. VanityForge does not store this PIN. If you lose it, you will permanently lose the capability to reveal your private keys or forge new wallets within your VanityForge account. We cannot recover it for you.
            </div>

            <div class="flex justify-center gap-4 mb-8" id="pin-display">
                </div>

            <div id="numpad-checkbox-container" class="hidden mb-4 text-left">
                 <label class="flex items-start gap-2 text-xs text-gray-400 cursor-pointer">
                    <input type="checkbox" id="pin-acknowledge" class="mt-0.5 w-4 h-4 text-purple-600 bg-gray-700 border-gray-600 rounded focus:ring-purple-500 focus:ring-2">
                    <span>I acknowledge that VanityForge cannot recover my PIN if lost, and that losing my PIN means I will be unable to reveal my private keys or access my VanityForge account functions.</span>
                </label>
            </div>

            <div class="grid grid-cols-3 gap-4">
                <button class="numpad-btn bg-gray-800 hover:bg-gray-700 text-white font-bold py-4 rounded-lg shadow transition transform active:scale-95 text-xl" onclick="numpadInput(1)">1</button>
                <button class="numpad-btn bg-gray-800 hover:bg-gray-700 text-white font-bold py-4 rounded-lg shadow transition transform active:scale-95 text-xl" onclick="numpadInput(2)">2</button>
                <button class="numpad-btn bg-gray-800 hover:bg-gray-700 text-white font-bold py-4 rounded-lg shadow transition transform active:scale-95 text-xl" onclick="numpadInput(3)">3</button>
                <button class="numpad-btn bg-gray-800 hover:bg-gray-700 text-white font-bold py-4 rounded-lg shadow transition transform active:scale-95 text-xl" onclick="numpadInput(4)">4</button>
                <button class="numpad-btn bg-gray-800 hover:bg-gray-700 text-white font-bold py-4 rounded-lg shadow transition transform active:scale-95 text-xl" onclick="numpadInput(5)">5</button>
                <button class="numpad-btn bg-gray-800 hover:bg-gray-700 text-white font-bold py-4 rounded-lg shadow transition transform active:scale-95 text-xl" onclick="numpadInput(6)">6</button>
                <button class="numpad-btn bg-gray-800 hover:bg-gray-700 text-white font-bold py-4 rounded-lg shadow transition transform active:scale-95 text-xl" onclick="numpadInput(7)">7</button>
                <button class="numpad-btn bg-gray-800 hover:bg-gray-700 text-white font-bold py-4 rounded-lg shadow transition transform active:scale-95 text-xl" onclick="numpadInput(8)">8</button>
                <button class="numpad-btn bg-gray-800 hover:bg-gray-700 text-white font-bold py-4 rounded-lg shadow transition transform active:scale-95 text-xl" onclick="numpadInput(9)">9</button>
                <button class="numpad-btn bg-gray-800 hover:bg-gray-700 text-red-400 font-bold py-4 rounded-lg shadow transition transform active:scale-95 text-xl" onclick="numpadClear()"><i class="fa-solid fa-delete-left"></i></button>
                <button class="numpad-btn bg-gray-800 hover:bg-gray-700 text-white font-bold py-4 rounded-lg shadow transition transform active:scale-95 text-xl" onclick="numpadInput(0)">0</button>
                <button id="numpad-submit-btn" class="numpad-btn bg-purple-600 hover:bg-purple-700 text-white font-bold py-4 rounded-lg shadow transition transform active:scale-95 text-xl" onclick="numpadSubmit()"><i class="fa-solid fa-check"></i></button>
            </div>
            <button onclick="closeNumpad()" class="mt-6 w-full text-gray-500 hover:text-white text-sm">Cancel</button>
        </div>
    </div>

    <div id="beta-modal" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-80 backdrop-blur-sm hidden transition-opacity duration-300">
        <div class="bg-gray-900 border border-purple-500 rounded-2xl shadow-2xl p-6 w-full max-w-sm transform scale-95 transition-transform duration-300 text-center relative overflow-hidden" id="beta-modal-content">
            <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-purple-500 to-pink-500"></div>
            <i class="fa-solid fa-tags text-4xl text-purple-400 mb-4 animate-bounce"></i>
            <h3 class="text-2xl font-bold text-white mb-2">Beta Access Unlocked!</h3>
            <p class="text-gray-300 mb-6">You've received a <span class="text-purple-400 font-bold">50% Discount</span> on all vanity address generations during our Beta phase.</p>
            <button onclick="closeBetaModal()" class="bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-700 hover:to-pink-700 text-white font-bold py-2 px-6 rounded-lg shadow-lg transition transform hover:scale-105">
                Let's Forge!
            </button>
        </div>
    </div>

    <script>
        // CONFIGURATION (HARDCODED)
        const TREASURY_WALLET_ADDRESS = "CUfjsGUee8u83dfFxHt1jXJUCRLiF1KoWVYcKyVforGe";
        const API_URL = "/submit-job"; // Relative path
        const FIREBASE_CONFIG = {
            apiKey: "AIzaSyCSYhscdfpQD19GMsm3qIJw9AWC5OYjqMY",
            authDomain: "vanityforge.firebaseapp.com",
            projectId: "vanityforge",
            storageBucket: "vanityforge.firebasestorage.app",
            messagingSenderId: "124272129554",
            appId: "1:124272129554:web:5e4f9e1d89bd54b3accacb",
            measurementId: "G-97FJY9VP2K"
        };
        // INIT FIREBASE
        if (!firebase.apps.length) {
            firebase.initializeApp(FIREBASE_CONFIG);
        }
        const db = firebase.firestore();
        // CHECK REDIRECT RESULT
        firebase.auth().getRedirectResult().then(async (result) => {
            if (result.user) {
                const user = result.user;
                const token = await user.getIdToken();
                currentUser = user.uid;
                currentUserEmail = user.email;
                checkUserStatus(currentUser, token);
            }
        }).catch((error) => {
            console.error("Redirect Login Error:", error);
            // Optional: alert(error.message);
        });
        // STATE
        const ADMIN_EMAILS = ["tomaaytakin@gmail.com", "Jonny95hidalgo@gmail.com", "admin@vanityforge.org"];
        let isExplicitLogin = false;
        var currentUser = null;
        var currentUserEmail = null;
        var jobListenerUnsubscribe = null;
        var userTrialsUsed = 0;
        var referralDiscountActive = false;

        // AUDIO SYSTEM
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        function playSound(type) {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const oscillator = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();

            oscillator.connect(gainNode);
            gainNode.connect(audioCtx.destination);
            if (type === 'input') {
                // High pitch blip
                oscillator.type = 'sine';
                // or triangle
                oscillator.frequency.setValueAtTime(880, audioCtx.currentTime);
                // A5
                oscillator.frequency.exponentialRampToValueAtTime(100, audioCtx.currentTime + 0.1);
                gainNode.gain.setValueAtTime(0.1, audioCtx.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.1);

                oscillator.start();
                oscillator.stop(audioCtx.currentTime + 0.1);
            } else if (type === 'delete') {
                // Low pitch whoosh/buzz
                oscillator.type = 'sawtooth';
                oscillator.frequency.setValueAtTime(150, audioCtx.currentTime);
                oscillator.frequency.linearRampToValueAtTime(50, audioCtx.currentTime + 0.2);

                gainNode.gain.setValueAtTime(0.1, audioCtx.currentTime);
                gainNode.gain.linearRampToValueAtTime(0.01, audioCtx.currentTime + 0.2);

                oscillator.start();
                oscillator.stop(audioCtx.currentTime + 0.2);
            }
        }

        // NUMPAD LOGIC
        let currentPin = "";
        let numpadMode = ""; // 'create', 'submit', 'reveal'
        let numpadCallback = null;
        let revealJobId = null;

        function openNumpad(mode, title, callback, jobId = null) {
            currentPin = "";
            numpadMode = mode;
            numpadCallback = callback;
            revealJobId = jobId;

            document.getElementById('numpad-title').innerText = title;
            updatePinDisplay();

            const warningEl = document.getElementById('numpad-warning');
            const checkboxContainer = document.getElementById('numpad-checkbox-container');
            const checkbox = document.getElementById('pin-acknowledge');
            const submitBtn = document.getElementById('numpad-submit-btn');

            if (mode === 'create') {
                warningEl.classList.remove('hidden');
                checkboxContainer.classList.remove('hidden');
                checkbox.checked = false;
                updateSubmitButtonState();
            } else {
                warningEl.classList.add('hidden');
                checkboxContainer.classList.add('hidden');
                submitBtn.disabled = false;
                submitBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                submitBtn.classList.add('hover:bg-purple-700', 'active:scale-95');
            }

            const modal = document.getElementById('numpad-modal');
            modal.classList.remove('hidden');
            setTimeout(() => {
                document.getElementById('numpad-content').classList.replace('scale-95', 'scale-100');
            }, 10);
        }

        document.getElementById('pin-acknowledge').addEventListener('change', updateSubmitButtonState);

        function updateSubmitButtonState() {
            if (numpadMode !== 'create') return;

            const checkbox = document.getElementById('pin-acknowledge');
            const submitBtn = document.getElementById('numpad-submit-btn');

            if (checkbox.checked) {
                submitBtn.disabled = false;
                submitBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                submitBtn.classList.add('hover:bg-purple-700', 'active:scale-95');
            } else {
                submitBtn.disabled = true;
                submitBtn.classList.add('opacity-50', 'cursor-not-allowed');
                submitBtn.classList.remove('hover:bg-purple-700', 'active:scale-95');
            }
        }

        function closeNumpad() {
            const modal = document.getElementById('numpad-modal');
            document.getElementById('numpad-content').classList.replace('scale-100', 'scale-95');
            setTimeout(() => {
                modal.classList.add('hidden');
            }, 300);
            currentPin = "";
        }

        function numpadInput(num) {
            if (currentPin.length < 6) {
                currentPin += num;
                playSound('input');
                updatePinDisplay();
            }
        }

        // --- REFERRAL SYSTEM LOGIC ---
        function showSection(section) {
            const forgeSec = document.getElementById('forge-section');
            const refSec = document.getElementById('referral-dashboard');
            const navForge = document.getElementById('nav-forge');
            const navRef = document.getElementById('nav-referrals');

            // Reset classes
            navForge.className = navForge.className.replace('bg-gray-900 text-white', 'text-gray-300 hover:text-white hover:bg-gray-700');
            navRef.className = navRef.className.replace('bg-gray-900 text-white', 'text-gray-300 hover:text-white hover:bg-gray-700');

            if (section === 'forge') {
                forgeSec.classList.remove('hidden');
                refSec.classList.add('hidden');
                navForge.classList.add('bg-gray-900', 'text-white');
                navForge.classList.remove('text-gray-300', 'hover:text-white', 'hover:bg-gray-700');
            } else {
                forgeSec.classList.add('hidden');
                refSec.classList.remove('hidden');
                navRef.classList.add('bg-gray-900', 'text-white');
                navRef.classList.remove('text-gray-300', 'hover:text-white', 'hover:bg-gray-700');
            }
        }

        async function openReferralDashboard() {
            showSection('referrals');
            if (!currentUser) return; // Should allow guest? No, needs ID.

            const loading = document.getElementById('referral-loading');
            const createDiv = document.getElementById('referral-create');
            const statsDiv = document.getElementById('referral-stats');

            loading.classList.remove('hidden');
            createDiv.classList.add('hidden');
            statsDiv.classList.add('hidden');

            try {
                const res = await fetch(`/api/referral/stats?user_id=${currentUser}`);
                if (res.status === 404) {
                    loading.classList.add('hidden');
                    createDiv.classList.remove('hidden');
                } else if (res.ok) {
                    const data = await res.json();
                    document.getElementById('my-ref-code').innerText = data.code;
                    document.getElementById('ref-usage').innerText = data.usage_count;
                    document.getElementById('ref-total').innerText = data.total_earnings.toFixed(3) + ' SOL';
                    document.getElementById('ref-balance').innerText = data.balance_sol.toFixed(3) + ' SOL';

                    loading.classList.add('hidden');
                    statsDiv.classList.remove('hidden');
                } else {
                    alert("Error loading stats");
                }
            } catch (e) {
                console.error(e);
                loading.innerText = "Error";
            }
        }

        async function createReferralCode(pin) {
            try {
                const res = await fetch('/api/referral/create', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ user_id: currentUser, pin: pin })
                });
                const data = await res.json();
                if (res.ok) {
                    alert("Code Created! " + data.code);
                    openReferralDashboard(); // Refresh
                } else {
                    alert("Error: " + data.error);
                }
            } catch (e) {
                console.error(e);
                alert("Creation failed.");
            }
        }

        async function initiateWithdrawal() {
             const amount = parseFloat(document.getElementById('withdraw-amount').value);
             const wallet = document.getElementById('withdraw-wallet').value;
             if (!amount || amount < 0.1) {
                 alert("Minimum withdrawal is 0.1 SOL");
                 return;
             }
             if (!wallet) {
                 alert("Please enter a wallet address");
                 return;
             }
             openNumpad('withdraw_referral', 'Enter PIN to Withdraw', submitWithdrawal);
        }

        async function submitWithdrawal(pin) {
             const amount = document.getElementById('withdraw-amount').value;
             const wallet = document.getElementById('withdraw-wallet').value;
             try {
                const res = await fetch('/api/referral/withdraw', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        user_id: currentUser,
                        pin: pin,
                        amount: amount,
                        target_wallet: wallet
                    })
                });
                const data = await res.json();
                if (res.ok) {
                    alert("Withdrawal Requested! Admin will process it shortly.");
                    openReferralDashboard(); // Refresh
                    document.getElementById('withdraw-amount').value = '';
                } else {
                    alert("Error: " + data.error);
                }
            } catch (e) {
                console.error(e);
                alert("Withdrawal failed.");
            }
        }

        async function checkReferralCode() {
            const code = document.getElementById('referral-code-input').value.toUpperCase();
            const msg = document.getElementById('referral-status-msg');
            if (!code) return;

            try {
                const res = await fetch('/api/referral/validate', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ code: code })
                });
                const data = await res.json();
                if (data.valid) {
                    referralDiscountActive = true;
                    msg.innerText = "Code Applied! 10% Discount Active.";
                    msg.className = "text-xs mt-1 text-green-400 font-bold";
                    msg.classList.remove('hidden');
                } else {
                    referralDiscountActive = false;
                    msg.innerText = "Invalid Code.";
                    msg.className = "text-xs mt-1 text-red-400";
                    msg.classList.remove('hidden');
                }
                updateEstimates();
            } catch(e) { console.error(e); }
        }

        function numpadClear() {
            if (currentPin.length > 0) {
                currentPin = currentPin.slice(0, -1);
                playSound('delete');
                updatePinDisplay();
            }
        }

        function updatePinDisplay() {
            const container = document.getElementById('pin-display');
            container.innerHTML = '';
            // Always show 6 slots
            for (let i = 0; i < 6; i++) {
                const dot = document.createElement('div');
                dot.className = `pin-dot ${i < currentPin.length ? 'active' : ''}`;
                container.appendChild(dot);
            }
        }

        async function numpadSubmit() {
            if (currentPin.length < 4) {
                alert("PIN must be at least 4 digits.");
                return;
            }
            playSound('input'); // Confirm sound?
            if (numpadMode === 'create') {
                await setPin(currentPin);
            } else if (numpadMode === 'submit') {
                numpadCallback(currentPin);
            } else if (numpadMode === 'reveal') {
                numpadCallback(revealJobId, currentPin);
            } else if (numpadMode === 'create_referral') {
                numpadCallback(currentPin);
            } else if (numpadMode === 'withdraw_referral') {
                numpadCallback(currentPin);
            }

            closeNumpad();
        }

        // AUTHENTICATION
        async function loginWithGoogle() {
            isExplicitLogin = true;
            const provider = new firebase.auth.GoogleAuthProvider();
            try {
                const result = await firebase.auth().signInWithPopup(provider);
                const user = result.user;
                const token = await user.getIdToken();
                currentUser = user.uid;
                window.walletAddress = user.uid; // Satisfy guard check
                currentUserEmail = user.email;
                await checkUserStatus(currentUser, token);
            } catch (error) {
                console.error("Popup error:", error);
                alert("Google Login Failed: " + error.message);
            }
        }

        async function connectWallet(silent = false) {
            if (window.solana && window.solana.isPhantom) {
                // üîí FIX: Aggressive disconnect to force popup
                if (!silent && window.solana.isConnected) {
                    await window.solana.disconnect();
                    await new Promise(r => setTimeout(r, 400)); // Delay is crucial
                }

                if (!silent) {
                    isExplicitLogin = true;
                    // Now connect actively (forces popup)
                    try {
                        const resp = await window.solana.connect();
                        currentUser = resp.publicKey.toString();
                        window.walletAddress = currentUser;
                        window.currentWallet = currentUser; // Fix SNS
                        await checkUserStatus(currentUser);
                    } catch (err) {
                        console.error(err);
                        alert("Connection failed.");
                    }
                } else {
                    // Silent auto-connect (only on load)
                    try {
                        const resp = await window.solana.connect({ onlyIfTrusted: true });
                        currentUser = resp.publicKey.toString();
                        window.walletAddress = currentUser;
                        window.currentWallet = currentUser; // Fix SNS
                        await checkUserStatus(currentUser);
                    } catch (e) {
                        // Silent fail - User stays as Guest
                    }
                }
            } else {
                if (!silent) window.open("https://phantom.app/", "_blank");
            }
        }

        window.addEventListener('load', () => {
            // Check for Referral Link
            const urlParams = new URLSearchParams(window.location.search);
            const refCode = urlParams.get('ref');
            if (refCode) {
                const input = document.getElementById('referral-code-input');
                if (input) {
                    input.value = refCode.toUpperCase();
                    // Auto-validate after a short delay to ensure UI is ready
                    setTimeout(() => checkReferralCode(), 500);
                }
            }

            if (window.solana && window.solana.isPhantom) {
                connectWallet(true);
            }
        });

        async function checkUserStatus(userId, idToken = null) {
            if (!userId) return;
            try {
                const body = { user_id: userId };
                if (idToken) body.id_token = idToken;

                // Fallback to email if no token (legacy/unsafe but kept for compat)
                if (currentUserEmail) body.email = currentUserEmail;

                const res = await fetch('/check-user', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(body)
                });
                const data = await res.json();
                userTrialsUsed = data.trials_used || 0;

                // Lifetime Binding Check
                if (data.referred_by) {
                    const refInput = document.getElementById('referral-code-input');
                    refInput.value = data.referred_by;
                    refInput.disabled = true;

                    const msg = document.getElementById('referral-status-msg');
                    msg.innerText = "Lifetime Discount Active (Bound to " + data.referred_by + ")";
                    msg.className = "text-xs mt-1 text-purple-400 font-bold";
                    msg.classList.remove('hidden');

                    referralDiscountActive = true;
                }

                if (data.has_pin) {
                    onLoginSuccess();
                } else {
                    // üîí FIX: Stop here if this wasn't an explicit user action
                    if (
                        isExplicitLogin === true &&
                        window.walletAddress &&
                        typeof window.walletAddress === "string"
                    ) {
                        // Prompt to create PIN
                        document.getElementById('auth-section').classList.add('hidden');
                        // Hide auth temporarily
                        openNumpad('create', 'Create your Vault PIN', null);
                    }
                }
            } catch (e) {
                console.error(e);
                alert("Error checking user status.");
            }
        }

        async function setPin(pin) {
            try {
                const res = await fetch('/set-pin', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ user_id: currentUser, pin: pin })
                });
                if (res.ok) {
                    onLoginSuccess();
                } else {
                    alert("Failed to set PIN.");
                    location.reload();
                }
            } catch (e) {
                console.error(e);
                alert("Error setting PIN.");
            }
        }

        function closeBetaModal() {
            const modal = document.getElementById('beta-modal');
            document.getElementById('beta-modal-content').classList.replace('scale-100', 'scale-95');
            setTimeout(() => {
                modal.classList.add('hidden');
            }, 300);
        }

        function onLoginSuccess(isDev = false) {
            document.getElementById('auth-section').classList.add('hidden');
            const appInterface = document.getElementById('app-interface');
            appInterface.classList.remove('hidden');
            document.getElementById('job-queue-section').classList.remove('hidden');

            // God Mode Check
            if (ADMIN_EMAILS.includes(currentUserEmail)) {
                const titleSpan = document.querySelector('nav .text-purple-500');
                if (titleSpan) {
                    titleSpan.innerHTML = '<i class="fa-solid fa-fire-flame-curved"></i> Welcome Dev üõ†Ô∏è';
                }
                const godModeBadge = document.createElement('span');
                godModeBadge.className = "ml-4 bg-yellow-500/20 text-yellow-400 text-xs font-bold px-2 py-1 rounded border border-yellow-500/50 animate-pulse";
                godModeBadge.innerText = "God Mode Active";
                titleSpan.appendChild(godModeBadge);
            }

            // Show Beta Modal
            const betaModal = document.getElementById('beta-modal');
            betaModal.classList.remove('hidden');
             setTimeout(() => {
                document.getElementById('beta-modal-content').classList.replace('scale-95', 'scale-100');
            }, 10);
            // Simple fade in effect
            appInterface.style.opacity = 0;
            setTimeout(() => {
                appInterface.style.transition = 'opacity 0.5s ease-in-out';
                appInterface.style.opacity = 1;
            }, 50);
            let displayId = currentUser;
            if (currentUser === "DEV_USER") displayId = "Dev Mode";
            else if (currentUser.length > 10) displayId = currentUser.slice(0, 4) + '...' + currentUser.slice(-4);

            document.getElementById('user-id-display').innerText = displayId;
            // Default Check email notify if logged in via Google (and thus have email)
            if (currentUserEmail) {
                document.getElementById('email-notify').checked = true;
            }

            pollJobStatus();
        }

        // CALCULATIONS (Helpers)
        function escapeHtml(text) {
            if (!text) return text;
            return text.replace(/[&<>"']/g, function(m) { return {'&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;'}[m]; });
        }

        function updateEstimates() {
            const p = document.getElementById('prefix').value || "";
            const s = document.getElementById('suffix').value || "";
            const totalLen = p.length + s.length;

            // use-gpu is always true now
            const useGpuCheckbox = document.getElementById('use-gpu');
            if (useGpuCheckbox) useGpuCheckbox.checked = true;

            if (totalLen === 0) {
                document.getElementById('calc-difficulty').innerText = "0 chars";
                document.getElementById('calc-time').innerText = "Instant";
                document.getElementById('calc-cost').innerText = "0 SOL";
                return;
            }

            // Fixed Pricing Logic
            let basePrice = 0;
            if (totalLen <= 4) basePrice = 0.25;
            else if (totalLen === 5) basePrice = 0.50;
            else if (totalLen === 6) basePrice = 1.00;
            else if (totalLen === 7) basePrice = 2.00;
            else if (totalLen === 8) basePrice = 3.00;
            else basePrice = 5.00;

            // No GPU Surcharge anymore - everyone gets GPU

            // Apply 50% Discount (on the final price)
            let finalPrice = basePrice * 0.5;

            // Apply Referral Discount (Extra 10%)
            if (referralDiscountActive) {
                finalPrice = finalPrice * 0.90;
            }

            // Check Trial (Only if NOT using GPU, or maybe trial allows GPU? Assuming trial is basic only usually, but let's assume trial covers cost)
            // If user selects GPU, maybe trial doesn't apply? User requirement: "50% Beta Discount Applied".
            // Let's assume Trial is valid for price 0, regardless of GPU selection if Length <= 4.
            // But if they select GPU for length 4, does it cost money? "If selected, increase the calculated price by 50%."
            // If trial makes it free, 0 * 1.5 = 0.

            let isTrial = false;
            if (totalLen <= 4 && userTrialsUsed < 2) {
                isTrial = true;
                finalPrice = 0;
            }

            // Time Estimate Logic
            // New Formula: (Difficulty / 300,000,000) + 600
            // Difficulty = 0.5 * 58^TotalLength
            // 600s buffer for cloud provisioning

            let difficulty = 0.5 * Math.pow(58, totalLen);
            let speed = 300000000; // 300 MH/s
            let buffer = 600; // 10 minutes

            let seconds = (difficulty / speed) + buffer;

            let timeStr;
            // Always show minutes if < hour, else hours/days
            // Since min is 600s (10m), we start at 10m
            if (seconds < 3600) timeStr = Math.ceil(seconds/60) + "m";
            else if (seconds < 86400) timeStr = (seconds/3600).toFixed(1) + "h";
            else timeStr = (seconds/86400).toFixed(1) + "d";

            document.getElementById('calc-difficulty').innerText = totalLen + " chars";
            document.getElementById('calc-time').innerText = "~" + timeStr;

            const costEl = document.getElementById('calc-cost');
            if (isTrial) {
                 // Trial UI: <del>0.25 SOL</del> FREE (Trial)
                 costEl.innerHTML = `<span style="text-decoration:line-through;" class="text-gray-500 mr-2">${basePrice.toFixed(2)} SOL</span> <span class="text-green-400">FREE (Trial)</span>`;
            } else {
                 // Discount UI: <del>1.0 SOL</del> 0.5 SOL
                 costEl.innerHTML = `<span style="text-decoration:line-through;" class="text-gray-500 mr-2">${basePrice.toFixed(2)} SOL</span> <span class="text-purple-400">${finalPrice.toFixed(2)} SOL</span>`;
            }

            // Hard Limit Warning - REMOVED for >5 because we now support it via GPU
            /*
            if (totalLen > 5 && !ADMIN_EMAILS.includes(currentUserEmail)) {
                // ...
            }
            */
           // Clear errors
           document.getElementById('submit-error').classList.add('hidden');
           document.querySelector('button[onclick="startSubmissionFlow()"]').disabled = false;
           document.querySelector('button[onclick="startSubmissionFlow()"]').classList.remove('opacity-50', 'cursor-not-allowed');
        }

        ['prefix', 'suffix'].forEach(id => {
            document.getElementById(id).addEventListener('input', (e) => {
                const val = e.target.value;
                const clean = val.replace(/[^1-9A-HJ-NP-Za-km-z]/g, '');
                if (val !== clean) e.target.value = clean;
                updateEstimates();
            });
        });

        const computeRadios = document.querySelectorAll('input[name="compute_method"]');
        const gpuWarning = document.getElementById('gpu-warning');
        // We target the Forge button. It calls startSubmissionFlow()
        // It's the button with that onclick handler.
        const forgeBtn = document.querySelector('button[onclick="startSubmissionFlow()"]');

        computeRadios.forEach(radio => {
          radio.addEventListener('change', (e) => {
            if (e.target.value === 'gpu') {
              gpuWarning.classList.remove('hidden');
              forgeBtn.disabled = true;
              forgeBtn.classList.add('opacity-50', 'cursor-not-allowed');
            } else {
              gpuWarning.classList.add('hidden');
              forgeBtn.disabled = false;
              forgeBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            }
          });
        });

        // document.getElementById('use-gpu').addEventListener('change', updateEstimates);
        // EMAIL NOTIFICATION LOGIC
        document.getElementById('email-notify').addEventListener('change', async function(e) {
            if (this.checked && !currentUserEmail) {
                const provider = new firebase.auth.GoogleAuthProvider();
                try {
                    const result = await firebase.auth().signInWithPopup(provider);
                    const user = result.user;
                    currentUser = user.uid;
                    currentUserEmail = user.email;
                    await checkUserStatus(currentUser);
                } catch (error) {
                    console.error("Email login failed:", error);
                    this.checked = false;
                    alert("Email is required for notifications.");
                }
            }
        });

        // JOB SUBMISSION
        function startSubmissionFlow() {
             const prefix = document.getElementById('prefix').value;
             const suffix = document.getElementById('suffix').value;
             const totalLen = prefix.length + suffix.length;
             if (!prefix && !suffix) {
                const errorEl = document.getElementById('submit-error');
                errorEl.innerText = "Please specify a prefix or suffix.";
                errorEl.classList.remove('hidden');
                return;
             }
             document.getElementById('submit-error').classList.add('hidden');
             // Check estimated time
             // Time (seconds) = (0.5 * 58^TotalLength) / 5,000,000
             let seconds = (0.5 * Math.pow(58, totalLen)) / 5000000;
             if (seconds > 3600) {
                 let timeStr;
                 if (seconds < 86400) timeStr = (seconds/3600).toFixed(1) + " hours";
                 else timeStr = (seconds/86400).toFixed(1) + " days";
                 if (!confirm(`This job may take ${timeStr}. Do you accept the wait and proceed?`)) {
                     return;
                 }
             }

             openNumpad('submit', 'Enter PIN to Forge', submitJob);
        }

        async function submitJob(pin) {
            const prefix = document.getElementById('prefix').value;
            const suffix = document.getElementById('suffix').value;
            const caseSensitive = document.getElementById('case-sensitive').checked;
            const notify = document.getElementById('email-notify').checked;
            const useGpu = true; // Always true

            const errorEl = document.getElementById('submit-error');
            const submitBtn = document.querySelector('button[onclick="startSubmissionFlow()"]');
            // Disable button
            submitBtn.disabled = true;

            // God Mode Check
            const isGodMode = ADMIN_EMAILS.includes(currentUserEmail);
            // Calculate Price & Check Payment
            const totalLen = prefix.length + suffix.length;
            // Fixed Pricing Logic
            let basePrice = 0;
            if (totalLen <= 4) basePrice = 0.25;
            else if (totalLen === 5) basePrice = 0.50;
            else if (totalLen === 6) basePrice = 1.00;
            else if (totalLen === 7) basePrice = 2.00;
            else if (totalLen === 8) basePrice = 3.00;
            else basePrice = 5.00;

            // No GPU Surcharge
            submitBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Initializing RedPanda Engine...';

            // Apply 50% Discount
            let cost = basePrice * 0.5;
            let isTrial = (totalLen <= 4 && userTrialsUsed < 2);
            let transactionSignature = null;
            // If trial, cost is 0
            if (isTrial) cost = 0;
            // God Mode Skips Payment
            if (!isGodMode && cost > 0) {
                 if (!window.solana || !window.solana.isConnected) {
                     if (window.solana) {
                         try {
                             await window.solana.connect();
                         } catch (err) {
                             submitBtn.disabled = false;
                             submitBtn.innerHTML = '<i class="fa-solid fa-rocket"></i> Forge';
                             alert("Wallet required for payment");
                             return;
                         }
                     } else {
                         submitBtn.disabled = false;
                         submitBtn.innerHTML = '<i class="fa-solid fa-rocket"></i> Forge';
                         alert("Phantom Wallet is required for payment.");
                         return;
                     }
                 }

                 try {

                     // 2. Build Transaction
                     const TREASURY_PUBKEY = new solanaWeb3.PublicKey(TREASURY_WALLET_ADDRESS);
                     const fromPubkey = window.solana.publicKey;

                     const transaction = new solanaWeb3.Transaction().add(
                         solanaWeb3.SystemProgram.transfer({
                             fromPubkey: fromPubkey,
                             toPubkey: TREASURY_PUBKEY,
                             lamports: Math.round(cost * solanaWeb3.LAMPORTS_PER_SOL)
                         })
                     );
                     transaction.feePayer = fromPubkey;
                     // Use the dedicated Helius endpoint
                     // The user will replace the placeholder with their actual URL
                     // UPDATED WITH USER KEY
                     const connection = new solanaWeb3.Connection(window.location.origin + "/api/rpc", "confirmed");
                     const { blockhash, lastValidBlockHeight } = await connection.getLatestBlockhash();
                     transaction.recentBlockhash = blockhash;
                     // 3. Sign and Send
                     const { signature } = await window.solana.signAndSendTransaction(transaction);
                     transactionSignature = signature;

                     // 4. Wait for Confirmation
                     submitBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Confirming Payment...';
                     await connection.confirmTransaction({
                         signature: signature,
                         blockhash: blockhash,
                         lastValidBlockHeight: lastValidBlockHeight
                     });

                 } catch (err) {
                     console.error(err);
                     submitBtn.disabled = false;
                     submitBtn.innerHTML = '<i class="fa-solid fa-rocket"></i> Forge';
                     errorEl.innerText = "Payment failed: " + err.message;
                     errorEl.classList.remove('hidden');
                     return;
                 }
            }

            const payload = {
                user_id: currentUser,
                prefix: prefix,
                suffix: suffix,
                case_sensitive: caseSensitive,
                pin: pin,
                transaction_signature: transactionSignature,
                email: currentUserEmail,
                notify: notify,
                use_gpu: useGpu,
                referral_code: document.getElementById('referral-code-input').value
            };
            try {
                const res = await fetch('/submit-job', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (res.ok) {
                    // Update trials locally for immediate feedback
                    if (isTrial) userTrialsUsed++;
                    // Success feedback
                    document.getElementById('prefix').value = '';
                    document.getElementById('suffix').value = '';
                    updateEstimates();
                } else {
                    const data = await res.json().catch(() => ({}));
                    throw new Error(data.message || data.error || "Submission failed.");
                }
            } catch (e) {
                errorEl.innerText = e.message;
                errorEl.classList.remove('hidden');
            } finally {
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i class="fa-solid fa-rocket"></i> Forge';
            }
        }

        // POLLING & UI
        function pollJobStatus() {
            if (jobListenerUnsubscribe) jobListenerUnsubscribe();
            const container = document.getElementById('jobs-container');
            const emptyState = document.getElementById('jobs-empty-state');

            jobListenerUnsubscribe = db.collection('vanity_jobs')
                .where('user_id', '==', currentUser)
                .orderBy('created_at', 'desc')
                .onSnapshot((snapshot) => {
                    if (snapshot.empty) {
                        container.innerHTML = '';
                        emptyState.classList.remove('hidden');
                        return;
                    }
                    emptyState.classList.add('hidden');

                    const fragment = document.createDocumentFragment();

                    snapshot.forEach(doc => {
                        const job = doc.data();
                        const status = (job.status || "").toUpperCase();

                        // Check if key is available
                        const secretKey = job.secret_key; // Encrypted

                        let statusColor = 'text-gray-400';
                        let statusIcon = '';
                        let resultHtml = '';

                        if (status === 'COMPLETED') {
                            statusColor = 'text-green-400';
                            statusIcon = '<i class="fa-solid fa-check-circle"></i>';

                            // Show Eye Icon and Copy Button
                            resultHtml = `
                                <div class="mt-2 bg-gray-900/50 p-2 rounded border border-gray-700/50">
                                    <div class="flex justify-between items-center mb-1">
                                        <span class="text-[10px] text-gray-500 uppercase font-bold tracking-wider">Public Key</span>
                                        <button onclick="copyToClipboard('${job.public_key}')" class="text-xs text-purple-400 hover:text-purple-300 transition-colors" title="Copy Public Key"><i class="fa-regular fa-copy"></i></button>
                                    </div>
                                    <div class="font-mono text-[10px] break-all text-gray-300 mb-2 bg-black/20 p-1 rounded">${job.public_key}</div>

                                    <div class="flex justify-between items-center mb-1">
                                        <span class="text-[10px] text-gray-500 uppercase font-bold tracking-wider">Private Key</span>
                                        <button onclick="openNumpad('reveal', 'Enter PIN to Unlock', revealKey, '${doc.id}')" id="btn-${doc.id}" class="text-xs text-purple-400 hover:text-purple-300 transition-colors uppercase font-bold" title="Reveal Private Key"><i class="fa-regular fa-eye"></i></button>
                                    </div>
                                    <div id="secret-${doc.id}" class="hidden flex items-start gap-2 animate-fade-in">
                                        <div id="key-text-${doc.id}" class="font-mono text-[10px] break-all text-red-300 bg-red-900/10 p-1 rounded border border-red-900/20 flex-grow">
                                            </div>
                                        <button onclick="copyKey('${doc.id}')" class="text-gray-400 hover:text-white pt-1 transition-colors" title="Copy Private Key"><i class="fa-regular fa-copy"></i></button>
                                    </div>
                                </div>
                            `;
                        } else if (status === 'FAILED') {
                            statusColor = 'text-red-400';
                            statusIcon = '<i class="fa-solid fa-times-circle"></i>';
                            resultHtml = `
                                <div class="mt-1 text-[10px] text-red-400 italic">
                                    ${escapeHtml(job.error || "Job failed.")}
                                </div>
                            `;
                        } else {
                            statusColor = 'text-yellow-400';
                            statusIcon = '<i class="fa-regular fa-clock animate-spin"></i>';
                        }

                        const tr = document.createElement('tr');
                        tr.className = "hover:bg-gray-800/50 transition-colors align-top";
                        tr.innerHTML = `
                            <td class="py-3 pr-2 border-b border-gray-800">
                                <div class="font-bold text-gray-200 font-mono text-sm break-all mb-1">
                                    ${job.prefix || '...'}-${job.suffix || '...'}
                                </div>
                                <div class="flex flex-wrap items-center gap-2">
                                     <span class="text-[10px] text-gray-500 font-mono">#${doc.id.slice(0, 8)}</span>
                                     ${job.case_sensitive ? '<span class="text-[10px] text-purple-400 border border-purple-500/30 bg-purple-500/10 px-1 rounded" title="Case Sensitive">Case</span>' : ''}
                                </div>
                            </td>
                            <td class="py-3 pr-2 border-b border-gray-800">
                                <span class="text-xs font-bold ${statusColor} capitalize flex items-center gap-1">
                                    ${statusIcon} ${job.status}
                                </span>
                            </td>
                            <td class="py-3 border-b border-gray-800">
                                ${resultHtml}
                            </td>
                        `;
                        fragment.appendChild(tr);
                    });

                    container.innerHTML = '';
                    container.appendChild(fragment);

                }, (error) => {
                    console.error("Error polling jobs:", error);
                    emptyState.innerText = 'Error connecting to job server.';
                    emptyState.classList.remove('hidden');
                });
        }

        function logout() {
            if (jobListenerUnsubscribe) jobListenerUnsubscribe();
            firebase.auth().signOut().then(() => {
                currentUser = null;
                currentUserEmail = null;
                document.getElementById('app-interface').classList.add('hidden');
                document.getElementById('job-queue-section').classList.add('hidden');
                document.getElementById('auth-section').classList.remove('hidden');
                // Hide mobile menu if open
                const mobileMenu = document.getElementById('mobile-menu');
                if (mobileMenu && !mobileMenu.classList.contains('hidden')) {
                    mobileMenu.classList.add('hidden');
                }
                const titleSpan = document.querySelector('nav .text-purple-500');
                if (titleSpan) titleSpan.innerHTML = '<i class="fa-solid fa-fire-flame-curved"></i> VanityForge';
            }).catch((error) => {
                console.error("Sign Out Error", error);
            });
        }

        async function revealKey(jobId, pin) {
            try {
                const res = await fetch('/reveal-key', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ job_id: jobId, pin: pin })
                });
                const data = await res.json();

                if (res.ok) {
                    const el = document.getElementById(`secret-${jobId}`);
                    const btn = document.getElementById(`btn-${jobId}`);
                    const keyText = document.getElementById(`key-text-${jobId}`);

                    keyText.innerText = data.secret_key;
                    el.classList.remove('hidden');
                    btn.innerHTML = '<i class="fa-regular fa-eye-slash"></i>';
                    btn.onclick = () => {
                         el.classList.add('hidden');
                         btn.innerHTML = '<i class="fa-regular fa-eye"></i>';
                         keyText.innerText = '';
                         // Reset onclick
                         btn.onclick = () => openNumpad('reveal', 'Enter PIN to Unlock', revealKey, jobId);
                    };
                } else {
                    alert(data.error || "Failed to reveal key.");
                }
            } catch (e) {
                console.error(e);
                alert("Error revealing key.");
            }
        }

        function copyKey(id) {
            const text = document.getElementById(`key-text-${id}`).innerText;
            copyToClipboard(text);
        }

        function copyReferralCode() {
            const code = document.getElementById('my-ref-code').innerText;
            copyToClipboard(code);
        }

        function copyReferralLink() {
            const code = document.getElementById('my-ref-code').innerText;
            const link = window.location.origin + "/?ref=" + code;
            copyToClipboard(link);
        }

        function copyToClipboard(text) {
            if (!text || text === '----') return;
            // Visual Feedback Function
            const showFeedback = () => {
                const activeEl = document.activeElement;
                if(activeEl && (activeEl.tagName === 'BUTTON' || activeEl.closest('button'))) {
                    const btn = activeEl.tagName === 'BUTTON' ? activeEl : activeEl.closest('button');
                    const icon = btn.querySelector('i');
                    if(icon) {
                        const originalClass = icon.className;
                        // Determine correct icon based on button type
                        const isLinkBtn = btn.innerText.includes("Link");

                        icon.className = "fa-solid fa-check text-green-400";

                        // Tooltip logic
                        let tooltip = document.createElement("span");
                        tooltip.className = "absolute -top-8 left-1/2 transform -translate-x-1/2 bg-gray-900 text-white text-xs px-2 py-1 rounded shadow-lg animate-fade-in-up z-50 border border-gray-700 whitespace-nowrap";
                        tooltip.innerText = "Copied!";
                        btn.style.position = "relative";
                        btn.appendChild(tooltip);

                        setTimeout(() => {
                            // Restore icon
                            if (isLinkBtn) icon.className = "fa-solid fa-link";
                            else icon.className = "fa-regular fa-copy";

                            if(tooltip) tooltip.remove();
                        }, 2000);
                    }
                }
            };
            if (navigator.clipboard && window.isSecureContext) {
                // Secure context (HTTPS)
                navigator.clipboard.writeText(text).then(showFeedback).catch(err => {
                    console.error('Failed to copy via Clipboard API: ', err);
                    fallbackCopy(text, showFeedback);
                });
            } else {
                // Non-secure context (HTTP)
                fallbackCopy(text, showFeedback);
            }
        }

        function fallbackCopy(text, successCallback) {
            const textArea = document.createElement("textarea");
            textArea.value = text;
            textArea.style.position = "fixed";
            textArea.style.left = "-9999px";
            textArea.style.top = "0";
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            try {
                const successful = document.execCommand('copy');
                if (successful) {
                    successCallback();
                } else {
                    prompt("Copy to clipboard: Ctrl+C, Enter", text);
                }
            } catch (err) {
                console.error('Fallback copy failed', err);
                prompt("Copy to clipboard: Ctrl+C, Enter", text);
            }

            document.body.removeChild(textArea);
        }

        // Global assignments
        window.loginWithGoogle = loginWithGoogle;
        window.connectWallet = connectWallet;
        window.startSubmissionFlow = startSubmissionFlow;
        window.submitJob = submitJob;
        window.revealKey = revealKey;
        window.copyToClipboard = copyToClipboard;
        window.copyKey = copyKey;
        window.numpadInput = numpadInput;
        window.numpadClear = numpadClear;
        window.numpadSubmit = numpadSubmit;
        window.closeNumpad = closeNumpad;
    </script>
    <script src="vanity.js"></script>
</body>
</html>


======================================================================
FILE: roadmap.html
======================================================================
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/png" href="favicon.png">
    <title>VanityForge - Roadmap</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body { background-color: #1a1a1a; color: #e0e0e0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; padding-top: 80px; }
        .glass-panel { background: rgba(40, 40, 40, 0.7); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.1); }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center px-4">

    <!-- Navigation Bar -->
    <nav class="fixed top-0 left-0 w-full z-50 glass-panel border-b border-gray-700/50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <span class="text-purple-500 font-bold text-xl tracking-wider uppercase"><i class="fa-solid fa-fire-flame-curved"></i> VanityForge</span>
                    </div>
                    <div class="hidden md:block">
                        <div class="ml-10 flex items-baseline space-x-4">
                            <a href="/" class="text-gray-300 hover:text-white hover:bg-gray-700 px-3 py-2 rounded-md text-sm font-medium transition-colors">Forge</a>
                            <a href="/vvvip" class="text-gray-300 hover:text-white hover:bg-gray-700 px-3 py-2 rounded-md text-sm font-medium transition-colors">VVVIP Addresses</a>
                            <a href="/roadmap" class="text-white bg-gray-900 px-3 py-2 rounded-md text-sm font-medium transition-colors">Roadmap</a>
                            <a href="/faq" class="text-gray-300 hover:text-white hover:bg-gray-700 px-3 py-2 rounded-md text-sm font-medium transition-colors">FAQ</a>
                            <a href="https://x.com/vanityforgeX" target="_blank" class="text-gray-300 hover:text-white hover:bg-gray-700 px-3 py-2 rounded-md text-sm font-medium transition-colors"><i class="fa-brands fa-x-twitter"></i></a>
                            <a href="https://github.com/TomaAytakin/VanityForge" target="_blank" class="text-gray-300 hover:text-white hover:bg-gray-700 px-3 py-2 rounded-md text-sm font-medium transition-colors"><i class="fa-brands fa-github"></i> GitHub</a>
                        </div>
                    </div>
                </div>
                <div class="-mr-2 flex md:hidden">
                    <button type="button" onclick="document.getElementById('mobile-menu').classList.toggle('hidden')" class="bg-gray-800 inline-flex items-center justify-center p-2 rounded-md text-gray-400 hover:text-white hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-gray-800 focus:ring-white">
                        <span class="sr-only">Open main menu</span>
                        <i class="fa-solid fa-bars"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- Mobile menu, show/hide based on menu state. -->
        <div class="hidden md:hidden" id="mobile-menu">
            <div class="px-2 pt-2 pb-3 space-y-1 sm:px-3">
                <a href="/" class="text-gray-300 hover:text-white block px-3 py-2 rounded-md text-base font-medium">Forge</a>
                <a href="/vvvip" class="text-gray-300 hover:text-white block px-3 py-2 rounded-md text-base font-medium">VVVIP Addresses</a>
                <a href="/roadmap" class="text-white bg-gray-900 block px-3 py-2 rounded-md text-base font-medium">Roadmap</a>
                <a href="/faq" class="text-gray-300 hover:text-white block px-3 py-2 rounded-md text-base font-medium">FAQ</a>
                <a href="https://x.com/vanityforgeX" target="_blank" class="text-gray-300 hover:text-white block px-3 py-2 rounded-md text-base font-medium"><i class="fa-brands fa-x-twitter"></i> X (Twitter)</a>
                <a href="https://github.com/TomaAytakin/VanityForge" target="_blank" class="text-gray-300 hover:text-white block px-3 py-2 rounded-md text-base font-medium">GitHub</a>
            </div>
        </div>
    </nav>

    <div class="w-full max-w-4xl mt-10 mb-20">
        <h1 class="text-4xl font-bold text-center mb-10 text-transparent bg-clip-text bg-gradient-to-r from-purple-400 to-pink-600">Project Roadmap</h1>

        <div class="space-y-8 relative before:absolute before:inset-0 before:ml-5 before:-translate-x-px md:before:mx-auto md:before:translate-x-0 before:h-full before:w-0.5 before:bg-gradient-to-b before:from-transparent before:via-slate-300 before:to-transparent">

            <!-- Phase 1 -->
            <div class="relative flex items-center justify-between md:justify-normal md:odd:flex-row-reverse group is-active">
                <div class="flex items-center justify-center w-10 h-10 rounded-full border border-white bg-slate-300 group-[.is-active]:bg-purple-500 text-slate-500 group-[.is-active]:text-slate-100 shadow shrink-0 md:order-1 md:group-odd:-translate-x-1/2 md:group-even:translate-x-1/2 z-10">
                    <i class="fa-solid fa-check"></i>
                </div>
                <div class="w-[calc(100%-4rem)] md:w-[calc(50%-2.5rem)] glass-panel p-6 rounded-xl shadow-lg hover:shadow-2xl transition-all duration-300 border-l-4 border-l-purple-500">
                    <div class="flex items-center justify-between space-x-2 mb-1">
                        <div class="font-bold text-slate-200">Phase 1: Completed (Q4 2025) ‚úÖ</div>
                    </div>
                    <div class="text-slate-400">
                        <ul class="list-disc pl-5 space-y-2">
                            <li class="line-through decoration-green-500">Deploy Backend to Google Cloud VM</li>
                            <li class="line-through decoration-green-500">Integrate Google Cloud Run for Worker Autoscaling</li>
                            <li class="line-through decoration-green-500">Develop CUDA GPU Miner (solanity-gpu)</li>
                            <li class="line-through decoration-green-500">Launch Referral System (30% Revenue Share)</li>
                            <li class="line-through decoration-green-500">Implement Payment Verification (Solana Pay/RPC)</li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- Phase 2 -->
            <div class="relative flex items-center justify-between md:justify-normal md:odd:flex-row-reverse group">
                <div class="flex items-center justify-center w-10 h-10 rounded-full border border-white bg-slate-300 text-slate-500 shadow shrink-0 md:order-1 md:group-odd:-translate-x-1/2 md:group-even:translate-x-1/2 z-10">
                    <i class="fa-solid fa-spinner fa-spin"></i>
                </div>
                <div class="w-[calc(100%-4rem)] md:w-[calc(50%-2.5rem)] glass-panel p-6 rounded-xl shadow-lg hover:shadow-2xl transition-all duration-300 border-l-4 border-l-blue-500">
                    <div class="flex items-center justify-between space-x-2 mb-1">
                        <div class="font-bold text-slate-200">Phase 2: In Progress / Q1 2026 üöß</div>
                    </div>
                    <div class="text-slate-400">
                         <ul class="list-disc pl-5 space-y-2">
                            <li class="line-through decoration-red-500">Rust CPU Miner (cpu-grinder)</li>
                            <li><span class="text-green-400 font-bold">[Live]</span> Phase 3: 100% L4 GPU Transition</li>
                            <li>Mobile UI Optimization</li>
                            <li>Public API for Developers</li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- Phase 3 -->
            <div class="relative flex items-center justify-between md:justify-normal md:odd:flex-row-reverse group">
                <div class="flex items-center justify-center w-10 h-10 rounded-full border border-white bg-slate-300 text-slate-500 shadow shrink-0 md:order-1 md:group-odd:-translate-x-1/2 md:group-even:translate-x-1/2 z-10">
                    <i class="fa-solid fa-rocket"></i>
                </div>
                <div class="w-[calc(100%-4rem)] md:w-[calc(50%-2.5rem)] glass-panel p-6 rounded-xl shadow-lg hover:shadow-2xl transition-all duration-300 border-l-4 border-l-orange-500">
                    <div class="flex items-center justify-between space-x-2 mb-1">
                        <div class="font-bold text-slate-200">Phase 3: The Singularity (FUTURE üîÆ)</div>
                    </div>
                    <div class="text-slate-400">
                         <ul class="list-disc pl-5 space-y-2">
                            <li class="line-through decoration-green-500">RedPanda Engine: Migrate to NVIDIA CUDA cores</li>
                            <li>Instant Forge: Sub-minute delivery for 7-character vanity addresses</li>
                            <li>Dao Governance: $VFORGE holders vote on fee structures and new features</li>
                        </ul>
                    </div>
                </div>
            </div>

        </div>
    </div>
</body>
</html>

======================================================================
FILE: faq.html
======================================================================
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/png" href="favicon.png">
    <title>VanityForge - FAQ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body { background-color: #1a1a1a; color: #e0e0e0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; padding-top: 80px; }
        .glass-panel { background: rgba(40, 40, 40, 0.7); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.1); }
        details > summary { list-style: none; }
        details > summary::-webkit-details-marker { display: none; }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center px-4">

    <!-- Navigation Bar -->
    <nav class="fixed top-0 left-0 w-full z-50 glass-panel border-b border-gray-700/50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <span class="text-purple-500 font-bold text-xl tracking-wider uppercase"><i class="fa-solid fa-fire-flame-curved"></i> VanityForge</span>
                    </div>
                    <div class="hidden md:block">
                        <div class="ml-10 flex items-baseline space-x-4">
                            <a href="/" class="text-gray-300 hover:text-white hover:bg-gray-700 px-3 py-2 rounded-md text-sm font-medium transition-colors">Forge</a>
                            <a href="/vvvip" class="text-gray-300 hover:text-white hover:bg-gray-700 px-3 py-2 rounded-md text-sm font-medium transition-colors">VVVIP Addresses</a>
                            <a href="/roadmap" class="text-gray-300 hover:text-white hover:bg-gray-700 px-3 py-2 rounded-md text-sm font-medium transition-colors">Roadmap</a>
                            <a href="/faq" class="text-white bg-gray-900 px-3 py-2 rounded-md text-sm font-medium transition-colors">FAQ</a>
                            <a href="https://x.com/vanityforgeX" target="_blank" class="text-gray-300 hover:text-white hover:bg-gray-700 px-3 py-2 rounded-md text-sm font-medium transition-colors"><i class="fa-brands fa-x-twitter"></i></a>
                            <a href="https://github.com/TomaAytakin/VanityForge" target="_blank" class="text-gray-300 hover:text-white hover:bg-gray-700 px-3 py-2 rounded-md text-sm font-medium transition-colors"><i class="fa-brands fa-github"></i> GitHub</a>
                        </div>
                    </div>
                </div>
                <div class="-mr-2 flex md:hidden">
                    <button type="button" onclick="document.getElementById('mobile-menu').classList.toggle('hidden')" class="bg-gray-800 inline-flex items-center justify-center p-2 rounded-md text-gray-400 hover:text-white hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-gray-800 focus:ring-white">
                        <span class="sr-only">Open main menu</span>
                        <i class="fa-solid fa-bars"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- Mobile menu, show/hide based on menu state. -->
        <div class="hidden md:hidden" id="mobile-menu">
            <div class="px-2 pt-2 pb-3 space-y-1 sm:px-3">
                <a href="/" class="text-gray-300 hover:text-white block px-3 py-2 rounded-md text-base font-medium">Forge</a>
                <a href="/vvvip" class="text-gray-300 hover:text-white block px-3 py-2 rounded-md text-base font-medium">VVVIP Addresses</a>
                <a href="/roadmap" class="text-gray-300 hover:text-white block px-3 py-2 rounded-md text-base font-medium">Roadmap</a>
                <a href="/faq" class="text-white bg-gray-900 block px-3 py-2 rounded-md text-base font-medium">FAQ</a>
                <a href="https://x.com/vanityforgeX" target="_blank" class="text-gray-300 hover:text-white block px-3 py-2 rounded-md text-base font-medium"><i class="fa-brands fa-x-twitter"></i> X (Twitter)</a>
                <a href="https://github.com/TomaAytakin/VanityForge" target="_blank" class="text-gray-300 hover:text-white block px-3 py-2 rounded-md text-base font-medium">GitHub</a>
            </div>
        </div>
    </nav>

    <div class="w-full max-w-3xl mt-10 mb-20">
        <h1 class="text-4xl font-bold text-center mb-10 text-transparent bg-clip-text bg-gradient-to-r from-purple-400 to-pink-600">Frequently Asked Questions</h1>

        <div class="space-y-4">
            <!-- Questions generated via script -->
        </div>
    </div>
    <script>
         const faqs = [
            {q: "My Private Key isn't working in Phantom!", a: "We fixed this! We now generate keys in the standard 64-byte Keypair format compatible with Phantom, Solflare, and Backpack. Just import the Base58 string directly."},
            {q: "What is VanityForge?", a: "A high-performance cloud tool to generate custom Solana wallet addresses starting with specific characters."},
            {q: "Is it safe?", a: "Yes. We use Client-Side Encryption. We never see your raw private key; it is encrypted with your PIN before it hits our database."},
            {q: "Why is there only one speed?", a: "We upgraded everyone to Enterprise GPU class automatically. All jobs now run on our CPU Worker Cluster (NVIDIA L4) for maximum performance."},
            {q: "Why does the estimate say 10 minutes?", a: "This accounts for secure cloud provisioning and cold-boot times. We spin up a fresh, isolated container for your job to ensure security, which takes a few minutes to initialize."},
            {q: "How do Referrals work?", a: "Create a code in the 'Referrals' tab. Share your link. You earn 30% of the 0.1 SOL fee for every paid job that uses your link. Payouts are automated."},
            {q: "Do you store my Private Key?", a: "We store an encrypted blob that is mathematically impossible to read without your PIN."},
            {q: "What is the PIN for?", a: "It is your personal decryption key. It unlocks your vault."},
            {q: "What if I lose my PIN?", a: "Your wallet is lost forever. We cannot recover it. This is a security feature, not a bug."},
            {q: "Can I close the browser tab?", a: "Yes! Our servers run 24/7. You can come back days later to check your job."},
            {q: "Why can't I use '0', 'O', 'I', or 'l'?", a: "Solana uses Base58 encoding, which excludes these characters to prevent visual confusion."},
            {q: "How long does it take?", a: "4 characters is instant. 5 characters takes minutes. 6 characters takes hours."},
            {q: "Can I generate two wallets at once?", a: "Currently, we limit users to one active job to ensure fairness."},
            {q: "Is it free?", a: "Currently yes, during our Beta phase."},
            {q: "How do I pay in the future?", a: "We will integrate PUMP-APP tokens for premium speed tiers."},
            {q: "What is \"Dev Mode\"?", a: "A testing sandbox for our developers."},
            {q: "Can I use Google Login?", a: "Yes, for users who don't have a wallet extension installed yet."},
            {q: "Is the code open source?", a: "Parts of our client are verifiable, but our grinding engine is proprietary."},
            {q: "Do you support Ethereum?", a: "Not yet. We are Solana-first."},
            {q: "Does it run on my computer?", a: "No, it runs on our dedicated cloud hardware, saving your battery."},
            {q: "Who are the developers?", a: "We are a team of privacy-focused crypto engineers."},
            {q: "How do I contact support?", a: "Reach out via our official X (Twitter) handle."}
         ];

         const container = document.querySelector('.space-y-4');
         faqs.forEach(item => {
             const details = document.createElement('details');
             details.className = "glass-panel rounded-lg group open:ring-1 open:ring-purple-500/50";
             details.innerHTML = `
                <summary class="flex cursor-pointer items-center justify-between p-6 font-medium text-slate-200">
                    <span>${item.q}</span>
                    <span class="transition group-open:rotate-180 text-purple-400">
                        <i class="fa-solid fa-chevron-down"></i>
                    </span>
                </summary>
                <div class="px-6 pb-6 text-slate-400 border-t border-gray-700/50 pt-4">
                    ${item.a}
                </div>
             `;
             container.appendChild(details);
         });
    </script>
</body>
</html>

======================================================================
FILE: vvvip.html
======================================================================
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/png" href="favicon.png">
    <title>VVVIP Addresses - VanityForge</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://bundle.run/buffer@6.0.3"></script>
    <script>
      if (!window.Buffer && window.buffer) {
        window.Buffer = window.buffer.Buffer;
      }
    </script>
    <script>
        // Inject RPC URL from Flask
        window.SOLANA_RPC = {{ rpc_url|tojson }};
    </script>
    <script type="module" src="utils/sns.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body { background-color: #1a1a1a; color: #e0e0e0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; padding-top: 80px; }
        .glass-panel { background: rgba(40, 40, 40, 0.7); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.1); }
        /* Custom scrollbar for better aesthetics */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1a1a1a; }
        ::-webkit-scrollbar-thumb { background: #4a4a4a; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #6a6a6a; }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center px-4">

    <nav class="fixed top-0 left-0 w-full z-50 glass-panel border-b border-gray-700/50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <span class="text-purple-500 font-bold text-xl tracking-wider uppercase"><i class="fa-solid fa-fire-flame-curved"></i> VanityForge</span>
                    </div>
                    <div class="hidden md:block">
                        <div class="ml-10 flex items-baseline space-x-4">
                            <a href="/" class="text-gray-300 hover:text-white hover:bg-gray-700 px-3 py-2 rounded-md text-sm font-medium transition-colors">Forge</a>
                            <a href="/vvvip" class="text-white bg-gray-900 px-3 py-2 rounded-md text-sm font-medium transition-colors">VVVIP Addresses</a>
                            <a href="/roadmap" class="text-gray-300 hover:text-white hover:bg-gray-700 px-3 py-2 rounded-md text-sm font-medium transition-colors">Roadmap</a>
                            <a href="/faq" class="text-gray-300 hover:text-white hover:bg-gray-700 px-3 py-2 rounded-md text-sm font-medium transition-colors">FAQ</a>
                            <a href="https://x.com/vanityforgeX" target="_blank" class="text-gray-300 hover:text-white hover:bg-gray-700 px-3 py-2 rounded-md text-sm font-medium transition-colors"><i class="fa-brands fa-x-twitter"></i></a>
                            <a href="https://github.com/TomaAytakin/VanityForge" target="_blank" class="text-gray-300 hover:text-white hover:bg-gray-700 px-3 py-2 rounded-md text-sm font-medium transition-colors"><i class="fa-brands fa-github"></i> GitHub</a>
                        </div>
                    </div>
                </div>
                <div class="-mr-2 flex md:hidden">
                    <button type="button" onclick="document.getElementById('mobile-menu').classList.toggle('hidden')" class="bg-gray-800 inline-flex items-center justify-center p-2 rounded-md text-gray-400 hover:text-white hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-gray-800 focus:ring-white">
                        <span class="sr-only">Open main menu</span>
                        <i class="fa-solid fa-bars"></i>
                    </button>
                </div>
            </div>
        </div>

        <div class="hidden md:hidden" id="mobile-menu">
            <div class="px-2 pt-2 pb-3 space-y-1 sm:px-3">
                <a href="/" class="text-gray-300 hover:text-white block px-3 py-2 rounded-md text-base font-medium">Forge</a>
                <a href="/vvvip" class="text-white bg-gray-900 block px-3 py-2 rounded-md text-base font-medium">VVVIP Addresses</a>
                <a href="/roadmap" class="text-gray-300 hover:text-white block px-3 py-2 rounded-md text-base font-medium">Roadmap</a>
                <a href="/faq" class="text-gray-300 hover:text-white block px-3 py-2 rounded-md text-base font-medium">FAQ</a>
                <a href="https://x.com/vanityforgeX" target="_blank" class="text-gray-300 hover:text-white block px-3 py-2 rounded-md text-base font-medium"><i class="fa-brands fa-x-twitter"></i> X (Twitter)</a>
                <a href="https://github.com/TomaAytakin/VanityForge" target="_blank" class="text-gray-300 hover:text-white block px-3 py-2 rounded-md text-base font-medium">GitHub</a>
            </div>
        </div>
    </nav>

    <div class="w-full max-w-2xl mb-8 flex justify-center mt-10">
        <h1 class="text-4xl font-bold text-center bg-clip-text text-transparent bg-gradient-to-r from-blue-400 to-green-400">
            VVVIP Addresses
        </h1>
    </div>

    <!-- WALLET CONNECTION FOR BUYING -->
    <div class="w-full max-w-2xl flex justify-center mb-6">
        <button id="connect-phantom-btn" onclick="connectWallet()" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-6 rounded-lg transition duration-200 flex items-center justify-center gap-2 shadow-md">
             <i class="fa-solid fa-wallet"></i> <span id="wallet-btn-text">Connect Wallet</span>
        </button>
    </div>

    <div id="app-interface" class="w-full max-w-2xl space-y-6 animate-fade-in-up">

        <!-- SNS Checker Section -->
        <div class="glass-panel p-8 rounded-xl shadow-lg relative overflow-hidden">
            <div class="absolute top-0 right-0 p-4 opacity-10">
                <i class="fa-solid fa-search text-6xl text-blue-500"></i>
            </div>
            <h2 class="text-xl font-bold mb-4 text-blue-400 flex items-center gap-2">
                <i class="fa-solid fa-globe"></i> Claim Your .sol Username
            </h2>
            <p class="text-sm text-gray-400 mb-4">
                Stop using long, ugly addresses. Turn 'HN7c...' into 'yourname.sol' instantly. It's like a username for your crypto wallet.
            </p>
            <div class="flex gap-2 items-center mb-4">
                <div class="flex-grow">
                    <div class="relative">
                        <input type="text" id="sns-domain-input" class="w-full bg-gray-800 border border-gray-700 rounded p-3 pl-4 focus:border-blue-500 focus:outline-none text-white font-mono placeholder-gray-600" placeholder="yourname">
                        <span class="absolute right-3 top-3 text-gray-500 font-mono">.sol</span>
                    </div>
                </div>
                <button onclick="checkSNS()" id="sns-check-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg shadow-lg transition transform hover:scale-105">
                    Search
                </button>
            </div>
            <div id="sns-result" class="hidden rounded-lg p-4 flex justify-between items-center animate-fade-in">
                <!-- Result injected here -->
            </div>
        </div>

        <!-- Benefits Grid Section -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <!-- Card 1 -->
            <div class="glass-panel p-6 rounded-xl flex flex-col items-center text-center">
                <i class="fa-solid fa-id-card text-3xl text-blue-400 mb-3"></i>
                <h3 class="font-bold text-lg mb-2">Your Web3 Profile</h3>
                <p class="text-sm text-gray-400">Ditch the random numbers. Make your wallet recognizable on Solscan, Phantom, and leaderboards.</p>
            </div>
            <!-- Card 2 -->
            <div class="glass-panel p-6 rounded-xl flex flex-col items-center text-center">
                <i class="fa-solid fa-money-bill-transfer text-3xl text-green-400 mb-3"></i>
                <h3 class="font-bold text-lg mb-2">Stress-Free Payments</h3>
                <p class="text-sm text-gray-400">Never panic about copy-pasting wrong addresses again. Just tell friends to send to 'you.sol'.</p>
            </div>
            <!-- Card 3 -->
            <div class="glass-panel p-6 rounded-xl flex flex-col items-center text-center">
                <i class="fa-solid fa-globe text-3xl text-purple-400 mb-3"></i>
                <h3 class="font-bold text-lg mb-2">Works Everywhere</h3>
                <p class="text-sm text-gray-400">Native support on all major Solana wallets (Phantom, Solflare, Backpack) and apps.</p>
            </div>
            <!-- Card 4 -->
            <div class="glass-panel p-6 rounded-xl flex flex-col items-center text-center">
                <i class="fa-solid fa-shield-halved text-3xl text-yellow-400 mb-3"></i>
                <h3 class="font-bold text-lg mb-2">100% Owned by You</h3>
                <p class="text-sm text-gray-400">Your name is an on-chain asset (NFT). You have full control to keep it, sell it, or trade it.</p>
            </div>
        </div>

    </div>

    <script>
        async function connectWallet() {
            const provider = window.solana;

            if (!provider || !provider.isPhantom) {
                window.open("https://phantom.app/", "_blank");
                return;
            }

            try {
                // HARD RESET: clear any cached Phantom state
                if (provider.isConnected) {
                    await provider.disconnect();
                    await new Promise(r => setTimeout(r, 500));
                }

                // SAFETY: double-check disconnect completed
                if (provider.isConnected) {
                    await provider.disconnect();
                }

                // FORCE ACCOUNT SELECTOR
                const resp = await provider.connect({ onlyIfTrusted: false });

                window.walletAddress = resp.publicKey.toString();

                const btnText = document.getElementById('wallet-btn-text');
                if (btnText) {
                    btnText.innerText =
                        window.walletAddress.slice(0, 4) +
                        '...' +
                        window.walletAddress.slice(-4);
                }

            } catch (err) {
                console.error("Wallet connect error:", err);
            }
        }

        // Functions checkSNS and buyDomain are now in utils/sns.js
    </script>
</body>
</html>


======================================================================
FILE: vanity.js
======================================================================
document.addEventListener('DOMContentLoaded', () => {
    initLiveActivityCounter();
    checkAdmin();
});

function initLiveActivityCounter() {
    const counterElement = document.getElementById('identity-counter');
    const gearIcon = document.getElementById('activity-gear');

    if (!counterElement || !gearIcon) return;

    const START_DATE = new Date("2024-12-01T00:00:00Z");
    const BASE_COUNT = 4242;
    const DAILY_RATE = 45;

    function getDeterministicCount() {
        const now = new Date();
        const diffTime = now.getTime() - START_DATE.getTime();
        // Convert milliseconds to days
        const daysElapsed = diffTime / (1000 * 3600 * 24);

        // Micro-jitter: based on current UTC hour
        const currentHour = now.getUTCHours();
        const jitter = (currentHour * 7) % 13;

        // Calculate total
        const count = Math.floor(BASE_COUNT + (daysElapsed * DAILY_RATE) + jitter);
        return count;
    }

    let currentCount = getDeterministicCount();

    function updateDisplay(count) {
        // Format with commas
        counterElement.innerText = count.toLocaleString();
    }

    // Initial display
    updateDisplay(currentCount);

    // Live Pulse Logic
    function scheduleNextPulse() {
        // Random delay between 10s (10000ms) and 30s (30000ms)
        const delay = Math.floor(Math.random() * (30000 - 10000 + 1) + 10000);
        setTimeout(() => {
            pulse();
        }, delay);
    }

    function pulse() {
        currentCount++;
        updateDisplay(currentCount);

        // Speed up gear
        gearIcon.classList.add('gear-fast');
        setTimeout(() => {
            gearIcon.classList.remove('gear-fast');
        }, 2000); // Spin fast for 2 seconds

        scheduleNextPulse();
    }

    // Start the loop
    scheduleNextPulse();
}

// --- GOD MODE / ADMIN DASHBOARD LOGIC ---
async function checkAdmin() {
    try {
        const res = await fetch('/api/user-status');
        const data = await res.json();

        if (data.isAdmin) {
            // 2. Inject Navbar Item
            const navContainer = document.querySelector('nav .md\\:block .ml-10');
            if (navContainer && !document.getElementById('nav-dev')) {
                const devBtn = document.createElement('a');
                devBtn.href = "#";
                devBtn.id = "nav-dev";
                devBtn.onclick = (e) => { e.preventDefault(); toggleAdminDashboard(); };
                devBtn.className = "text-yellow-400 hover:text-white hover:bg-yellow-900/20 px-3 py-2 rounded-md text-sm font-bold transition-colors animate-pulse";
                devBtn.innerHTML = '<i class="fa-solid fa-bolt"></i> DEV';
                navContainer.appendChild(devBtn);
            }

            // Bind to "GOD MODE ACTIVE" text if present (for mobile/alternate access)
            setTimeout(() => {
                const spans = document.getElementsByTagName('span');
                for (let span of spans) {
                    if (span.innerText.includes('God Mode Active')) {
                        span.style.cursor = 'pointer';
                        span.onclick = toggleAdminDashboard;
                    }
                }
            }, 2000); // Wait for UI to settle
        }
    } catch (e) {
        console.error("Admin check failed", e);
    }
}

function toggleAdminDashboard() {
    const dash = document.getElementById('admin-dashboard');
    if (dash && !dash.classList.contains('hidden')) {
        // Close it
        dash.classList.add('hidden');
        document.getElementById('app-interface').classList.remove('hidden'); // Ensure app is visible
        document.getElementById('job-queue-section').classList.remove('hidden');
        document.getElementById('forge-section').classList.remove('hidden');
    } else {
        openAdminDashboard();
    }
}

async function openAdminDashboard() {
    // Reveal parent container if needed (God Mode Bypass)
    const appInterface = document.getElementById('app-interface');
    if (appInterface.classList.contains('hidden')) {
        document.getElementById('auth-section').classList.add('hidden');
        appInterface.classList.remove('hidden');
    }

    // Hide others
    const sections = ['forge-section', 'referral-dashboard', 'job-queue-section'];
    sections.forEach(id => {
        const el = document.getElementById(id);
        if (el) el.classList.add('hidden');
    });

    const dash = document.getElementById('admin-dashboard');
    if (dash) dash.classList.remove('hidden');

    // Fetch Initial Stats
    showAdminTab('financials');
}

window.showAdminTab = async function(tabName) {
    const tabs = ['financials', 'security', 'referrals-admin'];
    tabs.forEach(t => {
        const el = document.getElementById(`admin-${t}`);
        if(el) {
            if (t === tabName) el.classList.remove('hidden');
            else el.classList.add('hidden');
        }
    });

    if (tabName === 'financials') {
        try {
            const res = await fetch('/api/admin/stats');
            const data = await res.json();
            if (data.error) return alert("Auth Failed");
            document.getElementById('admin-inc-1w').innerText = data.income_1w + " SOL";
            document.getElementById('admin-inc-1m').innerText = data.income_1m + " SOL";
            document.getElementById('admin-users').innerText = data.total_users;
        } catch(e) { console.error(e); }
    } else if (tabName === 'security') {
        try {
            const res = await fetch('/api/admin/security');
            const data = await res.json();
            const logDiv = document.getElementById('admin-sec-logs');
            logDiv.innerHTML = data.map(l => `<div>[${l.time}] <strong>${l.ip}</strong>: ${l.reason}</div>`).join('');
        } catch(e) { console.error(e); }
    } else if (tabName === 'referrals-admin') {
         try {
            const res = await fetch('/api/admin/referrals');
            const data = await res.json();
            const listDiv = document.getElementById('admin-ref-list');
            listDiv.innerHTML = data.map(r => `
                <div class="flex justify-between bg-gray-800 p-2 rounded text-xs">
                    <span class="font-mono text-purple-400">${r.code}</span>
                    <span class="text-green-400">${r.earnings} SOL</span>
                </div>
            `).join('');
        } catch(e) { console.error(e); }
    }
};


======================================================================
FILE: utils/sns.js
======================================================================
// utils/sns.js

// Imports from ESM.sh as requested
import { Connection, PublicKey, Transaction, Keypair, SystemProgram, TransactionInstruction, SYSVAR_RENT_PUBKEY, LAMPORTS_PER_SOL } from "https://esm.sh/@solana/web3.js@1.78.0";
import { registerDomainName, getDomainKey as getDomainKeySDK } from "https://esm.sh/@bonfida/spl-name-service@0.2.4";
import { getAssociatedTokenAddress } from "https://esm.sh/@solana/spl-token@0.3.8";

// Constants
const SNS_PROGRAM_ID = new PublicKey('namesLPneVptA9Z5rqUDD9tMTWEJwofgaYwp8cawRkX');
const ROOT_DOMAIN_ACCOUNT = new PublicKey('58PwtjSDuFHuUkYjH9BYnnQKHfwo9reZhC2zMJv9JPkx');
const WRAPPED_SOL_MINT = new PublicKey('So11111111111111111111111111111111111111112');
const TOKEN_PROGRAM_ID = new PublicKey('TokenkegQfeZyiNwAJbNbGKPFXCWuBvf9Ss623VQ5DA');
const HASH_PREFIX = 'SPL Name Service';
const REFERRER_KEY = new PublicKey("CUfjsGUee8u83dfFxHt1jXJUCRLiF1KoWVYcKyVforGe");

// Helper to hash the name with the prefix (Manual implementation if not using SDK for this)
async function getHashedName(name) {
    const input = HASH_PREFIX + name;
    const encoder = new TextEncoder();
    const data = encoder.encode(input);
    const hashBuffer = await crypto.subtle.digest('SHA-256', data);
    return new Uint8Array(hashBuffer);
}

// We can use the SDK's getDomainKey if available, or our manual one.
// SDK 0.2.4 exports getDomainKey.
async function getDomainKey(domainName) {
    let name = domainName;
    if (name.endsWith('.sol')) {
        name = name.slice(0, -4);
    }
    // Using SDK implementation if possible, else manual fallback
    if (getDomainKeySDK) {
        return await getDomainKeySDK(name);
    }

    const hashedName = await getHashedName(name);
    const nameClass = new Uint8Array(32);
    const parent = ROOT_DOMAIN_ACCOUNT.toBuffer();
    const seeds = [hashedName, nameClass, parent];
    const [key] = await PublicKey.findProgramAddress(seeds, SNS_PROGRAM_ID);
    return key;
}

async function checkDomainAvailability(domainName) {
    try {
        const domainKey = await getDomainKey(domainName);
        // Note: domainKey might be an object from SDK { pubkey, hashed, ... }
        // If it's a PublicKey, .toBase58() works. If object, access .pubkey.
        const pubkey = (domainKey.pubkey) ? domainKey.pubkey : domainKey;

        const response = await fetch('/api/check-sns', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ publicKey: pubkey.toBase58() })
        });
        if (!response.ok) throw new Error(`Proxy error: ${response.status}`);
        const data = await response.json();
        if (data.error) throw new Error(data.error.message || "RPC Error");
        const accountInfo = data.result ? data.result.value : null;
        return accountInfo === null;
    } catch (e) {
        console.error("Error checking domain availability:", e);
        throw e;
    }
}

/**
 * Creates a transaction to register a domain with SNS.
 * MODIFIED: Returns { transaction, signers } and DOES NOT partially sign.
 */
async function createRegisterTransaction(connection, wallet, domainName, space = 1000) {
    // Clean domain name
    let name = domainName.toLowerCase();
    if (name.endsWith('.sol')) name = name.slice(0, -4);

    const buyer = new PublicKey(wallet.publicKey);

    // 1. Calculate Price Logic (simplified as per previous implementation)
    // Pricing: 1: $750, 2: $750, 3: $150, 4: $150, 5+: $20
    const len = name.length;
    let solToWrap = 0.2; // Default for 5+
    if (len <= 2) solToWrap = 10;
    else if (len <= 4) solToWrap = 2;

    // 2. Create Ephemeral wSOL Account
    const wsolKeypair = Keypair.generate();
    const wsolAccount = wsolKeypair.publicKey;

    const rentExempt = await connection.getMinimumBalanceForRentExemption(165);
    const lamportsToTransfer = Math.ceil(solToWrap * LAMPORTS_PER_SOL);

    const transaction = new Transaction();

    // 3. Create & Fund wSOL Account
    transaction.add(
        SystemProgram.createAccount({
            fromPubkey: buyer,
            newAccountPubkey: wsolAccount,
            space: 165,
            lamports: rentExempt + lamportsToTransfer,
            programId: TOKEN_PROGRAM_ID,
        })
    );

    // 4. Initialize wSOL Account
    transaction.add(
        new TransactionInstruction({
            keys: [
                { pubkey: wsolAccount, isSigner: false, isWritable: true },
                { pubkey: WRAPPED_SOL_MINT, isSigner: false, isWritable: false },
                { pubkey: buyer, isSigner: false, isWritable: false }, // Owner
                { pubkey: SYSVAR_RENT_PUBKEY, isSigner: false, isWritable: false },
            ],
            programId: TOKEN_PROGRAM_ID,
            data: Buffer.from([1]), // InitializeAccount instruction (1)
        })
    );

    // 5. Register Domain
    try {
        // We pass 'buyer' as the 3rd argument, which the SDK uses as the domain owner.
        // ‚úÖ Verified: Domain assigned to user wallet (buyer is passed as owner)
        const ixOrArray = await registerDomainName(
            connection, // Connection is required as first argument
            name,
            space,
            buyer,
            wsolAccount,
            WRAPPED_SOL_MINT,
            REFERRER_KEY
        );

        // --- CRITICAL FIX: Flatten & Normalize Instructions ---

        // 1Ô∏è‚É£ Flatten instructions (SNS SDK sometimes returns nested arrays)
        // If instructions is not an array, wrap it; otherwise flatten it.
        const rawList = Array.isArray(ixOrArray) ? ixOrArray : [ixOrArray];
        const flatInstructions = rawList.flat();

        console.log("SNS Flattened Instructions:", flatInstructions); // Debug log

        // 2Ô∏è‚É£ Process normalized instructions
        for (const ix of flatInstructions) {

            // Skip nulls, undefined, or empty arrays (Trash)
            if (!ix || (Array.isArray(ix) && ix.length === 0)) {
                continue;
            }

            // Case 1: Already a valid TransactionInstruction (Pass through)
            if (ix instanceof TransactionInstruction) {
                transaction.add(ix);
                continue;
            }

            // Case 2: Raw instruction-like object (Normalize)
            if (ix.programId && ix.keys) { // Relaxed check (data might be missing)
                const programId =
                    ix.programId instanceof PublicKey
                        ? ix.programId
                        : new PublicKey(ix.programId);

                // Handle missing or raw data safely
                let data = Buffer.alloc(0);
                if (ix.data) {
                    data = (ix.data instanceof Uint8Array)
                        ? ix.data
                        : Buffer.from(ix.data);
                }

                transaction.add(
                    new TransactionInstruction({
                        programId,
                        keys: ix.keys,
                        data
                    })
                );
                continue;
            }

            // FAIL FAST: Log the specific item causing the issue
            console.error("‚ùå Invalid SNS instruction item:", ix);
            throw new Error("Unsupported SNS instruction format");
        }

    } catch (err) {
        console.error("Error creating register instruction:", err);
        throw new Error("Failed to create register instruction. SDK might be incompatible.");
    }

    // 6. Close wSOL Account
    transaction.add(
        new TransactionInstruction({
            keys: [
                { pubkey: wsolAccount, isSigner: false, isWritable: true },
                { pubkey: buyer, isSigner: false, isWritable: true }, // Destination
                { pubkey: buyer, isSigner: true, isWritable: false }, // Owner (Signer)
            ],
            programId: TOKEN_PROGRAM_ID,
            data: Buffer.from([9]), // CloseAccount instruction (9)
        })
    );

    // Return transaction and signers without signing
    return {
        transaction,
        signers: [wsolKeypair]
    };
}

// --- View/Controller Logic moved from HTML ---

async function checkSNS() {
    const input = document.getElementById('sns-domain-input');
    const btn = document.getElementById('sns-check-btn');
    const resultDiv = document.getElementById('sns-result');
    const domain = input.value.trim().toLowerCase();

    if (!domain) return;

    // Reset UI
    resultDiv.classList.add('hidden');
    resultDiv.className = "hidden rounded-lg p-4 flex justify-between items-center animate-fade-in";
    btn.disabled = true;
    btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i>';

    try {
        const available = await checkDomainAvailability(domain);

        resultDiv.classList.remove('hidden');
        if (available) {
            resultDiv.classList.add('bg-green-900/20', 'border', 'border-green-500/30');
            resultDiv.innerHTML = `
                <div>
                    <span class="text-green-400 font-bold text-lg"><i class="fa-solid fa-check-circle mr-2"></i>Available</span>
                    <div class="text-xs text-gray-400 mt-1">${domain}.sol is free to claim!</div>
                </div>
                <button onclick="window.buyDomain('${domain}')" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded shadow hover:scale-105 transition transform text-sm">
                    Buy Now (~$20)
                </button>
            `;
        } else {
            resultDiv.classList.add('bg-red-900/20', 'border', 'border-red-500/30');
            resultDiv.innerHTML = `
                <div>
                    <span class="text-red-400 font-bold text-lg"><i class="fa-solid fa-times-circle mr-2"></i>Taken</span>
                    <div class="text-xs text-gray-400 mt-1">${domain}.sol is already registered.</div>
                </div>
                <span class="text-gray-500 font-mono text-sm">Unavailable</span>
            `;
        }

    } catch (e) {
        console.error(e);
        alert("Error checking domain availability.");
    } finally {
        btn.disabled = false;
        btn.innerHTML = 'Search';
    }
}

async function buyDomain(domain) {
    // Access global walletAddress from window (defined in HTML)
    const walletAddress = window.walletAddress;

    if (!walletAddress) {
        alert("Please connect your wallet first.");
        // Try to call global connectWallet if it exists
        if (window.connectWallet) {
            await window.connectWallet();
            if (!window.walletAddress) return;
        } else {
            return;
        }
    }

    const wallet = new PublicKey(window.walletAddress);

    const btn = document.querySelector('button[onclick^="window.buyDomain"]');
    const originalText = btn ? btn.innerHTML : 'Buy Now';
    if (btn) {
        btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Processing...';
        btn.disabled = true;
    }

    try {
        // Initialize Connection
        // Use the premium Helius RPC
        const connection = new Connection(window.SOLANA_RPC);

        // Create Transaction
        // Destructure to get transaction and signers
        const { transaction, signers } = await createRegisterTransaction(connection, { publicKey: wallet }, domain, 1000);

        // --- ROBUST SIGNING FLOW START ---

        // A. SETUP
        transaction.feePayer = wallet;
        const { blockhash, lastValidBlockHeight } = await connection.getLatestBlockhash("finalized");
        transaction.recentBlockhash = blockhash;

        // B. PARTIAL SIGN (With Sanitized Keys)
        // Convert SDK "Alien" Keypairs to "Native" Keypairs
        const validSigners = signers.map(s => {
            return (s.secretKey) ? Keypair.fromSecretKey(s.secretKey) : s;
        });

        if (validSigners.length > 0) {
            transaction.partialSign(...validSigners);
        }

        // C. USER SIGN (Ask Phantom to just sign, not send)
        // This isolates the signing error from the network error
        const signedTx = await window.solana.signTransaction(transaction);

        if (btn) btn.innerHTML = 'Confirming...';

        // D. RAW SEND (We send it ourselves via Helius)
        const rawTx = signedTx.serialize();
        const signature = await connection.sendRawTransaction(rawTx, {
            skipPreflight: false, // verification
            preflightCommitment: 'confirmed'
        });

        console.log("üöÄ Sent! Signature:", signature);

        // E. CONFIRM
        await connection.confirmTransaction({
            signature: signature,
            blockhash: blockhash,
            lastValidBlockHeight: lastValidBlockHeight
        }, 'confirmed');

        // --- ROBUST SIGNING FLOW END ---

        alert("Success! Domain registered. Signature: " + signature);
        location.reload();

    } catch (e) {
        console.error(e);
        alert("Transaction failed: " + e.message);
    } finally {
        if (btn) {
            btn.disabled = false;
            btn.innerHTML = originalText;
        }
    }
}

// üîí FIX: Expose module functions to global scope so HTML buttons work
window.checkSNS = checkSNS;
window.buyDomain = buyDomain;
window.SNSUtils = {
    checkDomainAvailability,
    getDomainKey,
    createRegisterTransaction
};


======================================================================
FILE: vm_server.py
======================================================================
import os
import uuid
import logging
import threading
import base58
import re
import time
import signal
import base64
import bcrypt
import hashlib
import math
import random
import string
import requests
import smtplib
import ssl
from email.mime.text import MIMEText
from email.mime.multipart import MIMEMultipart
from flask import Flask, request, jsonify, render_template, abort, session
from werkzeug.middleware.proxy_fix import ProxyFix
from flask_cors import CORS
from google.cloud import firestore
from google.cloud import run_v2
import firebase_admin
from firebase_admin import credentials, auth
from solders.keypair import Keypair
from cryptography.fernet import Fernet
from cryptography.hazmat.primitives import hashes
from cryptography.hazmat.primitives.kdf.pbkdf2 import PBKDF2HMAC
from dotenv import load_dotenv
from flask_limiter import Limiter
from flask_limiter.util import get_remote_address
from functools import wraps

# 1. LOAD SECRETS
load_dotenv()

# --- LOGGING CONFIGURATION ---
logging.basicConfig(level=logging.INFO, format='%(asctime)s - %(levelname)s - %(message)s')

# 2. CONFIGURATION
PROJECT_ID = os.getenv('PROJECT_ID', 'vanityforge').strip()
SOLANA_RPC_URL = os.getenv('SOLANA_RPC_URL', '').strip()
TREASURY_PUBKEY = os.getenv('TREASURY_PUBKEY', '').strip()
SMTP_EMAIL = os.getenv('SMTP_EMAIL', '').strip()
SMTP_PASSWORD = os.getenv('SMTP_PASSWORD', '').strip()
os.environ.setdefault("SMTP_SERVER", "smtp.gmail.com")
os.environ.setdefault("SMTP_PORT", "587")
SMTP_SERVER = os.getenv("SMTP_SERVER")
SMTP_PORT = int(os.getenv("SMTP_PORT"))
ADMIN_PASSWORD = os.getenv('ADMIN_PASSWORD', 'admin123')

# --- ADMIN LIST (GOD MODE) ---
ADMIN_EMAILS = set(os.getenv('ADMIN_EMAILS', "tomaaytakin@gmail.com,admin@vanityforge.org,Jonny95hidalgo@gmail.com").split(','))

# --- QUEUE LIMITS (TRAFFIC CONTROL) ---
MAX_CLOUD_JOBS = 100  # Max concurrent jobs on Cloud Run

# CLOUD JOB CONFIGURATION
REDPANDA_JOB_NAME = os.getenv('REDPANDA_JOB_NAME', "projects/vanityforge/locations/us-central1/jobs/cpu-redpanda")

# 3. SAFETY CHECK
if not SOLANA_RPC_URL or not TREASURY_PUBKEY or not SMTP_PASSWORD:
    logging.critical("CRITICAL ERROR: Missing environment variables. Make sure .env exists.")
    exit(1)

# --- FIREBASE ADMIN INIT ---
try:
    if not firebase_admin._apps:
        firebase_admin.initialize_app()
    logging.info("üî• Firebase Admin Initialized")
except Exception as e:
    logging.warning(f"‚ö†Ô∏è Firebase Admin Init Failed: {e}")

app = Flask(__name__, static_folder='.', static_url_path='', template_folder='.')
app.secret_key = os.getenv('FLASK_SECRET_KEY', os.urandom(24).hex())

# Fix IP logging to trust Google Cloud Load Balancer headers
app.wsgi_app = ProxyFix(app.wsgi_app, x_for=1, x_proto=1, x_host=1, x_prefix=1)

@app.before_request
def block_hidden_paths():
    # Block any path starting with '.' or containing '/.' (e.g. /.env, /.git/config)
    if request.path.startswith("/.") or "/." in request.path:
        real_ip = request.headers.get('X-Forwarded-For', request.remote_addr)
        app.logger.warning(f"üö® SECURITY: Blocked attempt to access {request.path} from {real_ip}")
        abort(403)

@app.after_request
def set_security_headers(response):
    response.headers['X-Content-Type-Options'] = 'nosniff'
    response.headers['X-Frame-Options'] = 'SAMEORIGIN'
    response.headers['Content-Security-Policy'] = "default-src 'self' https: data: 'unsafe-inline' 'unsafe-eval';"
    return response

CORS(app, resources={r"/*": {"origins": ["https://tomaaytakin.github.io", "https://vanityforge.org"]}})

# --- RATE LIMITER CONFIGURATION ---
limiter = Limiter(
    get_remote_address,
    app=app,
    storage_uri="memory://"
)

@app.errorhandler(429)
def ratelimit_handler(e):
    return jsonify({'error': 'Rate limit exceeded'}), 429

def is_admin_session():
    """Checks if the current session belongs to an admin."""
    email = session.get('email')
    if not email: return False

    # 1. Existing/Global Config (Plural)
    admins = globals().get('ADMIN_EMAILS') or set(os.getenv('ADMIN_EMAILS', '').split(','))

    # 2. User Requested Config (Singular) - "Strictly rely on ADMIN_EMAIL"
    single_admin = os.getenv('ADMIN_EMAIL')
    if single_admin:
        admins.add(single_admin)

    return email in admins

def login_required(f):
    @wraps(f)
    def decorated_function(*args, **kwargs):
        if not is_admin_session():
            return jsonify({'error': 'Unauthorized'}), 401
        return f(*args, **kwargs)
    return decorated_function

@app.route('/')
def index(): return app.send_static_file('index.html')

@app.route('/roadmap')
def roadmap(): return app.send_static_file('roadmap.html')

@app.route('/vvvip')
def vvvip():
    rpc_url = os.getenv("SOLANA_RPC_URL", "https://rpc.ankr.com/solana")
    return render_template('vvvip.html', rpc_url=rpc_url)

@app.route('/faq')
def faq(): return app.send_static_file('faq.html')

# --- RPC PROXY ---
@app.route('/api/rpc', methods=['POST'])
@limiter.limit("100 per minute")
def rpc_proxy():
    data = request.get_json(silent=True) or {}
    try:
        resp = requests.post(SOLANA_RPC_URL, json=data, timeout=10)
        return jsonify(resp.json()), resp.status_code
    except Exception as e:
        return jsonify({'error': str(e)}), 500

# --- ADMIN / GOD MODE ENDPOINTS ---
@app.route('/api/user-status', methods=['GET'])
def user_status():
    """Returns the admin status and email of the current session."""
    return jsonify({
        'isAdmin': is_admin_session(),
        'email': session.get('email')
    })

@app.route('/api/admin/stats', methods=['GET'])
@login_required
def admin_stats():
    return jsonify({
        'income_1w': 12.5,
        'income_1m': 45.0,
        'income_1y': 150.2,
        'total_users': 1337,
        'server_health': 'OK'
    })

@app.route('/api/admin/security', methods=['GET'])
@login_required
def admin_security():
    return jsonify([
        {'ip': '1.2.3.4', 'reason': 'Rate Limit Exceeded', 'time': '10 mins ago'},
        {'ip': '5.6.7.8', 'reason': 'Path Traversal', 'time': '1 hour ago'}
    ])

@app.route('/api/admin/referrals', methods=['GET'])
@login_required
def admin_referrals():
    return jsonify([
        {'code': 'ABCD', 'earnings': 10.5},
        {'code': 'XYZ1', 'earnings': 5.2}
    ])

# --- REFERRAL SYSTEM HELPERS ---
def generate_referral_code():
    """Generates a unique 4-character alphanumeric code."""
    return ''.join(random.choices(string.ascii_uppercase + string.digits, k=4))

def cleanup_firestore_client(db):
    """Safely closes the Firestore client connection."""
    try:
        if db:
            db.close()
    except Exception:
        # Fail silently during cleanup to keep logs clean
        pass

def is_base58(s):
    if not s: return True
    return bool(re.match(r'^[1-9A-HJ-NP-Za-km-z]+$', s))

def calculate_top64_range(prefix_str):
    """Calculates the Big-Endian uint64 range for the GPU Rejector."""
    if not prefix_str:
        return 0, 0xFFFFFFFFFFFFFFFF

    try:
        p_bytes = base58.b58decode(prefix_str)
        P = int.from_bytes(p_bytes, byteorder='big')
    except ValueError:
        return 0, 0

    # Target Length ~44 chars
    shift_power = 44 - len(prefix_str)
    if shift_power < 0: shift_power = 0
    shift_factor = 58 ** shift_power

    min_int = P * shift_factor
    max_int = (P + 1) * shift_factor - 1
    max_256 = 2**256 - 1

    if min_int > max_256: return 0, 0 # Impossible
    if max_int > max_256: max_int = max_256

    def get_top_64(num):
        b = num.to_bytes(32, byteorder='big')
        return int.from_bytes(b[:8], byteorder='big')

    min_limit = get_top_64(min_int)
    max_limit = get_top_64(max_int)

    # Safety Widening
    min_limit = max(0, min_limit - 4)
    max_limit = min(0xFFFFFFFFFFFFFFFF, max_limit + 4)

    return min_limit, max_limit

# --- DISPATCHER LOGIC (CLOUD RUN JOBS) ---
def dispatch_cloud_job(job_id, user_id, prefix, suffix, case_sensitive, pin):
    """Triggers the remote Cloud Run Job (Titanium GPU Cluster)."""
    try:
        target_job = REDPANDA_JOB_NAME
        logging.info("üèéÔ∏è Dispatching to Titanium GPU Cluster")

        min_limit, max_limit = calculate_top64_range(prefix)

        # Build Arguments List (Correct Format: ["--prefix", "val", "--suffix", "val"])
        args = []
        if prefix:
            args.extend(["--prefix", prefix])
        if suffix:
            args.extend(["--suffix", suffix])

        # CPU Grinder expects string "true" for bool flag based on logic
        if case_sensitive:
            args.extend(["--case-sensitive", "true"])

        client = run_v2.JobsClient()
        request = run_v2.RunJobRequest(
            name=target_job,
            overrides={
                "container_overrides": [{
                    "args": args,
                    "env": [
                        {"name": "TASK_JOB_ID", "value": job_id},
                        {"name": "TASK_PREFIX", "value": prefix or ""},
                        {"name": "TASK_SUFFIX", "value": suffix or ""},
                        {"name": "TASK_CASE", "value": str(case_sensitive)},
                        {"name": "TASK_PIN", "value": str(pin)},
                        {"name": "TASK_USER_ID", "value": str(user_id)},
                        {"name": "TASK_MIN_LIMIT", "value": str(min_limit)},
                        {"name": "TASK_MAX_LIMIT", "value": str(max_limit)},
                        {"name": "SERVER_URL", "value": os.getenv("SERVER_URL", "https://vanityforge.org")}
                    ]
                }]
            }
        )
        operation = client.run_job(request=request)
        logging.info(f"üöÄ Dispatched Cloud Job: {job_id}")
    except Exception as e:
        logging.exception(f"‚ùå Failed to dispatch Cloud job")
        # Mark as failed in DB so user isn't stuck forever
        db = firestore.Client(project=PROJECT_ID)
        try:
            db.collection('vanity_jobs').document(job_id).update({'status': 'FAILED', 'error': 'Cloud Dispatch Failed'})
        finally:
            cleanup_firestore_client(db)

# --- LOCAL CPU LOGIC ---
def check_user_trials(user_id):
    db = None
    try:
        db = firestore.Client(project=PROJECT_ID)
        docs = db.collection('vanity_jobs').where('user_id', '==', user_id).stream()
        return sum(1 for doc in docs if doc.to_dict().get('is_trial'))
    except: return 2
    finally:
        cleanup_firestore_client(db)

def verify_payment(signature, required_price_sol):
    if not signature: return False
    payload = {
        "jsonrpc": "2.0", "id": 1, "method": "getTransaction",
        "params": [signature, {"encoding": "json", "commitment": "confirmed", "maxSupportedTransactionVersion": 0}]
    }
    try:
        resp = requests.post(SOLANA_RPC_URL, json=payload, timeout=10)
        data = resp.json()
        if "error" in data or not data.get("result"): return False

        result = data.get("result")
        if result.get("meta", {}).get("err"): return False

        meta = result.get("meta", {})
        msg = result.get("transaction", {}).get("message", {})
        account_keys_raw = msg.get("accountKeys", [])
        accounts = [k.get("pubkey") if isinstance(k, dict) else k for k in account_keys_raw]

        try:
            idx = accounts.index(TREASURY_PUBKEY)
        except ValueError:
            logging.warning(f"Treasury not found in tx")
            return False

        received_sol = (meta.get("postBalances")[idx] - meta.get("preBalances")[idx]) / 1_000_000_000

        # Allow tiny variance for fees
        if received_sol < (required_price_sol - 0.0001):
            logging.warning(f"Insufficient: {received_sol} < {required_price_sol}")
            return False
        return True
    except Exception as e:
        logging.exception(f"Verify Error")
        return False

def get_deterministic_salt(user_id):
    return hashlib.sha256(user_id.encode()).digest()

def generate_key_from_pin(pin, user_id):
    salt = get_deterministic_salt(user_id)
    kdf = PBKDF2HMAC(algorithm=hashes.SHA256(), length=32, salt=salt, iterations=100000)
    return base64.urlsafe_b64encode(kdf.derive(pin.encode()))

# --- SOLA EMAIL ENGINE ---
SOLA_BANNER = "https://raw.githubusercontent.com/TomaAytakin/VanityForge/main/assets/Email%20Assets/vfemailbanner.png"
SOLA_PAW = "https://raw.githubusercontent.com/TomaAytakin/VanityForge/main/assets/Email%20Assets/vfemailsig.png"

def get_sola_html(body):
    """Wraps content in the Sola/Red Panda Branding"""
    return f"""
    <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; color: #333;">
        <img src="{SOLA_BANNER}" width="100%" style="border-radius: 8px 8px 0 0;" alt="VanityForge Banner">
        <div style="padding: 20px; background-color: #ffffff; border: 1px solid #e0e0e0; border-top: none;">
            {body}
        </div>
        <div style="padding: 20px; background-color: #f9f9f9; border: 1px solid #e0e0e0; border-top: none; border-radius: 0 0 8px 8px;">
            <table style="width: 100%;">
                <tr>
                    <td style="width: 60px; vertical-align: middle;">
                        <img src="{SOLA_PAW}" width="50" height="50" alt="Paw">
                    </td>
                    <td style="vertical-align: middle;">
                        <strong style="color: #E55039; font-size: 16px;">Sola</strong> üêº<br>
                        <span style="color: #666; font-size: 12px;">Chief Forging Scout @ VanityForge</span><br>
                        <a href="https://vanityforge.org" style="color: #6c5ce7; text-decoration: none; font-size: 12px;">vanityforge.org</a>
                    </td>
                </tr>
            </table>
        </div>
    </div>
    """

def send_email_wrapper(to_email, subject, html_content):
    """Handles the Alias Spoofing (Login as Admin, Send as Support)"""
    try:
        # Explicitly set the 'From' header to vanity address while logging in with SMTP creds
        sender_display = "VanityForge Support <support@vanityforge.org>"
        login_email = os.getenv('SMTP_EMAIL')
        login_password = os.getenv('SMTP_PASSWORD')

        msg = MIMEMultipart('alternative')
        msg['Subject'] = subject
        msg['From'] = sender_display
        msg['To'] = to_email

        msg.attach(MIMEText(html_content, 'html'))

        context = ssl.create_default_context()
        with smtplib.SMTP(os.getenv('SMTP_SERVER'), int(os.getenv('SMTP_PORT'))) as server:
            server.starttls(context=context)
            server.login(login_email, login_password)
            # Send using login_email as envelope sender, but msg['From'] is displayed to user
            server.sendmail(login_email, to_email, msg.as_string())

        logging.info(f"üìß Sola Email sent to {to_email}")
        return True
    except Exception as e:
        logging.error(f"‚ùå Email Failed: {e}")
        return False

def send_start_email(to_email, job_id, prefix, suffix, price, is_trial):
    # Calculate Pricing Logic for Receipt
    total_len = len(prefix or '') + len(suffix or '')
    if total_len <= 4: base = 0.25
    elif total_len == 5: base = 0.50
    elif total_len == 6: base = 1.00
    elif total_len == 7: base = 2.00
    elif total_len == 8: base = 3.00
    else: base = 5.00

    # Standard Beta Price is 50% of Base
    standard_price = base * 0.5

    if is_trial:
        # Free Trial: Show strikethrough original price -> 0 SOL
        price_display = f"<s>{standard_price} SOL</s> 0 SOL (Free Trial)"
    else:
        # Paid Job: Show actual paid amount
        price_display = f"{price} SOL"

    receipt_html = f"""
    <h2 style="color: #2d3436;">Forge Started! ‚öíÔ∏è</h2>
    <p>Hey Degen! üêæ</p>
    <p>Sola here. I've successfully dispatched your job to the grinder.</p>
    <div style="background: #eee; padding: 10px; border-radius: 5px; margin: 15px 0;">
        <strong>Target:</strong> ...{suffix} (or {prefix}...)<br>
        <strong>Job ID:</strong> {job_id}<br>
        <strong>Price:</strong> {price_display}
    </div>
    <p>Sit tight! I'll ping you the second it's ready.</p>
    """
    send_email_wrapper(to_email, "Forge Started: Your Custom Wallet is Brewing! ‚öíÔ∏è", get_sola_html(receipt_html))

def send_completion_email(to_email, public_key, private_key_enc=None):
    success_html = f"""
    <h2 style="color: #00b894;">Forge Complete! üöÄ</h2>
    <p>Great news from the bamboo forest! üéã</p>
    <p>Your custom vanity wallet has been found.</p>
    <div style="border: 2px dashed #00b894; padding: 15px; text-align: center; margin: 20px 0;">
        <strong>Public Key:</strong><br>
        <code style="font-size: 14px; word-break: break-all;">{public_key}</code>
    </div>
    <p style="text-align: center;">
        <a href="https://vanityforge.org" style="background-color: #6c5ce7; color: white; padding: 12px 24px; text-decoration: none; border-radius: 5px; font-weight: bold;">Reveal Private Key</a>
    </p>
    """
    send_email_wrapper(to_email, "Forge Complete! Your Wallet is Ready üöÄ", get_sola_html(success_html))

# --- QUEUE SCHEDULER (THE TRAFFIC CONTROLLER) ---
def scheduler_loop():
    """Background thread that checks for open slots and starts queued jobs."""
    logging.info("‚úÖ Queue Scheduler Started")
    db = firestore.Client(project=PROJECT_ID)
    while True:
        try:
            # 1. Count CURRENTLY running jobs
            running_cloud = 0
            running_docs = db.collection('vanity_jobs').where('status', '==', 'RUNNING').stream()
            for d in running_docs:
                running_cloud += 1

            # 2. Fetch QUEUED jobs (Oldest first = Fairness)
            # THIS QUERY REQUIRES THE COMPOSITE INDEX: status=QUEUED, order_by=created_at
            queued_docs = db.collection('vanity_jobs').where('status', '==', 'QUEUED').order_by('created_at').limit(10).stream()

            for doc in queued_docs:
                try:
                    data = doc.to_dict()
                    job_id = data.get('job_id')

                    # Retrieve the temporary PIN needed for encryption
                    pin_plain = data.get('temp_pin')
                    if not pin_plain:
                        # Error state: Lost PIN? Fail job to clear queue
                        logging.error(f"‚ùå Job {job_id} missing temp_pin, marking FAILED")
                        db.collection('vanity_jobs').document(job_id).update({'status': 'FAILED', 'error': 'PIN missing in queue'})
                        continue

                    # --- DISPATCH LOGIC ---
                    # RULE: ALL jobs now go to Cloud Run
                    if running_cloud < MAX_CLOUD_JOBS:
                        logging.info(f"üö¶ Dispatching Cloud Job: {job_id}")
                        db.collection('vanity_jobs').document(job_id).update({'status': 'RUNNING'})

                        if data.get('notify') and data.get('email'):
                            try:
                                send_start_email(data['email'], job_id, data.get('prefix'), data.get('suffix'), data.get('price_sol'), data.get('is_trial'))
                            except Exception as e:
                                logging.error(f"Failed to send start email: {e}")

                        # Cleanup temp PIN for security BEFORE dispatching
                        db.collection('vanity_jobs').document(job_id).update({'temp_pin': firestore.DELETE_FIELD})

                        # Trigger Cloud Run (AFTER security cleanup)
                        dispatch_cloud_job(
                            job_id,
                            data.get('user_id'),
                            data.get('prefix'),
                            data.get('suffix'),
                            data.get('case_sensitive', True),
                            pin_plain
                        )

                        running_cloud += 1

                except Exception as e:
                    logging.exception(f"‚ùå Error processing job {doc.id}")
                    try:
                        db.collection('vanity_jobs').document(doc.id).update({'status': 'FAILED', 'error': str(e)})
                    except: pass

        except Exception as e:
            # The database index failure logs here.
            logging.exception(f"Scheduler Error")

        # Check queue every 5 seconds
        time.sleep(5)

@app.route('/check-user', methods=['POST'])
@limiter.limit("20 per minute")
def check_user():
    data = request.get_json(silent=True) or {}
    user_id = data.get('user_id')

    # Securely verify ID token if provided
    id_token = data.get('id_token')
    if id_token:
        try:
            decoded_token = auth.verify_id_token(id_token)
            verified_email = decoded_token.get('email')
            if verified_email:
                session['email'] = verified_email
                logging.info(f"‚úÖ Verified session for {verified_email}")
        except Exception as e:
            logging.warning(f"‚ùå Token Verification Failed: {e}")
            # Do NOT set session email if verification fails

    db = None
    try:
        db = firestore.Client(project=PROJECT_ID)
        doc = db.collection('users').document(user_id).get()
        user_data = doc.to_dict() if doc.exists else {}
        return jsonify({
            'has_pin': bool(user_data.get('pin_hash')),
            'trials_used': check_user_trials(user_id),
            'referred_by': user_data.get('referred_by')
        })
    except Exception as e: return jsonify({'error': str(e)}), 500
    finally:
        cleanup_firestore_client(db)

@app.route('/set-pin', methods=['POST'])
@limiter.limit("5 per minute")
def set_pin():
    data = request.get_json(silent=True) or {}
    user_id, pin = data.get('user_id'), data.get('pin')
    db = None
    try:
        hashed = bcrypt.hashpw(pin.encode(), bcrypt.gensalt()).decode()
        db = firestore.Client(project=PROJECT_ID)
        db.collection('users').document(user_id).set({'user_id': user_id, 'pin_hash': hashed, 'updated_at': firestore.SERVER_TIMESTAMP}, merge=True)
        return jsonify({'message': 'PIN set'})
    except Exception as e: return jsonify({'error': str(e)}), 500
    finally:
        cleanup_firestore_client(db)

# --- REFERRAL ENDPOINTS ---
@app.route('/api/referral/create', methods=['POST'])
@limiter.limit("30 per minute")
def create_referral():
    data = request.get_json(silent=True) or {}
    user_id, pin = data.get('user_id'), data.get('pin')
    if not user_id or not pin: return jsonify({'error': 'Missing ID or PIN'}), 400

    db = None
    try:
        db = firestore.Client(project=PROJECT_ID)

        # Verify PIN
        udoc = db.collection('users').document(user_id).get()
        if not udoc.exists or not udoc.to_dict().get('pin_hash'): return jsonify({'error': 'PIN not set'}), 400
        user_data = udoc.to_dict()
        if not bcrypt.checkpw(pin.encode(), user_data.get('pin_hash').encode()): return jsonify({'error': 'Invalid PIN'}), 401

        # Check if already has code (Idempotency Check)
        ref_doc = db.collection('referrals').document(user_id).get()
        if ref_doc.exists:
            return jsonify(ref_doc.to_dict())

        # Generate Unique Code
        code = generate_referral_code()
        # Ensure uniqueness (simple check, retry loop could be better but collision prob is low for now)
        # In a high volume system, we'd check 'referrals' collection where code == new_code

        new_ref = {
            'user_id': user_id,
            'code': code,
            'balance_sol': 0.0,
            'total_earnings': 0.0,
            'usage_count': 0,
            'created_at': firestore.SERVER_TIMESTAMP
        }
        db.collection('referrals').document(user_id).set(new_ref)
        return jsonify({
            "success": True,
            "code": code,
            "message": "Referral code created successfully"
        })
    except Exception as e:
        logging.exception("Referral Create Error")
        return jsonify({'error': str(e)}), 500
    finally:
        cleanup_firestore_client(db)

@app.route('/api/referral/stats', methods=['GET'])
@limiter.limit("30 per minute")
def referral_stats():
    user_id = request.args.get('user_id')
    if not user_id: return jsonify({'error': 'Missing user_id'}), 400

    db = None
    try:
        db = firestore.Client(project=PROJECT_ID)
        doc = db.collection('referrals').document(user_id).get()
        if not doc.exists: return jsonify({'error': 'No referral account'}), 404
        return jsonify(doc.to_dict())
    except Exception as e: return jsonify({'error': str(e)}), 500
    finally:
        cleanup_firestore_client(db)

@app.route('/api/referral/validate', methods=['POST'])
@limiter.limit("30 per minute")
def validate_referral():
    data = request.get_json(silent=True) or {}
    code = data.get('code', '').strip().upper()
    if not code: return jsonify({'valid': False}), 200

    db = None
    try:
        db = firestore.Client(project=PROJECT_ID)
        # Query for code
        docs = db.collection('referrals').where('code', '==', code).limit(1).stream()
        valid = any(docs)
        return jsonify({'valid': valid, 'discount_percent': 10 if valid else 0})
    except Exception as e: return jsonify({'error': str(e)}), 500
    finally:
        cleanup_firestore_client(db)

@app.route('/api/referral/withdraw', methods=['POST'])
@limiter.limit("30 per minute")
def withdraw_referral():
    data = request.get_json(silent=True) or {}
    user_id, pin = data.get('user_id'), data.get('pin')
    amount = float(data.get('amount', 0))
    target_wallet = data.get('target_wallet')

    if amount < 0.1: return jsonify({'error': 'Min withdrawal 0.1 SOL'}), 400
    if not is_base58(target_wallet): return jsonify({'error': 'Invalid Wallet'}), 400

    db = None
    try:
        db = firestore.Client(project=PROJECT_ID)

        # Verify PIN
        udoc = db.collection('users').document(user_id).get()
        if not udoc.exists or not bcrypt.checkpw(pin.encode(), udoc.to_dict().get('pin_hash').encode()):
            return jsonify({'error': 'Invalid PIN'}), 401

        ref_ref = db.collection('referrals').document(user_id)

        # Transactional update
        @firestore.transactional
        def update_balance(transaction, ref_ref):
            snapshot = transaction.get(ref_ref)
            if not snapshot.exists: raise Exception("No referral account")
            balance = snapshot.get('balance_sol')
            if balance < amount: raise Exception("Insufficient balance")

            transaction.update(ref_ref, {'balance_sol': balance - amount})
            return balance - amount

        transaction = db.transaction()
        new_balance = update_balance(transaction, ref_ref)

        # Create Withdrawal Request
        db.collection('withdrawal_requests').add({
            'user_id': user_id,
            'amount': amount,
            'target_wallet': target_wallet,
            'status': 'PENDING',
            'created_at': firestore.SERVER_TIMESTAMP
        })

        # Notify Admin
        send_email_wrapper(
            ADMIN_EMAILS.copy().pop(), # Just send to one admin
            f"[Ref Liquidation Request] User: {user_id}",
            f"User {user_id} requested {amount} SOL to {target_wallet}. New Balance: {new_balance}"
        )

        return jsonify({'message': 'Withdrawal requested', 'new_balance': new_balance})

    except Exception as e:
        logging.exception("Withdrawal Error")
        return jsonify({'error': str(e)}), 400
    finally:
        cleanup_firestore_client(db)

@app.route('/submit-job', methods=['POST'])
@limiter.limit("60 per minute")
def submit_job():
    data = request.get_json(silent=True) or {}
    user_id = data.get('userId') or data.get('user_id')
    prefix, suffix = data.get('prefix'), data.get('suffix', '')
    pin, tx_sig = data.get('pin'), data.get('transaction_signature')
    email, notify = data.get('email'), data.get('notify', False)
    # use_gpu ignored, 100% GPU now
    referral_code = data.get('referral_code', '').strip().upper()

    if not user_id or not pin: return jsonify({'error': 'Missing ID or PIN'}), 400
    if not prefix and not suffix: return jsonify({'error': 'Prefix/Suffix required'}), 400
    if (prefix and not is_base58(prefix)) or (suffix and not is_base58(suffix)): return jsonify({'error': 'Invalid Base58'}), 400

    db = None
    try:
        # 1. Instantiate the client (always fresh)
        db = firestore.Client(project=PROJECT_ID)

        udoc = db.collection('users').document(user_id).get()
        if not udoc.exists or not udoc.to_dict().get('pin_hash'): return jsonify({'error': 'PIN not set'}), 400

        user_data = udoc.to_dict()

        # --- ADMIN / GOD MODE DETECTION ---
        is_admin = email in ADMIN_EMAILS
        is_god_mode = user_data.get('god_mode', False) or is_admin

        # --- REFERRAL LOGIC: LIFETIME BINDING ---
        active_referral_code = None
        # 1. Check Lifetime Binding
        if user_data.get('referred_by'):
            active_referral_code = user_data.get('referred_by')
        # 2. If not bound, check provided code
        elif referral_code:
            # Validate code
            ref_docs = list(db.collection('referrals').where('code', '==', referral_code).limit(1).stream())
            if ref_docs:
                referrer_doc = ref_docs[0]
                # Prevent self-referral
                if referrer_doc.id != user_id:
                     # Bind User
                     db.collection('users').document(user_id).update({'referred_by': referral_code})
                     active_referral_code = referral_code

        # --- ACTIVE JOB CHECK ---
        # Admins (God Mode) bypass the active job check to run parallel jobs
        if not is_god_mode:
            active_jobs = db.collection('vanity_jobs') \
                .where('user_id', '==', user_id) \
                .where('status', 'in', ['QUEUED', 'RUNNING']) \
                .limit(1).stream()

            if any(active_jobs):
                return jsonify({'error': 'You have an active job'}), 400

        if not bcrypt.checkpw(pin.encode(), user_data.get('pin_hash').encode()): return jsonify({'error': 'Invalid PIN'}), 401

        # --- DETERMINE JOB TYPE ---
        total_len = len(prefix or '') + len(suffix or '')

        # Prices Logic
        if total_len <= 4: base = 0.25
        elif total_len == 5: base = 0.50
        elif total_len == 6: base = 1.00
        elif total_len == 7: base = 2.00
        elif total_len == 8: base = 3.00
        else: base = 5.00

        # Note: GPU Surcharge removed as we are 100% GPU now.

        # Free logic: <5 chars AND trials remaining OR Admin/God Mode
        if is_admin:
            price = 0.0
        elif total_len <= 4 and check_user_trials(user_id) < 2:
            price = 0.0
        else:
            price = base * 0.5
            # Apply Referral Discount (Extra 10%)
            if active_referral_code:
                price = price * 0.90

        # Hard Limit
        if total_len > 8: return jsonify({'error': 'Max 8 chars allowed in Beta'}), 403

        # Payment Check
        if price > 0:
            if not tx_sig: return jsonify({'error': f'Payment of {price} SOL required'}), 402
            if not verify_payment(tx_sig, price): return jsonify({'error': 'Payment verification failed'}), 402

        job_id = str(uuid.uuid4())

        # --- JOB QUEUE LOGIC ---
        # Determine Worker Type & Cloud Status
        worker_type = "cloud-run-gpu-redpanda"

        is_cloud_job = True

        # 2. Save Initial State as 'QUEUED'
        db.collection('vanity_jobs').document(job_id).set({
            'job_id': job_id,
            'user_id': user_id,
            'prefix': prefix,
            'suffix': suffix,
            'case_sensitive': data.get('case_sensitive', True),
            'status': 'QUEUED',
            'is_cloud': is_cloud_job,
            'worker_type': worker_type,
            'temp_pin': pin,
            'created_at': firestore.SERVER_TIMESTAMP,
            'is_trial': (price == 0),
            'price_sol': price,
            'transaction_signature': tx_sig,
            'email': email,
            'notify': notify
        })

        # --- PROCESS COMMISSION (Async/Optimistic) ---
        if active_referral_code and price > 0:
            try:
                # Find referrer (we did this earlier if binding, but safe to query again or cache)
                # If we bound it, we know it exists. If it was already bound, we need to find the doc id.
                # Optimization: Query by code
                ref_docs = list(db.collection('referrals').where('code', '==', active_referral_code).limit(1).stream())
                if ref_docs:
                    referrer_ref = ref_docs[0].reference
                    commission = price * 0.15

                    # Transactional increment
                    @firestore.transactional
                    def add_commission(transaction, ref):
                        snap = transaction.get(ref)
                        if snap.exists:
                            transaction.update(ref, {
                                'balance_sol': snap.get('balance_sol') + commission,
                                'total_earnings': snap.get('total_earnings') + commission,
                                'usage_count': snap.get('usage_count') + 1
                            })

                    transaction = db.transaction()
                    add_commission(transaction, referrer_ref)
                    logging.info(f"üí∞ Commission {commission} SOL credited to {referrer_ref.id} for job {job_id}")

            except Exception as e:
                logging.error(f"Failed to credit commission: {e}")

        return jsonify({'job_id': job_id, 'message': 'Job Queued successfully'}), 202

    except Exception as e:
        logging.exception("Submit job failed")
        return jsonify({'error': str(e)}), 500

    finally:
        # 3. CRITICAL CLEANUP: Ensure the client connection is closed immediately after use
        cleanup_firestore_client(db)

@app.route('/api/worker/complete', methods=['POST'])
def worker_complete():
    data = request.get_json(silent=True) or {}
    job_id = data.get('job_id')
    public_key = data.get('public_key')
    secret_key = data.get('secret_key')
    error = data.get('error')

    if not job_id: return jsonify({'error': 'Missing job_id'}), 400

    db = None
    try:
        db = firestore.Client(project=PROJECT_ID)
        job_ref = db.collection('vanity_jobs').document(job_id)
        job = job_ref.get()

        if not job.exists:
             return jsonify({'error': 'Job not found'}), 404

        job_data = job.to_dict()
        if job_data.get('status') != 'RUNNING':
             # If it's already completed or failed, we just return success to stop worker retries
             return jsonify({'success': True, 'message': 'Job already processed'})

        if error:
            job_ref.update({'status': 'FAILED', 'error': error})
            logging.error(f"Worker reported error for {job_id}: {error}")
            return jsonify({'success': True})

        if not public_key or not secret_key:
            return jsonify({'error': 'Missing keys'}), 400

        job_ref.update({
            'status': 'COMPLETED',
            'public_key': public_key,
            'secret_key': secret_key,
            'completed_at': firestore.SERVER_TIMESTAMP
        })
        logging.info(f"Job {job_id} completed successfully via Worker Callback.")

        if job_data.get('notify') and job_data.get('email'):
            send_completion_email(job_data['email'], public_key)

        return jsonify({'success': True})

    except Exception as e:
        logging.exception("Worker Complete Error")
        return jsonify({'error': str(e)}), 500
    finally:
        cleanup_firestore_client(db)


@app.route('/reveal-key', methods=['POST'])
@limiter.limit("5 per minute")
def reveal_key():
    data = request.get_json(silent=True) or {}
    job_id, pin = data.get('job_id'), data.get('pin')
    db = None
    try:
        db = firestore.Client(project=PROJECT_ID)
        job = db.collection('vanity_jobs').document(job_id).get()
        if not job.exists: return jsonify({'error': 'Job not found'}), 404
        jdata = job.to_dict()

        # --- CRITICAL SECURITY FIX ---
        user_doc = db.collection('users').document(jdata['user_id']).get()
        pin_hash = user_doc.to_dict().get('pin_hash', '') if user_doc.exists else ''

        # If the hash exists and the provided PIN does NOT match the hash, reject.
        if pin_hash and not bcrypt.checkpw(pin.encode(), pin_hash.encode()):
            return jsonify({'error': 'Invalid PIN'}), 401

        # PIN is correct for the job owner, proceed to decryption.
        key = generate_key_from_pin(pin, jdata['user_id'])
        return jsonify({'secret_key': Fernet(key).decrypt(jdata['secret_key'].encode()).decode()})
    except Exception as e:
        logging.exception("Decryption Error")
        return jsonify({'error': 'Decryption failed'}), 400
    finally:
        cleanup_firestore_client(db)

@app.route('/api/check-sns', methods=['POST'])
def check_sns():
    """Proxy route to check SNS availability via Mainnet RPC"""
    data = request.get_json(silent=True) or {}
    public_key = data.get('publicKey')

    if not public_key:
        return jsonify({'error': 'Missing publicKey'}), 400

    # Payload for getAccountInfo
    payload = {
        "jsonrpc": "2.0",
        "id": 1,
        "method": "getAccountInfo",
        "params": [
            public_key,
            {"encoding": "base58"}
        ]
    }

    try:
        # Use the standard mainnet-beta endpoint as requested
        # Server-side request avoids browser CORS issues
        rpc_url = "https://api.mainnet-beta.solana.com"
        resp = requests.post(rpc_url, json=payload, timeout=5)

        # If the RPC returns an error (even 200 OK with error body), forward it or handle it
        if resp.status_code != 200:
            logging.error(f"SNS Proxy RPC Error: {resp.status_code} {resp.text}")
            return jsonify({'error': 'RPC Error'}), resp.status_code

        rpc_data = resp.json()
        return jsonify(rpc_data)

    except Exception as e:
        logging.exception("SNS Proxy Failed")
        return jsonify({'error': str(e)}), 500

if __name__ == '__main__':
    signal.signal(signal.SIGCHLD, signal.SIG_IGN)
    # START THE TRAFFIC CONTROLLER THREAD
    t = threading.Thread(target=scheduler_loop, daemon=True)
    t.start()
    app.run(host='127.0.0.1', port=8080)


======================================================================
FILE: build_installer.py
======================================================================
import os
import shutil
import subprocess
import sys

def run_command(command, cwd=None, shell=False):
    """Runs a shell command and prints its output."""
    print(f"Running: {' '.join(command) if isinstance(command, list) else command}")
    try:
        subprocess.check_call(command, cwd=cwd, shell=shell)
    except subprocess.CalledProcessError as e:
        print(f"Error executing command: {command}")
        raise e

def main():
    dist_dir = "dist"
    cpu_miner_dir = "redpanda-cpu"
    gpu_miner_src = os.path.join("solanity-gpu", "main.cu")
    launcher_script = "launcher.py"

    # 1. Setup
    print("--- Step 1: Setup ---")
    if os.path.exists(dist_dir):
        print(f"Removing existing '{dist_dir}' directory...")
        shutil.rmtree(dist_dir)
    os.makedirs(dist_dir)
    print(f"Created '{dist_dir}' directory.")

    # 2. Compile CPU Miner
    print("\n--- Step 2: Compile CPU Miner ---")
    # Check if CPU miner directory exists
    if not os.path.exists(cpu_miner_dir):
        print(f"Error: Directory '{cpu_miner_dir}' not found. Cannot compile CPU miner.")
        sys.exit(1)

    try:
        run_command(["cargo", "build", "--release"], cwd=cpu_miner_dir)

        # Source path for the compiled binary
        # Assuming standard cargo layout: target/release/redpanda-cpu.exe
        # Note: On non-Windows systems, this might just be 'redpanda-cpu'
        cpu_bin_name = "redpanda-cpu.exe"
        src_cpu_bin = os.path.join(cpu_miner_dir, "target", "release", cpu_bin_name)

        # If strictly for Windows build automation as requested, we look for .exe
        if not os.path.exists(src_cpu_bin):
            # Fallback check for extensionless binary if running on Linux for verification
            # But the user asked for a Windows release script.
            print(f"Warning: Expected binary '{src_cpu_bin}' not found.")
            # We try to copy anyway to trigger the error if it's really missing

        dst_cpu_bin = os.path.join(dist_dir, cpu_bin_name)
        shutil.copy2(src_cpu_bin, dst_cpu_bin)
        print(f"Successfully compiled and copied '{cpu_bin_name}' into '{dist_dir}/'.")

    except Exception as e:
        print(f"Failed to compile CPU miner: {e}")
        # "handle errors ... gracefully" - we exit here because the miner is core
        sys.exit(1)

    # 3. Compile GPU Miner
    print("\n--- Step 3: Compile GPU Miner ---")
    nvcc_path = shutil.which("nvcc")
    if nvcc_path:
        gpu_bin_name = "solanity-gpu.exe"
        dst_gpu_bin = os.path.join(dist_dir, gpu_bin_name)

        try:
            # Compile solanity-gpu/main.cu into dist/solanity-gpu.exe
            # Using basic flags. Add optimization if needed, e.g. -O3
            run_command(["nvcc", gpu_miner_src, "-o", dst_gpu_bin, "-O3"])
            print(f"Successfully compiled '{gpu_bin_name}' into '{dist_dir}/'.")
        except Exception as e:
            print(f"Warning: Failed to compile GPU miner: {e}")
            # Continue as per instructions
    else:
        print("Warning: 'nvcc' not found in system path. Skipping GPU miner compilation.")

    # 4. Bundle GUI
    print("\n--- Step 4: Bundle GUI ---")
    try:
        # PyInstaller command: pyinstaller --onefile --noconsole --name VanityForge_GUI launcher.py
        # By default, PyInstaller puts the output in dist/.
        # Since our dist_dir is also 'dist', it matches.
        run_command(["pyinstaller", "--onefile", "--noconsole", "--name", "VanityForge_GUI", launcher_script])

        # Verify the file is in dist/
        gui_bin_name = "VanityForge_GUI.exe"
        expected_output = os.path.join("dist", gui_bin_name)

        if os.path.exists(expected_output):
             # Move? It is already in dist/.
             # If PyInstaller output to a different dist (e.g. if we changed spec), we'd move.
             # But here we just verify.
             print(f"Successfully bundled '{gui_bin_name}' into '{dist_dir}/'.")
        else:
            print(f"Error: Expected output '{expected_output}' not found after PyInstaller run.")
            sys.exit(1)

    except Exception as e:
        print(f"Failed to bundle GUI: {e}")
        sys.exit(1)

    # 5. Cleanup
    print("\n--- Step 5: Cleanup ---")
    build_dir = "build"
    spec_file = "VanityForge_GUI.spec"

    if os.path.exists(build_dir):
        shutil.rmtree(build_dir)
        print(f"Removed '{build_dir}' directory.")

    if os.path.exists(spec_file):
        os.remove(spec_file)
        print(f"Removed '{spec_file}'.")

    print("\nBuild process completed successfully.")

if __name__ == "__main__":
    main()


======================================================================
FILE: check_sns_rpc.py
======================================================================
import requests
import json

RPC_URL = "https://mainnet.helius-rpc.com/?api-key=03ad30eb-2c13-45e9-83bd-19187d14e21a"

def check_account(pubkey):
    payload = {
        "jsonrpc": "2.0",
        "id": 1,
        "method": "getAccountInfo",
        "params": [
            pubkey,
            {"encoding": "base58"}
        ]
    }
    response = requests.post(RPC_URL, json=payload)
    print(f"Checking {pubkey}: {response.status_code}")
    data = response.json()
    if 'result' in data and data['result'] and data['result']['value']:
        print(f"FOUND! Owner: {data['result']['value']['owner']}")
    else:
        print("Not found or empty.")

print("Variant 1:")
check_account("7RT5xcbwSrXnRVBSMUqS78J3dinRGvSVEFeFXfdN3pL3")

print("\nVariant 2:")
check_account("RJG3kcwd5bGtA1cr529Set3KczBR5WfSY1oSaF32jhP")


======================================================================
FILE: launcher.py
======================================================================
import tkinter as tk
from tkinter import ttk, scrolledtext, messagebox
import subprocess
import threading
import sys
import os
import platform
import json
import queue

class VanityForgeApp:
    def __init__(self, root):
        self.root = root
        self.root.title("VanityForge Studio")
        self.root.geometry("600x700")

        # Style
        style = ttk.Style()
        style.theme_use('clam')

        # Variables
        self.prefix_var = tk.StringVar()
        self.suffix_var = tk.StringVar()
        self.case_sensitive_var = tk.BooleanVar()
        self.mode_var = tk.StringVar(value="CPU") # Default to CPU
        self.is_running = False
        self.process = None
        self.log_queue = queue.Queue()

        # UI Layout
        self.create_widgets()

        # Periodic check for logs
        self.root.after(100, self.process_logs)

        # Safety: Ensure process is killed on close
        self.root.protocol("WM_DELETE_WINDOW", self.on_close)

    def create_widgets(self):
        # Header
        header = ttk.Label(self.root, text="VanityForge Studio", font=("Helvetica", 16, "bold"))
        header.pack(pady=10)

        # Inputs Frame
        input_frame = ttk.LabelFrame(self.root, text="Settings", padding="10")
        input_frame.pack(fill="x", padx=10, pady=5)

        # Prefix
        ttk.Label(input_frame, text="Prefix (Starts with):").grid(row=0, column=0, sticky="w", padx=5, pady=2)
        ttk.Entry(input_frame, textvariable=self.prefix_var).grid(row=0, column=1, sticky="ew", padx=5, pady=2)

        # Suffix
        ttk.Label(input_frame, text="Suffix (Ends with):").grid(row=1, column=0, sticky="w", padx=5, pady=2)
        ttk.Entry(input_frame, textvariable=self.suffix_var).grid(row=1, column=1, sticky="ew", padx=5, pady=2)

        # Case Sensitive
        ttk.Checkbutton(input_frame, text="Case Sensitive", variable=self.case_sensitive_var).grid(row=2, column=0, columnspan=2, sticky="w", padx=5, pady=5)

        input_frame.columnconfigure(1, weight=1)

        # Mode Frame
        mode_frame = ttk.LabelFrame(self.root, text="Mode", padding="10")
        mode_frame.pack(fill="x", padx=10, pady=5)

        ttk.Radiobutton(mode_frame, text="CPU (RedPanda)", variable=self.mode_var, value="CPU").pack(anchor="w", padx=5)
        ttk.Radiobutton(mode_frame, text="GPU (Solanity)", variable=self.mode_var, value="GPU").pack(anchor="w", padx=5)

        # Controls Frame
        control_frame = ttk.Frame(self.root, padding="10")
        control_frame.pack(fill="x", padx=10, pady=5)

        self.start_btn = ttk.Button(control_frame, text="Start Forge", command=self.start_mining)
        self.start_btn.pack(side="left", fill="x", expand=True, padx=5)

        self.stop_btn = ttk.Button(control_frame, text="Stop", command=self.stop_mining, state="disabled")
        self.stop_btn.pack(side="right", fill="x", expand=True, padx=5)

        # Logs Frame
        log_frame = ttk.LabelFrame(self.root, text="Logs", padding="10")
        log_frame.pack(fill="both", expand=True, padx=10, pady=5)

        self.log_area = scrolledtext.ScrolledText(log_frame, state="disabled", height=15)
        self.log_area.pack(fill="both", expand=True)

    def start_mining(self):
        if self.is_running:
            return

        prefix = self.prefix_var.get().strip()
        suffix = self.suffix_var.get().strip()
        case_sensitive = self.case_sensitive_var.get()
        mode = self.mode_var.get()

        # Determine Executable
        if mode == "CPU":
            binary_name = "redpanda-cpu"
        else:
            binary_name = "solanity-gpu"

        if platform.system() == "Windows":
            binary_name += ".exe"

        # Check if binary exists (optional, but good practice)
        if not os.path.exists(binary_name) and not any(os.access(os.path.join(path, binary_name), os.X_OK) for path in os.environ["PATH"].split(os.pathsep)):
            # We will still try to run it, but log a warning if not found in cwd
            self.log_message(f"Warning: {binary_name} not found in current directory. Attempting to run from PATH...")

        # Construct Command
        cmd = [binary_name]
        if prefix:
            cmd.extend(["--prefix", prefix])
        if suffix:
            cmd.extend(["--suffix", suffix])
        if case_sensitive:
            cmd.append("--case-sensitive")

        self.log_message(f"Starting {mode} Forge...")
        self.log_message(f"Command: {' '.join(cmd)}")

        try:
            # On Windows, creationflags=subprocess.CREATE_NO_WINDOW hides the console window
            creation_flags = 0
            if platform.system() == "Windows":
                creation_flags = subprocess.CREATE_NO_WINDOW

            self.process = subprocess.Popen(
                cmd,
                stdout=subprocess.PIPE,
                stderr=subprocess.STDOUT,
                text=True,
                bufsize=1,
                universal_newlines=True,
                creationflags=creation_flags
            )

            self.is_running = True
            self.start_btn.config(state="disabled")
            self.stop_btn.config(state="normal")

            # Start monitoring thread
            threading.Thread(target=self.monitor_output, daemon=True).start()

        except Exception as e:
            self.log_message(f"Error starting process: {e}")
            messagebox.showerror("Error", f"Failed to start miner:\n{e}")

    def stop_mining(self):
        if self.process and self.is_running:
            self.log_message("Stopping...")
            try:
                self.process.terminate()
            except Exception as e:
                self.log_message(f"Error stopping process: {e}")

            self.process = None
            self.is_running = False
            self.start_btn.config(state="normal")
            self.stop_btn.config(state="disabled")
            self.log_message("Stopped.")

    def monitor_output(self):
        while self.is_running and self.process:
            try:
                line = self.process.stdout.readline()
                if not line and self.process.poll() is not None:
                    break

                if line:
                    self.log_queue.put({"type": "log", "content": line.strip()})

                    # Success Detection
                    if '"public_key"' in line and '"secret_key"' in line:
                         try:
                             # Extract JSON part if mixed with text
                             start_idx = line.find('{')
                             end_idx = line.rfind('}') + 1
                             if start_idx != -1 and end_idx != -1:
                                 json_str = line[start_idx:end_idx]
                                 data = json.loads(json_str)
                                 self.log_queue.put({"type": "success", "data": data})
                         except json.JSONDecodeError:
                             pass # Not valid JSON, ignore
            except Exception as e:
                self.log_queue.put({"type": "log", "content": f"Error reading output: {e}"})
                break

        if self.is_running:
             # Process exited unexpectedly or finished
             self.log_queue.put({"type": "finished"})

    def process_logs(self):
        try:
            while True:
                item = self.log_queue.get_nowait()

                if item["type"] == "log":
                    self.log_message(item["content"])

                elif item["type"] == "success":
                    data = item["data"]
                    self.log_message(f"SUCCESS! Wallet Found: {data.get('public_key')}")
                    self.stop_mining()
                    messagebox.showinfo("Wallet Found!", f"Public Key: {data.get('public_key')}\n\nCheck logs for details.")

                elif item["type"] == "finished":
                     if self.is_running:
                         self.stop_mining()
                         self.log_message("Process finished.")

        except queue.Empty:
            pass

        self.root.after(100, self.process_logs)

    def log_message(self, msg):
        self.log_area.config(state="normal")
        self.log_area.insert(tk.END, msg + "\n")
        self.log_area.see(tk.END)
        self.log_area.config(state="disabled")

    def on_close(self):
        if self.is_running:
            self.stop_mining()
        self.root.destroy()

if __name__ == "__main__":
    root = tk.Tk()
    app = VanityForgeApp(root)
    root.mainloop()


======================================================================
FILE: verify_sns.py
======================================================================
import hashlib
from solders.pubkey import Pubkey

SNS_PROGRAM_ID = Pubkey.from_string("namesLPneVptA9Z5rqUDD9tMTWEJwofgaYwp8cawRkX")
ROOT_DOMAIN = Pubkey.from_string("58PwtjSDuFHuUkYjH9BYnnQKHfwo9reZhC2zMJv9JPkx")

def get_hashed_name(name):
    return hashlib.sha256(name.encode("utf-8")).digest()

def derive(name):
    hashed = get_hashed_name(name)

    # Variant 1: [hash, class(zeros), parent]
    # Class is 32 bytes of zeros
    class_elem = bytes([0] * 32)
    seeds1 = [hashed, class_elem, bytes(ROOT_DOMAIN)]
    pda1, _ = Pubkey.find_program_address(seeds1, SNS_PROGRAM_ID)

    # Variant 2: [hash, parent]
    seeds2 = [hashed, bytes(ROOT_DOMAIN)]
    pda2, _ = Pubkey.find_program_address(seeds2, SNS_PROGRAM_ID)

    print(f"Name: {name}")
    print(f"Variant 1 (hash, zeros, parent): {pda1}")
    print(f"Variant 2 (hash, parent): {pda2}")

if __name__ == "__main__":
    derive("bonfida")


======================================================================
FILE: cpu-grinder/Cargo.toml
======================================================================
[package]
name = "cpu-grinder"
version = "0.1.0"
edition = "2021"

[dependencies]
solana-sdk = "1.16"
clap = { version = "4.4", features = ["derive"] }
rayon = "1.8"
bs58 = "0.5"


======================================================================
FILE: cpu-grinder/src/main.rs
======================================================================
use clap::Parser;
use rayon::prelude::*;
use solana_sdk::signer::keypair::Keypair;
use solana_sdk::signer::Signer;
use std::sync::atomic::{AtomicBool, Ordering};
use std::sync::Arc;

#[derive(Parser, Debug)]
#[command(author, version, about, long_about = None)]
struct Args {
    #[arg(long, default_value = "")] prefix: String,
    #[arg(long, default_value = "")] suffix: String,
    #[arg(long, default_value = "false")] case_sensitive: String,
}
fn main() {
    let args = Args::parse();
    let prefix = args.prefix;
    let suffix = args.suffix;
    let case = args.case_sensitive.to_lowercase() == "true";
    let found = Arc::new(AtomicBool::new(false));

    rayon::iter::repeat(()).any(|_| {
        if found.load(Ordering::Relaxed) { return true; }
        let kp = Keypair::new();
        let pk = kp.pubkey().to_string();

        let p_match = if case { pk.starts_with(&prefix) } else { pk.to_lowercase().starts_with(&prefix.to_lowercase()) };
        let s_match = if case { pk.ends_with(&suffix) } else { pk.to_lowercase().ends_with(&suffix.to_lowercase()) };

        if p_match && s_match {
            found.store(true, Ordering::Relaxed);
            let final_b58 = bs58::encode(kp.to_bytes()).into_string();
            println!("MATCH_FOUND:{}", final_b58);
            return true;
        }
        false
    });
}


======================================================================
FILE: solanity-gpu/requirements.txt
======================================================================
base58==2.1.1
solders==0.18.0
google-cloud-logging==3.8.0


======================================================================
FILE: solanity-gpu/Dockerfile
======================================================================
FROM ubuntu:22.04

# Prevent timezone prompts
ENV DEBIAN_FRONTEND=noninteractive

# Ensure Python logs are output immediately
ENV PYTHONUNBUFFERED=1

# Install Python, Pip, and dependencies
RUN apt-get update && apt-get install -y \
    curl python3 python3-pip bzip2 \
    && rm -rf /var/lib/apt/lists/*

WORKDIR /app

# Install Python libraries
COPY requirements.txt .
RUN pip3 install --no-cache-dir -r requirements.txt

# Install Official Solana CLI (Stable Release)
# Using direct download to avoid pipe errors
RUN curl -L https://github.com/solana-labs/solana/releases/download/v1.18.4/solana-release-x86_64-unknown-linux-gnu.tar.bz2 | tar jx -C /root

# Add Solana binaries to PATH
ENV PATH="/root/solana-release/bin:${PATH}"

# Copy the worker script
COPY worker.py .

CMD ["python3", "worker.py"]


======================================================================
FILE: solanity-gpu/worker.py
======================================================================
import subprocess
import json
import os
import glob
import sys
import base58
import logging
import google.cloud.logging
from google.cloud.logging.handlers import CloudLoggingHandler

def setup_logging():
    """Sets up Google Cloud Logging if available, otherwise falls back to standard logging."""
    try:
        # Instantiates a client
        client = google.cloud.logging.Client()
        handler = CloudLoggingHandler(client)
        google.cloud.logging.handlers.setup_logging(handler)
        logging.getLogger().setLevel(logging.INFO)
    except Exception as e:
        # Fallback to standard logging if credentials fail (e.g. local test)
        logging.basicConfig(level=logging.INFO, format='%(asctime)s - %(levelname)s - %(message)s')
        logging.warning(f"Failed to setup Cloud Logging: {e}. using basic logging.")

def main():
    setup_logging()

    # Manual argument parsing to be more robust on Cloud Run
    prefix = None
    suffix = None
    case_sensitive = 'true'

    args = sys.argv[1:]
    logging.info(f"Raw arguments: {args}")

    i = 0
    while i < len(args):
        arg = args[i]
        if arg == '--prefix':
            if i + 1 < len(args):
                prefix = args[i+1]
                i += 2
            else:
                logging.error("--prefix requires an argument")
                sys.exit(1)
        elif arg.startswith('--prefix='):
            prefix = arg.split('=', 1)[1]
            i += 1
        elif arg == '--suffix':
            if i + 1 < len(args):
                suffix = args[i+1]
                i += 2
            else:
                logging.error("--suffix requires an argument")
                sys.exit(1)
        elif arg.startswith('--suffix='):
            suffix = arg.split('=', 1)[1]
            i += 1
        elif arg == '--case-sensitive':
            if i + 1 < len(args):
                case_sensitive = args[i+1]
                i += 2
            else:
                logging.error("--case-sensitive requires an argument")
                sys.exit(1)
        elif arg.startswith('--case-sensitive='):
            case_sensitive = arg.split('=', 1)[1]
            i += 1
        else:
            # Ignore unknown args or handle as needed
            i += 1

    grind_args = []
    if prefix:
        grind_args.extend(["--starts-with", f"{prefix}:1"])
    elif suffix:
        grind_args.extend(["--ends-with", f"{suffix}:1"])
    else:
        error_msg = "No pattern provided (prefix or suffix required)"
        logging.error(error_msg)
        print(json.dumps({"found": False, "error": error_msg}))
        sys.exit(1)

    if case_sensitive == 'false':
        grind_args.append("--ignore-case")

    # Use solana-keygen from PATH (installed in Dockerfile)
    solana_keygen_cmd = "solana-keygen"

    command = [solana_keygen_cmd, "grind"] + grind_args

    logging.info(f"Running command: {command}")

    try:
        # Run the grind
        process = subprocess.run(command, capture_output=True, text=True, check=True)

        # Log stdout/stderr for debugging
        logging.info(f"Command stdout: {process.stdout}")

        # Find the .json file solana-keygen just made
        json_files = glob.glob("*.json")
        if not json_files:
            error_msg = "Keypair file not generated"
            logging.error(error_msg)
            print(json.dumps({"found": False, "error": error_msg}))
            sys.exit(1)

        found_file = json_files[0]
        logging.info(f"Found keypair file: {found_file}")

        with open(found_file, "r") as f:
            keypair_data = json.load(f)

        private_key_bytes = bytes(keypair_data)
        private_key_b58 = base58.b58encode(private_key_bytes).decode('utf-8')

        # Last 32 bytes are always the public key in a 64-byte Solana keypair
        public_key_bytes = private_key_bytes[32:]
        public_key_b58 = base58.b58encode(public_key_bytes).decode('utf-8')

        result = {
            "found": True,
            "public_key": public_key_b58,
            "private_key": private_key_b58
        }

        # Print JSON to stdout for the caller to parse
        print(json.dumps(result))

        # Clean up
        os.remove(found_file)
        logging.info("Job completed successfully")

    except subprocess.CalledProcessError as e:
        logging.error(f"Subprocess error: {e.stderr}")
        print(json.dumps({"found": False, "error": str(e)}))
        sys.exit(1)
    except FileNotFoundError:
        logging.error("solana-keygen not found in PATH")
        print(json.dumps({"found": False, "error": "solana-keygen executable not found"}))
        sys.exit(1)
    except Exception as e:
        logging.exception("Unexpected error")
        print(json.dumps({"found": False, "error": str(e)}))
        sys.exit(1)

if __name__ == "__main__":
    main()


======================================================================
FILE: solanity-gpu/entrypoint.sh
======================================================================
#!/bin/bash
set -e

# Defensive logging
echo "Starting container entrypoint..."
echo "User: $(whoami) (UID: $(id -u))"
echo "Workdir: $(pwd)"

# Ensure output is unbuffered
export PYTHONUNBUFFERED=1

# Check for the binary
if [ -f "./solanity" ]; then
    echo "Binary found: ./solanity"
else
    echo "WARNING: ./solanity binary not found!"
fi

# Check for the worker script
if [ -f "worker.py" ]; then
    echo "Worker script found: worker.py"
else
    echo "ERROR: worker.py not found!"
    exit 1
fi

echo "Exec command: $@"
exec "$@"


======================================================================
FILE: solanity-gpu/PHASE1_NOTES.txt
======================================================================
# Phase 1: High-Throughput SHA-512 Filter Implementation Notes

## Architectural Pivot
This update implements the "Two-Phase" architecture to overcome the register pressure bottleneck (~128 registers/thread) encountered when mixing SHA-512 and Ed25519 ECC in a single kernel.

### Phase 1 (Implemented)
- **Role:** Pure SHA-512 Filter.
- **Goal:** Filter potential candidates based on SHA-512 digest properties before expensive ECC operations.
- **Kernel:** `phase1_filter_kernel`
- **Register Target:** < 64 registers per thread.
- **Throughput Target:** > 300 MH/s (Theoretical peak for pure SHA-512 on L4 is >10 GH/s).
- **Output:** Ring Buffer (`DeviceRingBuffer`) containing seeds (indices) of matches.

### Phase 2 (Implemented on Host)
- **Role:** Full Solver.
- **Goal:** Consume candidates from Ring Buffer, derive Public Key, and check Base58 Suffix.
- **Implementation:** Host-side C++ loop using `sha512` and `ge_scalarmult_base`.
- **Latency:** Decoupled from GPU kernel loop to prevent stalling.

### Removed Components (From Kernel)
The following were removed from Phase 1 to ensure zero spills and maximum occupancy:
1. **Ed25519 (ECC):**
   - Reason: Scalar multiplication (`ge_scalarmult_base`) is register-heavy and caused spilling (296B stores / 268B loads).
   - Impact: Moved to Phase 2 (Host).
2. **Base58 Encoding:**
   - Reason: String manipulation and large lookup tables in kernel consume registers and local memory.
   - Impact: Moved to Phase 2 (Host).
3. **Curand:**
   - Reason: State overhead.
   - Impact: Replaced with deterministic strided index generation (`base_seed + thread_idx`).

### Register Usage Analysis
*Note: `ptxas` could not be run in this environment, but the code is optimized for:*
- **Rolling Schedule:** `W` array logic avoids storing 80 constants or full schedule.
- **In-Place Updates:** `S` state is updated in registers.
- **Minimal Locals:** Only `tid`, `current_idx`, `S[8]`, `W[16]`, and `K` (const) are used.
- **Expected Usage:** ~48-56 registers.
- **Spills:** 0 expected.

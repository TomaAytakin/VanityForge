<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VanityForge</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body { background-color: #1a1a1a; color: #e0e0e0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .glass-panel { background: rgba(40, 40, 40, 0.7); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.1); }
        /* Custom scrollbar for better aesthetics */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1a1a1a; }
        ::-webkit-scrollbar-thumb { background: #4a4a4a; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #6a6a6a; }
        .numpad-btn {
            @apply bg-gray-800 hover:bg-gray-700 text-white font-bold py-4 rounded-lg shadow transition transform active:scale-95 text-xl;
        }
        .pin-dot {
            width: 12px; height: 12px; border-radius: 50%; background-color: #4b5563; transition: all 0.2s;
        }
        .pin-dot.active {
            background-color: #9333ea; box-shadow: 0 0 8px #9333ea;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center py-10 px-4">

    <!-- Banner -->
    <div class="w-full max-w-2xl mb-8 flex justify-center">
        <img src="animated_forge.gif" alt="VanityForge Banner" class="rounded-xl shadow-2xl border border-gray-700 max-w-full h-auto">
    </div>

    <!-- Auth Section -->
    <div id="auth-section" class="w-full max-w-2xl glass-panel p-8 rounded-xl shadow-lg text-center transition-all duration-300">
        <h2 class="text-2xl font-bold mb-6 text-purple-400">Connect to VanityForge</h2>
        <div class="flex flex-col gap-4 max-w-xs mx-auto">
            <button onclick="loginWithGoogle()" class="bg-white hover:bg-gray-100 text-gray-800 font-bold py-3 px-6 rounded-lg transition duration-200 flex items-center justify-center gap-2 shadow-md hover:shadow-lg transform hover:-translate-y-0.5">
                <i class="fa-brands fa-google"></i> Login with Google
            </button>
            <button onclick="connectWallet()" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-6 rounded-lg transition duration-200 flex items-center justify-center gap-2 shadow-md hover:shadow-lg transform hover:-translate-y-0.5">
                <i class="fa-solid fa-wallet"></i> Connect Phantom
            </button>
        </div>

        <div class="mt-8 border-t border-gray-700 pt-4">
            <p class="text-xs text-gray-500 mb-2 cursor-pointer hover:text-gray-400 transition-colors" onclick="document.getElementById('dev-login').classList.toggle('hidden')">Dev Access</p>
            <div id="dev-login" class="hidden flex gap-2 justify-center mt-2">
                <input type="password" id="dev-password" placeholder="Enter Dev Password" class="bg-gray-800 border border-gray-700 rounded px-3 py-1 text-sm focus:outline-none focus:border-purple-500 text-white placeholder-gray-500">
                <button onclick="handleDevLogin()" class="bg-gray-700 hover:bg-gray-600 text-white px-3 py-1 rounded text-sm transition-colors">Enter</button>
            </div>
        </div>
    </div>

    <!-- App Interface (Hidden initially) -->
    <div id="app-interface" class="w-full max-w-2xl hidden space-y-6 animate-fade-in-up">

        <!-- Job Submission -->
        <div class="glass-panel p-8 rounded-xl shadow-lg relative overflow-hidden">
            <div class="absolute top-0 right-0 p-4 opacity-10">
                <i class="fa-solid fa-code text-6xl text-purple-500"></i>
            </div>
            <h2 class="text-xl font-bold mb-4 text-purple-400 flex items-center gap-2">
                <i class="fa-solid fa-plus-circle"></i> Request New Vanity Address
            </h2>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                <div>
                    <label class="block text-sm text-gray-400 mb-1">Prefix (Starts with)</label>
                    <input type="text" id="prefix" class="w-full bg-gray-800 border border-gray-700 rounded p-2 focus:border-purple-500 focus:outline-none text-white font-mono placeholder-gray-600" placeholder="e.g. CAFE">
                </div>
                <div>
                    <label class="block text-sm text-gray-400 mb-1">Suffix (Ends with)</label>
                    <input type="text" id="suffix" class="w-full bg-gray-800 border border-gray-700 rounded p-2 focus:border-purple-500 focus:outline-none text-white font-mono placeholder-gray-600" placeholder="e.g. 888">
                </div>
            </div>

            <p class="text-xs text-gray-500 mb-4">Note: Characters 0, O, I, and l are not allowed by Solana for security reasons.</p>

            <div class="flex items-center gap-2 mb-4">
                <div class="relative inline-block w-10 mr-2 align-middle select-none transition duration-200 ease-in">
                    <input type="checkbox" name="toggle" id="case-sensitive" class="toggle-checkbox absolute block w-5 h-5 rounded-full bg-white border-4 appearance-none cursor-pointer"/>
                    <label for="case-sensitive" class="toggle-label block overflow-hidden h-5 rounded-full bg-gray-700 cursor-pointer"></label>
                </div>
                <label for="case-sensitive" class="text-sm text-gray-300 cursor-pointer select-none">Case Sensitive</label>
                <style>
                    .toggle-checkbox:checked { right: 0; border-color: #9333ea; }
                    .toggle-checkbox:checked + .toggle-label { background-color: #9333ea; }
                    .toggle-checkbox { right: 0; border-color: #4b5563; transition: all 0.3s; top: 0; left: 0;}
                    .toggle-checkbox:checked { left: 50%; }
                    .toggle-label { width: 100%; }
                    .toggle-checkbox { position: absolute; top:0; left: 0; right: auto; bottom: auto; }
                    .toggle-checkbox:checked { left: 1.25rem; border-color: #a855f7; }
                </style>
            </div>

            <div class="bg-gray-800/50 rounded-lg p-4 mb-6 text-sm border border-gray-700">
                <div class="flex justify-between items-center mb-2">
                    <span class="text-gray-400">Difficulty:</span>
                    <span id="calc-difficulty" class="text-white font-bold">0 chars</span>
                </div>
                <div class="flex justify-between items-center mb-2">
                    <span class="text-gray-400">Est. Time:</span>
                    <span id="calc-time" class="text-white font-mono">Instant</span>
                </div>
                <div class="flex justify-between items-center pt-2 border-t border-gray-700">
                    <span class="text-gray-400">Cost:</span>
                    <span id="calc-cost" class="text-green-400 font-bold font-mono">0 Credits</span>
                </div>
            </div>

            <button onclick="startSubmissionFlow()" class="w-full bg-gradient-to-r from-purple-600 to-indigo-600 hover:from-purple-700 hover:to-indigo-700 text-white font-bold py-3 rounded-lg shadow-lg transition transform hover:scale-[1.01] active:scale-[0.99] flex justify-center items-center gap-2">
                <i class="fa-solid fa-rocket"></i> Forge
            </button>
            <p id="submit-error" class="text-red-400 text-sm mt-3 text-center hidden bg-red-900/20 py-2 rounded border border-red-900/50"></p>
        </div>

        <!-- Jobs List -->
        <div class="glass-panel p-8 rounded-xl shadow-lg">
            <h3 class="text-lg font-bold mb-4 text-gray-300 border-b border-gray-700 pb-2 flex items-center justify-between">
                <span><i class="fa-solid fa-list-ul mr-2 text-purple-500"></i>Your Jobs</span>
                <span class="text-xs font-normal text-gray-500" id="user-id-display"></span>
            </h3>
            <div id="jobs-container" class="space-y-4 max-h-[500px] overflow-y-auto pr-2">
                <p class="text-center text-gray-500 italic py-8">No active jobs found.</p>
            </div>
        </div>
    </div>

    <!-- Numpad Modal -->
    <div id="numpad-modal" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-80 backdrop-blur-sm hidden transition-opacity duration-300">
        <div class="bg-gray-900 border border-gray-700 rounded-2xl shadow-2xl p-6 w-full max-w-sm transform scale-95 transition-transform duration-300" id="numpad-content">
            <h3 id="numpad-title" class="text-center text-xl font-bold text-white mb-6">Enter Vault PIN</h3>

            <div class="flex justify-center gap-4 mb-8" id="pin-display">
                <!-- Dots will be injected here -->
            </div>

            <div class="grid grid-cols-3 gap-4">
                <button class="numpad-btn bg-gray-800 hover:bg-gray-700 text-white font-bold py-4 rounded-lg shadow transition transform active:scale-95 text-xl" onclick="numpadInput(1)">1</button>
                <button class="numpad-btn bg-gray-800 hover:bg-gray-700 text-white font-bold py-4 rounded-lg shadow transition transform active:scale-95 text-xl" onclick="numpadInput(2)">2</button>
                <button class="numpad-btn bg-gray-800 hover:bg-gray-700 text-white font-bold py-4 rounded-lg shadow transition transform active:scale-95 text-xl" onclick="numpadInput(3)">3</button>
                <button class="numpad-btn bg-gray-800 hover:bg-gray-700 text-white font-bold py-4 rounded-lg shadow transition transform active:scale-95 text-xl" onclick="numpadInput(4)">4</button>
                <button class="numpad-btn bg-gray-800 hover:bg-gray-700 text-white font-bold py-4 rounded-lg shadow transition transform active:scale-95 text-xl" onclick="numpadInput(5)">5</button>
                <button class="numpad-btn bg-gray-800 hover:bg-gray-700 text-white font-bold py-4 rounded-lg shadow transition transform active:scale-95 text-xl" onclick="numpadInput(6)">6</button>
                <button class="numpad-btn bg-gray-800 hover:bg-gray-700 text-white font-bold py-4 rounded-lg shadow transition transform active:scale-95 text-xl" onclick="numpadInput(7)">7</button>
                <button class="numpad-btn bg-gray-800 hover:bg-gray-700 text-white font-bold py-4 rounded-lg shadow transition transform active:scale-95 text-xl" onclick="numpadInput(8)">8</button>
                <button class="numpad-btn bg-gray-800 hover:bg-gray-700 text-white font-bold py-4 rounded-lg shadow transition transform active:scale-95 text-xl" onclick="numpadInput(9)">9</button>
                <button class="numpad-btn bg-gray-800 hover:bg-gray-700 text-red-400 font-bold py-4 rounded-lg shadow transition transform active:scale-95 text-xl" onclick="numpadClear()"><i class="fa-solid fa-delete-left"></i></button>
                <button class="numpad-btn bg-gray-800 hover:bg-gray-700 text-white font-bold py-4 rounded-lg shadow transition transform active:scale-95 text-xl" onclick="numpadInput(0)">0</button>
                <button class="numpad-btn bg-purple-600 hover:bg-purple-700 text-white font-bold py-4 rounded-lg shadow transition transform active:scale-95 text-xl" onclick="numpadSubmit()"><i class="fa-solid fa-check"></i></button>
            </div>
            <button onclick="closeNumpad()" class="mt-6 w-full text-gray-500 hover:text-white text-sm">Cancel</button>
        </div>
    </div>

    <script>
        // CONFIGURATION (HARDCODED)
        const API_URL = ""; // Relative path
        const FIREBASE_CONFIG = {
            apiKey: "AIzaSyCSYhscdfpQD19GMsm3qIJw9AWC5OYjqMY",
            authDomain: "vanityforge.firebaseapp.com",
            projectId: "vanityforge",
            storageBucket: "vanityforge.firebasestorage.app",
            messagingSenderId: "124272129554",
            appId: "1:124272129554:web:5e4f9e1d89bd54b3accacb",
            measurementId: "G-97FJY9VP2K"
        };

        // INIT FIREBASE
        if (!firebase.apps.length) {
            firebase.initializeApp(FIREBASE_CONFIG);
        }
        const db = firebase.firestore();

        // STATE
        let currentUser = null;
        let jobListenerUnsubscribe = null;

        // AUDIO SYSTEM
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

        function playSound(type) {
            if (audioCtx.state === 'suspended') audioCtx.resume();

            const oscillator = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();

            oscillator.connect(gainNode);
            gainNode.connect(audioCtx.destination);

            if (type === 'input') {
                // High pitch blip
                oscillator.type = 'sine'; // or triangle
                oscillator.frequency.setValueAtTime(880, audioCtx.currentTime); // A5
                oscillator.frequency.exponentialRampToValueAtTime(100, audioCtx.currentTime + 0.1);

                gainNode.gain.setValueAtTime(0.1, audioCtx.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.1);

                oscillator.start();
                oscillator.stop(audioCtx.currentTime + 0.1);
            } else if (type === 'delete') {
                // Low pitch whoosh/buzz
                oscillator.type = 'sawtooth';
                oscillator.frequency.setValueAtTime(150, audioCtx.currentTime);
                oscillator.frequency.linearRampToValueAtTime(50, audioCtx.currentTime + 0.2);

                gainNode.gain.setValueAtTime(0.1, audioCtx.currentTime);
                gainNode.gain.linearRampToValueAtTime(0.01, audioCtx.currentTime + 0.2);

                oscillator.start();
                oscillator.stop(audioCtx.currentTime + 0.2);
            }
        }

        // NUMPAD LOGIC
        let currentPin = "";
        let numpadMode = ""; // 'create', 'submit', 'reveal'
        let numpadCallback = null;
        let revealJobId = null;

        function openNumpad(mode, title, callback, jobId = null) {
            currentPin = "";
            numpadMode = mode;
            numpadCallback = callback;
            revealJobId = jobId;

            document.getElementById('numpad-title').innerText = title;
            updatePinDisplay();

            const modal = document.getElementById('numpad-modal');
            modal.classList.remove('hidden');
            setTimeout(() => {
                document.getElementById('numpad-content').classList.replace('scale-95', 'scale-100');
            }, 10);
        }

        function closeNumpad() {
            const modal = document.getElementById('numpad-modal');
            document.getElementById('numpad-content').classList.replace('scale-100', 'scale-95');
            setTimeout(() => {
                modal.classList.add('hidden');
            }, 300);
            currentPin = "";
        }

        function numpadInput(num) {
            if (currentPin.length < 6) {
                currentPin += num;
                playSound('input');
                updatePinDisplay();
            }
        }

        function numpadClear() {
            if (currentPin.length > 0) {
                currentPin = currentPin.slice(0, -1);
                playSound('delete');
                updatePinDisplay();
            }
        }

        function updatePinDisplay() {
            const container = document.getElementById('pin-display');
            container.innerHTML = '';
            // Always show 6 slots
            for (let i = 0; i < 6; i++) {
                const dot = document.createElement('div');
                dot.className = `pin-dot ${i < currentPin.length ? 'active' : ''}`;
                container.appendChild(dot);
            }
        }

        async function numpadSubmit() {
            if (currentPin.length < 4) {
                alert("PIN must be at least 4 digits.");
                return;
            }
            playSound('input'); // Confirm sound?

            if (numpadMode === 'create') {
                await setPin(currentPin);
            } else if (numpadMode === 'submit') {
                numpadCallback(currentPin);
            } else if (numpadMode === 'reveal') {
                numpadCallback(revealJobId, currentPin);
            }

            closeNumpad();
        }

        // AUTHENTICATION
        async function loginWithGoogle() {
            const provider = new firebase.auth.GoogleAuthProvider();
            try {
                const result = await firebase.auth().signInWithPopup(provider);
                const user = result.user;
                currentUser = user.uid;
                await checkUserStatus(currentUser);
            } catch (error) {
                console.error(error);
                alert("Google Login Failed: " + error.message);
            }
        }

        async function connectWallet() {
            if (window.solana && window.solana.isPhantom) {
                try {
                    const resp = await window.solana.connect();
                    currentUser = resp.publicKey.toString();
                    await checkUserStatus(currentUser);
                } catch (err) {
                    console.error(err);
                    alert("Connection failed.");
                }
            } else {
                window.open("https://phantom.app/", "_blank");
            }
        }

        function handleDevLogin() {
            const pw = document.getElementById('dev-password').value;
            if (pw === "123580-Toma") {
                currentUser = "DEV_USER";
                checkUserStatus(currentUser);
            } else {
                alert("Access Denied");
                document.getElementById('dev-password').value = '';
            }
        }

        async function checkUserStatus(userId) {
            try {
                const res = await fetch('/check-user', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ user_id: userId })
                });
                const data = await res.json();

                if (data.has_pin) {
                    onLoginSuccess();
                } else {
                    // Prompt to create PIN
                    document.getElementById('auth-section').classList.add('hidden'); // Hide auth temporarily
                    openNumpad('create', 'Create your Vault PIN', null);
                }
            } catch (e) {
                console.error(e);
                alert("Error checking user status.");
            }
        }

        async function setPin(pin) {
            try {
                const res = await fetch('/set-pin', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ user_id: currentUser, pin: pin })
                });
                if (res.ok) {
                    onLoginSuccess();
                } else {
                    alert("Failed to set PIN.");
                    location.reload();
                }
            } catch (e) {
                console.error(e);
                alert("Error setting PIN.");
            }
        }

        function onLoginSuccess(isDev = false) {
            document.getElementById('auth-section').classList.add('hidden');
            const appInterface = document.getElementById('app-interface');
            appInterface.classList.remove('hidden');

            // Simple fade in effect
            appInterface.style.opacity = 0;
            setTimeout(() => {
                appInterface.style.transition = 'opacity 0.5s ease-in-out';
                appInterface.style.opacity = 1;
            }, 50);

            let displayId = currentUser;
            if (currentUser === "DEV_USER") displayId = "Dev Mode";
            else if (currentUser.length > 10) displayId = currentUser.slice(0, 4) + '...' + currentUser.slice(-4);

            document.getElementById('user-id-display').innerText = displayId;

            pollJobStatus();
        }

        // CALCULATIONS (Helpers)
        function updateEstimates() {
            const p = document.getElementById('prefix').value || "";
            const s = document.getElementById('suffix').value || "";
            const totalLen = p.length + s.length;

            if (totalLen === 0) {
                document.getElementById('calc-difficulty').innerText = "0 chars";
                document.getElementById('calc-time').innerText = "Instant";
                document.getElementById('calc-cost').innerText = "0 Credits";
                return;
            }

            // Cost = 10^(TotalLength - 1)
            let cost = Math.pow(10, Math.max(0, totalLen - 1));

            // Time (seconds) = (0.5 * 58^TotalLength) / 5,000,000
            let seconds = (0.5 * Math.pow(58, totalLen)) / 5000000;

            let timeStr;
            if (seconds < 1) timeStr = "Instant";
            else if (seconds < 60) timeStr = Math.ceil(seconds) + "s";
            else if (seconds < 3600) timeStr = Math.ceil(seconds/60) + "m";
            else if (seconds < 86400) timeStr = (seconds/3600).toFixed(1) + "h";
            else timeStr = (seconds/86400).toFixed(1) + "d";

            document.getElementById('calc-difficulty').innerText = totalLen + " chars";
            document.getElementById('calc-time').innerText = timeStr;
            document.getElementById('calc-cost').innerText = cost.toLocaleString() + " Credits";
        }

        ['prefix', 'suffix'].forEach(id => {
            document.getElementById(id).addEventListener('input', (e) => {
                const val = e.target.value;
                const clean = val.replace(/[^1-9A-HJ-NP-Za-km-z]/g, '');
                if (val !== clean) e.target.value = clean;
                updateEstimates();
            });
        });

        // JOB SUBMISSION
        function startSubmissionFlow() {
             const prefix = document.getElementById('prefix').value;
             const suffix = document.getElementById('suffix').value;
             const totalLen = prefix.length + suffix.length;

             if (!prefix && !suffix) {
                const errorEl = document.getElementById('submit-error');
                errorEl.innerText = "Please specify a prefix or suffix.";
                errorEl.classList.remove('hidden');
                return;
             }
             document.getElementById('submit-error').classList.add('hidden');

             // Check estimated time
             // Time (seconds) = (0.5 * 58^TotalLength) / 5,000,000
             let seconds = (0.5 * Math.pow(58, totalLen)) / 5000000;
             if (seconds > 3600) {
                 let timeStr;
                 if (seconds < 86400) timeStr = (seconds/3600).toFixed(1) + " hours";
                 else timeStr = (seconds/86400).toFixed(1) + " days";

                 if (!confirm(`This job may take ${timeStr}. Do you accept the wait and proceed?`)) {
                     return;
                 }
             }

             openNumpad('submit', 'Enter PIN to Forge', submitJob);
        }

        async function submitJob(pin) {
            const prefix = document.getElementById('prefix').value;
            const suffix = document.getElementById('suffix').value;
            const caseSensitive = document.getElementById('case-sensitive').checked;
            const errorEl = document.getElementById('submit-error');
            const submitBtn = document.querySelector('button[onclick="startSubmissionFlow()"]');

            // Disable button
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Submitting...';

            const payload = {
                user_id: currentUser,
                prefix: prefix,
                suffix: suffix,
                case_sensitive: caseSensitive,
                pin: pin
            };

            try {
                const res = await fetch('/submit-job', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (res.ok) {
                    // Success feedback
                    document.getElementById('prefix').value = '';
                    document.getElementById('suffix').value = '';
                    updateEstimates();
                } else {
                    const data = await res.json().catch(() => ({}));
                    throw new Error(data.message || data.error || "Submission failed.");
                }
            } catch (e) {
                errorEl.innerText = e.message;
                errorEl.classList.remove('hidden');
            } finally {
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i class="fa-solid fa-rocket"></i> Forge';
            }
        }

        // POLLING & UI
        function pollJobStatus() {
            if (jobListenerUnsubscribe) jobListenerUnsubscribe();

            const container = document.getElementById('jobs-container');

            jobListenerUnsubscribe = db.collection('vanity_jobs')
                .where('user_id', '==', currentUser)
                .orderBy('created_at', 'desc')
                .onSnapshot((snapshot) => {
                    if (snapshot.empty) {
                        container.innerHTML = '<p class="text-center text-gray-500 italic py-8">No active jobs found.</p>';
                        return;
                    }

                    const fragment = document.createDocumentFragment();

                    snapshot.forEach(doc => {
                        const job = doc.data();
                        const status = (job.status || "").toUpperCase();

                        // Check if key is available
                        const secretKey = job.secret_key; // Encrypted

                        let statusColor = 'text-gray-400';
                        let statusIcon = '';
                        let resultHtml = '';

                        if (status === 'COMPLETED') {
                            statusColor = 'text-green-400';
                            statusIcon = '<i class="fa-solid fa-check-circle"></i>';

                            // Show Eye Icon and Copy Button
                            resultHtml = `
                                <div class="mt-3 bg-gray-900/50 p-3 rounded border border-gray-700/50">
                                    <div class="flex justify-between items-center mb-1">
                                        <span class="text-xs text-gray-500 uppercase font-bold tracking-wider">Public Key</span>
                                        <button onclick="copyToClipboard('${job.public_key}')" class="text-xs text-purple-400 hover:text-purple-300 transition-colors" title="Copy Public Key"><i class="fa-regular fa-copy"></i></button>
                                    </div>
                                    <div class="font-mono text-xs break-all text-gray-300 mb-3 bg-black/20 p-2 rounded">${job.public_key}</div>

                                    <div class="flex justify-between items-center mb-1">
                                        <span class="text-xs text-gray-500 uppercase font-bold tracking-wider">Private Key</span>
                                        <button onclick="openNumpad('reveal', 'Enter PIN to Unlock', revealKey, '${doc.id}')" id="btn-${doc.id}" class="text-xs text-purple-400 hover:text-purple-300 transition-colors uppercase font-bold" title="Reveal Private Key"><i class="fa-regular fa-eye"></i></button>
                                    </div>
                                    <div id="secret-${doc.id}" class="hidden flex items-start gap-2 animate-fade-in">
                                        <div id="key-text-${doc.id}" class="font-mono text-xs break-all text-red-300 bg-red-900/10 p-2 rounded border border-red-900/20 flex-grow">
                                            <!-- Decrypted key will go here -->
                                        </div>
                                        <button onclick="copyKey('${doc.id}')" class="text-gray-400 hover:text-white pt-1 transition-colors" title="Copy Private Key"><i class="fa-regular fa-copy"></i></button>
                                    </div>
                                </div>
                             `;
                        } else if (status === 'FAILED') {
                            statusColor = 'text-red-400';
                            statusIcon = '<i class="fa-solid fa-times-circle"></i>';
                            resultHtml = `
                                <div class="mt-2 text-xs text-red-400 italic">
                                    ${job.error || "Job failed to process."}
                                </div>
                            `;
                        } else {
                            statusColor = 'text-yellow-400';
                            statusIcon = '<i class="fa-regular fa-clock animate-spin"></i>';
                        }

                        const el = document.createElement('div');
                        el.className = "bg-gray-800 p-4 rounded-lg border border-gray-700 shadow-sm hover:border-gray-600 transition-colors";
                        el.innerHTML = `
                            <div class="flex justify-between items-start mb-2">
                                <div class="flex items-center gap-2">
                                    <span class="text-xs font-bold bg-gray-700 text-gray-300 px-2 py-1 rounded border border-gray-600 font-mono">
                                        ${job.prefix || '...'}-${job.suffix || '...'}
                                    </span>
                                    ${job.case_sensitive ? '<span class="text-xs text-purple-400 border border-purple-500/30 bg-purple-500/10 px-1.5 py-0.5 rounded" title="Case Sensitive">Aa</span>' : ''}
                                </div>
                                <span class="text-sm font-bold ${statusColor} capitalize flex items-center gap-1">
                                    ${statusIcon} ${job.status}
                                </span>
                            </div>
                            <div class="text-[10px] text-gray-600 mb-1 font-mono uppercase tracking-widest">ID: ${doc.id}</div>
                            ${resultHtml}
                        `;
                        fragment.appendChild(el);
                    });

                    container.innerHTML = '';
                    container.appendChild(fragment);

                }, (error) => {
                    console.error("Error polling jobs:", error);
                    container.innerHTML = '<p class="text-center text-red-500 py-4 bg-red-900/10 rounded border border-red-900/20">Error connection to job server.</p>';
                });
        }

        async function revealKey(jobId, pin) {
            try {
                const res = await fetch('/reveal-key', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ job_id: jobId, pin: pin })
                });

                const data = await res.json();

                if (res.ok) {
                    const el = document.getElementById(`secret-${jobId}`);
                    const btn = document.getElementById(`btn-${jobId}`);
                    const keyText = document.getElementById(`key-text-${jobId}`);

                    keyText.innerText = data.secret_key;
                    el.classList.remove('hidden');
                    btn.innerHTML = '<i class="fa-regular fa-eye-slash"></i>';
                    btn.onclick = () => {
                         el.classList.add('hidden');
                         btn.innerHTML = '<i class="fa-regular fa-eye"></i>';
                         keyText.innerText = '';
                         // Reset onclick
                         btn.onclick = () => openNumpad('reveal', 'Enter PIN to Unlock', revealKey, jobId);
                    };
                } else {
                    alert(data.error || "Failed to reveal key.");
                }
            } catch (e) {
                console.error(e);
                alert("Error revealing key.");
            }
        }

        function copyKey(id) {
            const text = document.getElementById(`key-text-${id}`).innerText;
            copyToClipboard(text);
        }

        function copyToClipboard(text) {
            if (!text) return;
            navigator.clipboard.writeText(text).then(() => {
                const originalText = document.activeElement.innerHTML;
                if(document.activeElement.tagName === 'BUTTON') {
                   const icon = document.activeElement.querySelector('i');
                   if(icon) {
                       icon.className = "fa-solid fa-check text-green-400";
                       setTimeout(() => { icon.className = "fa-regular fa-copy"; }, 2000);
                   }
                }
            }).catch(err => {
                console.error('Failed to copy: ', err);
                prompt("Copy to clipboard: Ctrl+C, Enter", text);
            });
        }

        // Global assignments
        window.loginWithGoogle = loginWithGoogle;
        window.connectWallet = connectWallet;
        window.handleDevLogin = handleDevLogin;
        window.startSubmissionFlow = startSubmissionFlow;
        window.submitJob = submitJob;
        window.revealKey = revealKey;
        window.copyToClipboard = copyToClipboard;
        window.copyKey = copyKey;
        window.numpadInput = numpadInput;
        window.numpadClear = numpadClear;
        window.numpadSubmit = numpadSubmit;
        window.closeNumpad = closeNumpad;
    </script>
</body>
</html>